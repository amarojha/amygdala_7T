---
title: "amygdala_nuclei"
author: "Amar Ojha"
date: "2025-04-29"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(pacman)
p_load(tidyverse, ggthemes, ggpubr, devtools, remotes, mgcv, broom, glue, gamm4, parameters, hrbrthemes, rstatix, neuroCombat, cAIC4, interactions, sjPlot, PNWColors, LNCDR, gghalves, ggforce, ggdist, readxl, Hmisc, lmerTest, RColorBrewer, data.table, label4MRI, corrplot, broomExtra, mgcViz, vroom, NatParksPalettes, ggsci, reghelper, ggrain, ggExtra, see)

setwd("/Users/amarojha/Desktop/science/r/data/amygdala_nuclei/")

fc <- vroom("roi_fc_frontoamyg_nosmooth_long.csv") %>% 
  rename(fc = rsfc)
demo <- vroom("demo_7T.csv")
intext <- vroom("asrysr_2024.csv") %>% 
  dplyr::select(id, visit, internalizing_probs_T, externalizing_probs_T)
percTRcensoredFD <- vroom("percTRcensoredFD.csv") # may not need? 
fd <- vroom("fd_7T.csv") 

mgs <- vroom("merged_7T.csv") %>% 
  dplyr::select(lunaid, visitno, eeg.BestError_DelayAll, eeg.BestError_sd_DelayAll, eeg.mgsLatency_DelayAll, eeg.mgsLatency_sd_DelayAll) %>% 
  rename(id = lunaid,
         visit = visitno,
         mgs_acc = eeg.BestError_DelayAll,
         mgs_acc_var = eeg.BestError_sd_DelayAll,
         mgs_lat = eeg.mgsLatency_DelayAll, 
         mgs_lat_var = eeg.mgsLatency_sd_DelayAll)

ders <- vroom("DERS_recoded.csv") %>% 
  dplyr::select(id, VisitYear, ders_total) %>% 
  rename(visit = VisitYear)

roi_tsnr <- vroom("combined_tsnr_new_labels.csv") %>% 
  mutate(AAA_tsnr = AAA_R + AAA_L,
         ABN_tsnr = ABN_R + ABN_L,
         BN_tsnr = BN_R + BN_L,
         CAT_tsnr = CAT_R + CAT_L,
         CEN_tsnr = CEN_R + CEN_L,
         CON_tsnr = CON_R + CON_L,
         LN_tsnr = LN_R + LN_L,
         MN_tsnr = MN_R + MN_L,
         PL_tsnr = PL_R + PL_L,
         antvmpfc_tsnr = antvmpfc_R + antvmpfc_L,
         sgacc_tsnr = sgacc_R + sgacc_L,
         racc_tsnr = racc_R + racc_L,
         vacc_tsnr = vacc_R + vacc_L,
         dlpfc_tsnr = dlpfc_R + dlpfc_L,
         vlpfc_tsnr = vlpfc_R + vlpfc_L)

roi_size <- vroom("roi_sizes_pfc_amyg.csv") %>% 
  mutate(scan_id = id,
         AAA_voxels = AAA_R + AAA_L,
         ABN_voxels = ABN_R + ABN_L,
         BN_voxels = BN_R + BN_L,
         CAT_voxels = CAT_R + CAT_L,
         CEN_voxels = CEN_R + CEN_L,
         CON_voxels = CON_R + CON_L,
         LN_voxels = LN_R + LN_L,
         MN_voxels = MN_R + MN_L,
         PL_voxels = PL_R + PL_L,
         antvmpfc_voxels = antvmpfc_R + antvmpfc_L,
         sgacc_voxels = sgacc_R + sgacc_L,
         racc_voxels = racc_R + racc_L,
         vacc_voxels = vacc_R + vacc_L,
         dlpfc_voxels = dlpfc_R + dlpfc_L,
         vlpfc_voxels = vlpfc_R + vlpfc_L)

amygdala_nuclei_7T <- full_join(fc, demo) %>% 
  full_join(intext, ., by = c("id", "visit")) %>% 
  full_join(mgs, ., by = c("id", "visit")) %>% 
  full_join(ders, ., by = c("id", "visit")) %>% 
  full_join(fd, ., by = "scan_id") %>% 
  distinct()

```

# general counts
```{r}
# total participants 
amygdala_nuclei_7T %>% 
  dplyr::select(id, scan_id, scan_age, visit) %>% 
  drop_na(id, scan_id, scan_age, visit) %>% 
  dplyr::select(-scan_id, -scan_age, -visit) %>% 
  unique() %>% 
  count() # 143

# participants by sex
amygdala_nuclei_7T %>% 
  dplyr::select(id, scan_id, scan_age, visit, sex) %>% 
  drop_na(id, scan_id, scan_age, visit, sex) %>% 
  dplyr::select(id, sex) %>% 
  unique() %>% 
  dplyr::select(sex) %>% 
  table() # 75 F, 68 M

# visit numbers
amygdala_nuclei_7T %>% 
  dplyr::select(id, scan_id, scan_age, visit) %>% 
  drop_na(id, scan_id, scan_age, visit) %>% 
  unique() %>% 
  dplyr::select(visit) %>% 
  table() # 1 visit: 133, 2 visits: 52, 3 visits: 13 

# total number of scans  
amygdala_nuclei_7T %>% 
  dplyr::select(id, scan_id, scan_age, visit) %>% 
  drop_na(id, scan_id, scan_age, visit) %>% 
  unique() %>% 
  count() # 198

```

# fronto-amygdala intrinsic functional connectivity age effects 
```{r}
# Data preparation
temp.df <- amygdala_nuclei_7T %>%
  dplyr::select(id, visit, roiA, roiB, roiA_side, roiB_side, laterality, context, scan_age, fc) %>% 
  filter(
    (roiA == "antvmpfc" & roiB %in% c("ABN", "BN", "CAT", "CEN", "LN")) |
    (roiB == "antvmpfc" & roiA %in% c("ABN", "BN", "CAT", "CEN", "LN"))
  ) %>%
  distinct() %>%
  mutate(
    laterality = as.factor(laterality),
    roiA_side = as.factor(roiA_side),
    roiB_side = as.factor(roiB_side),
    id = as.factor(id),
    context = as.factor(context),
    visit = as.factor(visit),
    roiA = as.factor(roiA),
    roiB = as.factor(roiB)
  )

# Remove incomplete cases
temp.df <- temp.df %>%
    filter(complete.cases(dplyr::select(., fc, scan_age, laterality, roiA_side)))

# Initial BAM model
initial_bam <- bam(
    fc ~ s(scan_age, k = 3, fx = T, by = roiB) + roiB + laterality + roiA_side + context,
    random = list(id = ~1 + visit),
    data = temp.df,
    REML = TRUE,
    discrete = TRUE
)

# Add residuals to dataframe
temp.df <- temp.df %>%
    mutate(bam.resid = residuals(initial_bam))

# Final BAM model after removing outliers
filtered_df <- temp.df %>%
    mutate(bam.z = abs(scale(bam.resid)[, 1])) %>%
    filter(bam.z < 2)

final_bam <- bam(
    fc ~ s(scan_age, k = 3, fx = T, by = roiB) + roiB + laterality + roiA_side + context,
    random = list(id = ~1 + visit),
    data = filtered_df,
    REML = TRUE,
    discrete = TRUE
)

# Summary
model_parameters(final_bam, standardize = "refit")

```

# brain-behavior associations 
```{r}
# general age-related effects on behavioral measures

int_age <- amygdala_nuclei_7T %>% 
  dplyr::select(id, visit, scan_age, internalizing_probs_T) %>% 
  distinct() %>% 
  ggplot(aes(scan_age, internalizing_probs_T)) +
  geom_smooth(method = "gam", formula = y ~ s(x, k = 4), size = 1, se = T) +
  geom_point(size = .7) +
  xlab("Age (Years)") +
  ylab("Internalizing Behaviors (T-score)") +
  theme_modern() +
  theme(
    axis.title.y = element_text(margin = margin(r = 5)),
    axis.title.x = element_text(margin = margin(t = 5))
  )

ext_age <- amygdala_nuclei_7T %>% 
  dplyr::select(id, visit, scan_age, externalizing_probs_T) %>% 
  distinct() %>% 
  ggplot(aes(scan_age, externalizing_probs_T)) +
  geom_smooth(method = "gam", formula = y ~ s(x, k = 4), size = 1, se = T) +
  geom_point(size = .7) +
  xlab("Age (Years)") +
  ylab("Externalizing Behaviors (T-score)") +
  theme_modern() +
  theme(
    axis.title.y = element_text(margin = margin(r = 5)),
    axis.title.x = element_text(margin = margin(t = 5))
  )

ders_age <- amygdala_nuclei_7T %>% 
  dplyr::select(id, visit, scan_age, ders_total) %>% 
  distinct() %>% 
  ggplot(aes(scan_age, ders_total)) +
  geom_smooth(method = "gam", formula = y ~ s(x, k = 4), size = 1, se = T) +
  geom_point(size = .7) +
  xlab("Age (Years)") +
  ylab("Difficulties in Emotion Regulation") +
  theme_modern() +
  theme(
    axis.title.y = element_text(margin = margin(r = 5)),
    axis.title.x = element_text(margin = margin(t = 5))
  )

mgs_acc_age <- amygdala_nuclei_7T %>% 
  dplyr::select(id, visit, scan_age, mgs_acc) %>% 
  distinct() %>% 
  ggplot(aes(scan_age, mgs_acc)) +
  geom_smooth(method = "gam", formula = y ~ s(x, k = 4), size = 1, se = T) +
  geom_point(size = .7) +
  xlab("Age (Years)") +
  ylab("Memory-Guided Saccade\nAccuracy (Degrees from Target)") +
  theme_modern() +
  theme(
    axis.title.y = element_text(margin = margin(r = 5)),
    axis.title.x = element_text(margin = margin(t = 5))
  )

mgs_acc_var_age <- amygdala_nuclei_7T %>% 
  dplyr::select(id, visit, scan_age, mgs_acc_var) %>% 
  distinct() %>% 
  ggplot(aes(scan_age, mgs_acc_var)) +
  geom_smooth(method = "gam", formula = y ~ s(x, k = 4), size = 1, se = T) +
  geom_point(size = .7) +
  xlab("Age (Years)") +
  ylab("Memory-Guided Saccade\nAccuracy Variability (SD)") +
  theme_modern() +
  theme(
    axis.title.y = element_text(margin = margin(r = 5)),
    axis.title.x = element_text(margin = margin(t = 5))
  )

mgs_lat_age <- amygdala_nuclei_7T %>% 
  dplyr::select(id, visit, scan_age, mgs_lat) %>% 
  distinct() %>% 
  ggplot(aes(scan_age, mgs_lat)) +
  geom_smooth(method = "gam", formula = y ~ s(x, k = 4), size = 1, se = T) +
  geom_point(size = .7) +
  xlab("Age (Years)") +
  ylab("Memory-Guided Saccade\nCorrect Trial Latency (ms)") +
  theme_modern() +
  theme(
    axis.title.y = element_text(margin = margin(r = 5)),
    axis.title.x = element_text(margin = margin(t = 5))
  )

mgs_lat_var_age <- amygdala_nuclei_7T %>% 
  dplyr::select(id, visit, scan_age, mgs_lat_var) %>% 
  distinct() %>% 
  ggplot(aes(scan_age, mgs_lat_var)) +
  geom_smooth(method = "gam", formula = y ~ s(x, k = 4), size = 1, se = T) +
  geom_point(size = .7) +
  xlab("Age (Years)") +
  ylab("Memory-Guided Saccade\nCorrect Trial Latency Variability (SD)") +
  theme_modern() +
  theme(
    axis.title.y = element_text(margin = margin(r = 5)),
    axis.title.x = element_text(margin = margin(t = 5))
  )

# Arrange affective measures (top row)
affective_row <- ggarrange(
  int_age, ext_age, ders_age,
  ncol = 3, nrow = 1,
  labels = c("A", "B", "C"),
  align = "hv"
)

# Arrange cognitive measures (bottom row)
cognitive_row <- ggarrange(
  mgs_acc_age, mgs_acc_var_age, mgs_lat_age, mgs_lat_var_age,
  ncol = 4, nrow = 1,
  labels = c("D", "E", "F", "G"),
  align = "hv"
)

# Combine both rows
combined_plot <- ggarrange(
  affective_row,
  cognitive_row,
  ncol = 1,
  heights = c(1, 1.2)  # give slightly more space to the 4-wide bottom row
)

# Print or save the plot
combined_plot


## actual brain-behavior tests
# Data preparation
temp.df <- amygdala_nuclei_7T %>%
    filter(roiA %in% c("antvmpfc", "CEN"), roiB %in% c("antvmpfc", "CEN"), roiA != roiB) %>%
    distinct() %>%
    mutate(
        laterality = as.factor(laterality),
        roiA_side = as.factor(roiA_side),
        roiB_side = as.factor(roiB_side),
        id = as.factor(id),
        context = as.factor(context),
        visit = as.factor(visit),
        roiB = as.factor(roiB)
    )

# Remove missing data
temp.df <- temp.df %>%
    filter(complete.cases(dplyr::select(., fc, scan_age, laterality, roiA_side, internalizing_probs_T, externalizing_probs_T)))

# Initial BAM model
initial_bam <- bam(
  fc ~ s(scan_age, k = 3, fx = T) + internalizing_probs_T + laterality + roiA_side + context,
  random = list(id = ~1 + visit),
  data = temp.df,
  REML = TRUE,
  discrete = TRUE
)

# Add residuals to dataframe
temp.df <- temp.df %>%
    mutate(bam.resid = residuals(initial_bam))

# Final BAM model after removing outliers
filtered_df <- temp.df %>%
    mutate(bam.z = abs(scale(bam.resid)[, 1])) %>%
    filter(bam.z < 2)

final_bam <- bam(
  fc ~ s(scan_age, k = 3, fx = T) + internalizing_probs_T + laterality + roiA_side + context,
  random = list(id = ~1 + visit),
  data = filtered_df,
  REML = TRUE,
  discrete = TRUE
)

# Summary
model_parameters(final_bam, standardize = "refit")

```

# sensitivity analyses for age-related connections - covarying for sex, motion, roi tsnr, roi size (in voxels)
```{r}
### Controlling for sex in age analyses ###
# Data preparation
temp.df <- amygdala_nuclei_7T %>%
  dplyr::select(id, visit, roiA, roiB, roiA_side, roiB_side, laterality, context, scan_age, fc, sex) %>% 
  filter(roiA %in% c("antvmpfc", "CEN"), roiB %in% c("antvmpfc", "CEN"), roiA != roiB) %>%
  distinct() %>%
  mutate(
    laterality = as.factor(laterality),
    roiA_side = as.factor(roiA_side),
    roiB_side = as.factor(roiB_side),
    id = as.factor(id),
    context = as.factor(context),
    visit = as.factor(visit),
    roiA = as.factor(roiA),
    roiB = as.factor(roiB),
    sex = as.factor(sex)
  )

# Remove incomplete cases
temp.df <- temp.df %>%
    filter(complete.cases(dplyr::select(., fc, scan_age, laterality, roiA_side, sex)))

# Initial BAM model
initial_bam <- bam(
    fc ~ s(scan_age, k = 3, fx = T) + laterality + roiA_side + context + sex,
    random = list(id = ~1 + visit),
    data = temp.df,
    REML = TRUE,
    discrete = TRUE
)

# Add residuals to dataframe
temp.df <- temp.df %>%
    mutate(bam.resid = residuals(initial_bam))

# Final BAM model after removing outliers
filtered_df <- temp.df %>%
    mutate(bam.z = abs(scale(bam.resid)[, 1])) %>%
    filter(bam.z < 2)

final_bam <- bam(
    fc ~ s(scan_age, k = 3, fx = T) + laterality + roiA_side + context + sex,
    random = list(id = ~1 + visit),
    data = filtered_df,
    REML = TRUE,
    discrete = TRUE
)

# Summary
model_parameters(final_bam, standardize = "refit")


### Controlling for motion in age analyses - using fd03 as covariate ###
# Data preparation
temp.df <- amygdala_nuclei_7T %>%
  dplyr::select(id, visit, roiA, roiB, roiA_side, roiB_side, laterality, context, scan_age, fc, fd03) %>% 
  filter(roiA %in% c("antvmpfc", "CEN"), roiB %in% c("antvmpfc", "CEN"), roiA != roiB) %>%
  distinct() %>%
  mutate(
    laterality = as.factor(laterality),
    roiA_side = as.factor(roiA_side),
    roiB_side = as.factor(roiB_side),
    id = as.factor(id),
    context = as.factor(context),
    visit = as.factor(visit),
    roiA = as.factor(roiA),
    roiB = as.factor(roiB)
  )

# Remove incomplete cases
temp.df <- temp.df %>%
    filter(complete.cases(dplyr::select(., fc, scan_age, laterality, roiA_side, fd03)))

# Initial BAM model
initial_bam <- bam(
    fc ~ s(scan_age, k = 3, fx = T) + laterality + roiA_side + context + fd03,
    random = list(id = ~1 + visit),
    data = temp.df,
    REML = TRUE,
    discrete = TRUE
)

# Add residuals to dataframe
temp.df <- temp.df %>%
    mutate(bam.resid = residuals(initial_bam))

# Final BAM model after removing outliers
filtered_df <- temp.df %>%
    mutate(bam.z = abs(scale(bam.resid)[, 1])) %>%
    filter(bam.z < 2)

final_bam <- bam(
    fc ~ s(scan_age, k = 3, fx = T) + laterality + roiA_side + context + fd03,
    random = list(id = ~1 + visit),
    data = filtered_df,
    REML = TRUE,
    discrete = TRUE
)

# Summary
model_parameters(final_bam, standardize = "refit")


###  Controlling for roi tsnr in age analyses ###
# Data preparation
temp.df <- amygdala_nuclei_7T %>%
    filter(roiA %in% c("antvmpfc", "CEN"), roiB %in% c("antvmpfc", "CEN"), roiA != roiB) %>%
    distinct() %>%
    mutate(
        laterality = as.factor(laterality),
        roiA_side = as.factor(roiA_side),
        roiB_side = as.factor(roiB_side),
        id = as.factor(id),
        context = as.factor(context),
        visit = as.factor(visit),
        roiB = as.factor(roiB)
    ) %>% 
    full_join(roi_tsnr, by = "scan_id") %>% 
    mutate(
        roiA_tsnr = case_when(
            roiA == "antvmpfc" & roiA_side == "L" ~ antvmpfc_L,
            roiA == "antvmpfc" & roiA_side == "R" ~ antvmpfc_R,
            roiA == "CEN" & roiA_side == "L" ~ CEN_L,
            roiA == "CEN" & roiA_side == "R" ~ CEN_R,
            TRUE ~ NA_real_
        ),
        roiB_tsnr = case_when(
            roiB == "antvmpfc" & roiB_side == "L" ~ antvmpfc_L,
            roiB == "antvmpfc" & roiB_side == "R" ~ antvmpfc_R,
            roiB == "CEN" & roiB_side == "L" ~ CEN_L,
            roiB == "CEN" & roiB_side == "R" ~ CEN_R,
            TRUE ~ NA_real_
        )
    )

# Remove missing data
temp.df <- temp.df %>%
    filter(complete.cases(dplyr::select(., fc, scan_age, laterality, roiA_side, roiA_tsnr, roiB_tsnr)))

# Initial BAM model including ROI sizes as covariates
initial_bam <- bam(
    fc ~ s(scan_age, k = 3, fx = T) + laterality + roiA_side + context + roiA_tsnr + roiB_tsnr, 
    random = list(id = ~1 + visit),
    data = temp.df,
    REML = TRUE,
    discrete = TRUE
)

# Add residuals to dataframe
temp.df <- temp.df %>%
    mutate(bam.resid = residuals(initial_bam))

# Final BAM model after removing outliers
filtered_df <- temp.df %>%
    mutate(bam.z = abs(scale(bam.resid)[, 1])) %>%
    filter(bam.z < 2)

final_bam <- bam(
    fc ~ s(scan_age, k = 3, fx = T) + laterality + roiA_side + context + roiA_tsnr + roiB_tsnr,
    random = list(id = ~1 + visit),
    data = filtered_df,
    REML = TRUE,
    discrete = TRUE
)

# Summary
model_parameters(final_bam, standardize = "refit")


###  Controlling for roi size (in voxels) in age analyses ###
# Data preparation
temp.df <- amygdala_nuclei_7T %>%
    filter(roiA %in% c("antvmpfc", "CEN"), roiB %in% c("antvmpfc", "CEN")) %>%
    filter(roiA != roiB) %>%
    distinct() %>%
    mutate(
        laterality = as.factor(laterality),
        roiA_side = as.factor(roiA_side),
        roiB_side = as.factor(roiB_side),
        id = as.factor(id),
        context = as.factor(context),
        visit = as.factor(visit),
        roiB = as.factor(roiB)
    ) %>% 
    full_join(roi_size, by = "scan_id") %>%
    mutate(
        roiA_size = case_when(
            roiA == "antvmpfc" & roiA_side == "L" ~ antvmpfc_L,
            roiA == "antvmpfc" & roiA_side == "R" ~ antvmpfc_R,
            roiA == "CEN" & roiA_side == "L" ~ CEN_L,
            roiA == "CEN" & roiA_side == "R" ~ CEN_R,
            TRUE ~ NA_real_
        ),
        roiB_size = case_when(
            roiB == "antvmpfc" & roiB_side == "L" ~ antvmpfc_L,
            roiB == "antvmpfc" & roiB_side == "R" ~ antvmpfc_R,
            roiB == "CEN" & roiB_side == "L" ~ CEN_L,
            roiB == "CEN" & roiB_side == "R" ~ CEN_R,
            TRUE ~ NA_real_
        )
    )

# Remove missing data
temp.df <- temp.df %>%
    filter(complete.cases(dplyr::select(., fc, scan_age, laterality, roiA_side, roiA_size, roiB_size)))

# Initial BAM model including ROI sizes as covariates
initial_bam <- bam(
    fc ~ s(scan_age, k = 3, fx = T) + laterality + roiA_side + context + roiA_size + roiB_size,
    random = list(id = ~1 + visit),
    data = temp.df,
    REML = TRUE,
    discrete = TRUE
)

# Add residuals to dataframe
temp.df <- temp.df %>%
    mutate(bam.resid = residuals(initial_bam))

# Final BAM model after removing outliers
filtered_df <- temp.df %>%
    mutate(bam.z = abs(scale(bam.resid)[, 1])) %>%
    filter(bam.z < 2)

final_bam <- bam(
    fc ~ s(scan_age, k = 3, fx = T) + laterality + roiA_side + context + roiA_size + roiB_size,
    random = list(id = ~1 + visit),
    data = filtered_df,
    REML = TRUE,
    discrete = TRUE
)

# Summary
model_parameters(final_bam, standardize = "refit")


```

# sex analyses for age-related connections - main effects, interactions, sex-specific (separated)
```{r}
### Testing main and interaction effects of sex on age-related fronto-amygdala connections 
# Data preparation
temp.df <- amygdala_nuclei_7T %>%
  dplyr::select(id, visit, roiA, roiB, roiA_side, roiB_side, laterality, context, scan_age, fc, sex) %>% 
  filter(roiA %in% c("antvmpfc", "CEN"), roiB %in% c("antvmpfc", "CEN"), roiA != roiB) %>%
  distinct() %>%
  mutate(
    laterality = as.factor(laterality),
    roiA_side = as.factor(roiA_side),
    roiB_side = as.factor(roiB_side),
    id = as.factor(id),
    context = as.factor(context),
    visit = as.factor(visit),
    roiA = as.factor(roiA),
    roiB = as.factor(roiB),
    sex = as.factor(sex)
  )

# Remove incomplete cases
temp.df <- temp.df %>%
    filter(complete.cases(dplyr::select(., fc, scan_age, laterality, roiA_side, sex)))

# Create ordered factor for sex 
temp.df$osex <- ordered(temp.df$sex, levels = c("M","F"))

# Initial BAM model
initial_bam <- bam(
    fc ~ s(scan_age, k = 3, fx = T, by = osex) + s(scan_age, k = 3, fx = T) + laterality + roiA_side + context + osex,
    random = list(id = ~1 + visit),
    data = temp.df,
    REML = TRUE,
    discrete = TRUE
)

# Add residuals to dataframe
temp.df <- temp.df %>%
    mutate(bam.resid = residuals(initial_bam))

# Final BAM model after removing outliers
filtered_df <- temp.df %>%
    mutate(bam.z = abs(scale(bam.resid)[, 1])) %>%
    filter(bam.z < 2)

final_bam <- bam(
    fc ~ s(scan_age, k = 3, fx = T, by = osex) + s(scan_age, k = 3, fx = T) + laterality + roiA_side + context + osex,
    random = list(id = ~1 + visit),
    data = filtered_df,
    REML = TRUE,
    discrete = TRUE
)

# Summary
model_parameters(final_bam, standardize = "refit")


# for significant (p<.05) sex interaction effects, following up on those connections separated by sex for males and females

### Testing sex-specific age effects (separately in males and females) ###
# Data preparation
temp.df <- amygdala_nuclei_7T %>%
  dplyr::select(id, visit, roiA, roiB, roiA_side, roiB_side, laterality, context, scan_age, fc, sex) %>% 
  filter(roiA %in% c("antvmpfc", "CEN"), roiB %in% c("antvmpfc", "CEN"), roiA != roiB, sex == "F") %>%
  distinct() %>%
  mutate(
    laterality = as.factor(laterality),
    roiA_side = as.factor(roiA_side),
    roiB_side = as.factor(roiB_side),
    id = as.factor(id),
    context = as.factor(context),
    visit = as.factor(visit),
    roiA = as.factor(roiA),
    roiB = as.factor(roiB)
  )

# Remove incomplete cases
temp.df <- temp.df %>%
    filter(complete.cases(dplyr::select(., fc, scan_age, laterality, roiA_side)))

# Initial BAM model
initial_bam <- bam(
    fc ~ s(scan_age, k = 3, fx = T) + laterality + roiA_side + context,
    random = list(id = ~1 + visit),
    data = temp.df,
    REML = TRUE,
    discrete = TRUE
)

# Add residuals to dataframe
temp.df <- temp.df %>%
    mutate(bam.resid = residuals(initial_bam))

# Final BAM model after removing outliers
filtered_df <- temp.df %>%
    mutate(bam.z = abs(scale(bam.resid)[, 1])) %>%
    filter(bam.z < 2)

final_bam <- bam(
    fc ~ s(scan_age, k = 3, fx = T) + laterality + roiA_side + context,
    random = list(id = ~1 + visit),
    data = filtered_df,
    REML = TRUE,
    discrete = TRUE
)

# Summary
model_parameters(final_bam, standardize = "refit")

```

# viz for sex analyses for age-related connections
```{r}
# Data preparation
temp.df <- amygdala_nuclei_7T %>%
  dplyr::select(id, visit, roiA, roiB, roiA_side, roiB_side, laterality, context, scan_age, fc, sex) %>% 
  filter(roiA %in% c("antvmpfc", "CEN"), roiB %in% c("antvmpfc", "CEN"), roiA != roiB) %>%
  distinct() %>%
  mutate(
    laterality = as.factor(laterality),
    roiA_side = as.factor(roiA_side),
    roiB_side = as.factor(roiB_side),
    id = as.factor(id),
    context = as.factor(context),
    visit = as.factor(visit),
    roiA = as.factor(roiA),
    roiB = as.factor(roiB),
    sex = as.factor(sex)
  )

# Remove incomplete cases
temp.df <- temp.df %>%
    filter(complete.cases(dplyr::select(., fc, scan_age, laterality, roiA_side, sex)))

# Create ordered factor for sex 
temp.df$osex <- ordered(temp.df$sex, levels = c("M","F"))

# Initial BAM model
initial_bam <- bam(
    fc ~ s(scan_age, k = 3, fx = T, by = osex) + s(scan_age, k = 3, fx = T) + laterality + roiA_side + context + osex,
    random = list(id = ~1 + visit),
    data = temp.df,
    REML = TRUE,
    discrete = TRUE
)

# Add residuals to dataframe
temp.df <- temp.df %>%
    mutate(bam.resid = residuals(initial_bam))

# Final BAM model after removing outliers
filtered_df <- temp.df %>%
    mutate(bam.z = abs(scale(bam.resid)[, 1])) %>%
    filter(bam.z < 2)

final_bam_antvmpfc_CEN_sex <- bam(
    fc ~ s(scan_age, k = 3, fx = T, by = osex) + s(scan_age, k = 3, fx = T) + laterality + roiA_side + context + osex,
    random = list(id = ~1 + visit),
    data = filtered_df,
    REML = TRUE,
    discrete = TRUE
)

# Summary
model_parameters(final_bam_antvmpfc_CEN_sex, standardize = "refit")

# Viz
antvmpfc_CEN_sex_plot <- ggeffects::ggpredict(final_bam_antvmpfc_CEN_sex, terms = c("scan_age", "osex")) %>%
    ggplot(aes(
        x = x,
        y = predicted,
        group = group
    )) +
    geom_line(aes(color = group), size = 1.25) +
    geom_ribbon(aes(ymin = conf.low, ymax = conf.high, fill = group), alpha = 0.2) +
    theme_modern(axis.title.space = .5, plot.title.space = .5) +
    xlab("Age (Years)") +
    ylab("Functional Connectivity") +
    ggtitle("ant. vmPFC - CEN") +
    scale_color_manual(name = "Sex", values = c("M" = scales::hue_pal()(2)[2], "F" = scales::hue_pal()(2)[1])) +
    scale_fill_manual(name = "Sex", values = c("M" = scales::hue_pal()(2)[2], "F" = scales::hue_pal()(2)[1])) +
    theme(
        plot.title = element_text(hjust = 0.6),
        legend.position = "none"
    ) +
    coord_cartesian(ylim = c(-.2, .2))
# Data preparation
temp.df <- amygdala_nuclei_7T %>%
  dplyr::select(id, visit, roiA, roiB, roiA_side, roiB_side, laterality, context, scan_age, fc, sex) %>% 
  filter(roiA %in% c("dlpfc", "BN"), roiB %in% c("dlpfc", "BN"), roiA != roiB) %>%
  distinct() %>%
  mutate(
    laterality = as.factor(laterality),
    roiA_side = as.factor(roiA_side),
    roiB_side = as.factor(roiB_side),
    id = as.factor(id),
    context = as.factor(context),
    visit = as.factor(visit),
    roiA = as.factor(roiA),
    roiB = as.factor(roiB),
    sex = as.factor(sex)
  )

# Remove incomplete cases
temp.df <- temp.df %>%
    filter(complete.cases(dplyr::select(., fc, scan_age, laterality, roiA_side, sex)))

# Create ordered factor for sex 
temp.df$osex <- ordered(temp.df$sex, levels = c("M","F"))

# Initial BAM model
initial_bam <- bam(
    fc ~ s(scan_age, k = 3, fx = T, by = osex) + s(scan_age, k = 3, fx = T) + laterality + roiA_side + context + osex,
    random = list(id = ~1 + visit),
    data = temp.df,
    REML = TRUE,
    discrete = TRUE
)

# Add residuals to dataframe
temp.df <- temp.df %>%
    mutate(bam.resid = residuals(initial_bam))

# Final BAM model after removing outliers
filtered_df <- temp.df %>%
    mutate(bam.z = abs(scale(bam.resid)[, 1])) %>%
    filter(bam.z < 2)

final_bam_dlpfc_BN_sex <- bam(
    fc ~ s(scan_age, k = 3, fx = T, by = osex) + s(scan_age, k = 3, fx = T) + laterality + roiA_side + context + osex,
    random = list(id = ~1 + visit),
    data = filtered_df,
    REML = TRUE,
    discrete = TRUE
)

# Summary
model_parameters(final_bam_dlpfc_BN_sex, standardize = "refit")

# Viz
dlpfc_BN_sex_plot <- ggeffects::ggpredict(final_bam_dlpfc_BN_sex, terms = c("scan_age", "osex")) %>%
    ggplot(aes(
        x = x,
        y = predicted,
        group = group
    )) +
    geom_line(aes(color = group), size = 1.25) +
    geom_ribbon(aes(ymin = conf.low, ymax = conf.high, fill = group), alpha = 0.2) +
    theme_modern(axis.title.space = .5, plot.title.space = .5) +
    xlab("Age (Years)") +
    ylab("Functional Connectivity") +
    ggtitle("dlPFC - BN") +
    scale_color_manual(name = "Sex", values = c("M" = scales::hue_pal()(2)[2], "F" = scales::hue_pal()(2)[1])) +
    scale_fill_manual(name = "Sex", values = c("M" = scales::hue_pal()(2)[2], "F" = scales::hue_pal()(2)[1])) +
    theme(
        plot.title = element_text(hjust = 0.6),
        legend.position = "none"
    ) +
    coord_cartesian(ylim = c(-.2, .2))

# Data preparation
temp.df <- amygdala_nuclei_7T %>%
  dplyr::select(id, visit, roiA, roiB, roiA_side, roiB_side, laterality, context, scan_age, fc, sex) %>% 
  filter(roiA %in% c("dlpfc", "LN"), roiB %in% c("dlpfc", "LN"), roiA != roiB) %>%
  distinct() %>%
  mutate(
    laterality = as.factor(laterality),
    roiA_side = as.factor(roiA_side),
    roiB_side = as.factor(roiB_side),
    id = as.factor(id),
    context = as.factor(context),
    visit = as.factor(visit),
    roiA = as.factor(roiA),
    roiB = as.factor(roiB),
    sex = as.factor(sex)
  )

# Remove incomplete cases
temp.df <- temp.df %>%
    filter(complete.cases(dplyr::select(., fc, scan_age, laterality, roiA_side, sex)))

# Create ordered factor for sex 
temp.df$osex <- ordered(temp.df$sex, levels = c("M","F"))

# Initial BAM model
initial_bam <- bam(
    fc ~ s(scan_age, k = 3, fx = T, by = osex) + s(scan_age, k = 3, fx = T) + laterality + roiA_side + context + osex,
    random = list(id = ~1 + visit),
    data = temp.df,
    REML = TRUE,
    discrete = TRUE
)

# Add residuals to dataframe
temp.df <- temp.df %>%
    mutate(bam.resid = residuals(initial_bam))

# Final BAM model after removing outliers
filtered_df <- temp.df %>%
    mutate(bam.z = abs(scale(bam.resid)[, 1])) %>%
    filter(bam.z < 2)

final_bam_dlpfc_LN_sex <- bam(
    fc ~ s(scan_age, k = 3, fx = T, by = osex) + s(scan_age, k = 3, fx = T) + laterality + roiA_side + context + osex,
    random = list(id = ~1 + visit),
    data = filtered_df,
    REML = TRUE,
    discrete = TRUE
)

# Summary
model_parameters(final_bam_dlpfc_LN_sex, standardize = "refit")

# Viz
dlpfc_LN_sex_plot <- ggeffects::ggpredict(final_bam_dlpfc_LN_sex, terms = c("scan_age", "osex")) %>%
    ggplot(aes(
        x = x,
        y = predicted,
        group = group
    )) +
    geom_line(aes(color = group), size = 1.25) +
    geom_ribbon(aes(ymin = conf.low, ymax = conf.high, fill = group), alpha = 0.2) +
    theme_modern(axis.title.space = .5, plot.title.space = .5) +
    xlab("Age (Years)") +
    ylab("Functional Connectivity") +
    ggtitle("dlPFC - LN") +
    scale_color_manual(name = "Sex", values = c("M" = scales::hue_pal()(2)[2], "F" = scales::hue_pal()(2)[1])) +
    scale_fill_manual(name = "Sex", values = c("M" = scales::hue_pal()(2)[2], "F" = scales::hue_pal()(2)[1])) +
    theme(
        plot.title = element_text(hjust = 0.6),
        legend.position = "none"
    ) +
    coord_cartesian(ylim = c(-.2, .2))

# Data preparation
temp.df <- amygdala_nuclei_7T %>%
  dplyr::select(id, visit, roiA, roiB, roiA_side, roiB_side, laterality, context, scan_age, fc, sex) %>% 
  filter(roiA %in% c("racc", "CAT"), roiB %in% c("racc", "CAT"), roiA != roiB) %>%
  distinct() %>%
  mutate(
    laterality = as.factor(laterality),
    roiA_side = as.factor(roiA_side),
    roiB_side = as.factor(roiB_side),
    id = as.factor(id),
    context = as.factor(context),
    visit = as.factor(visit),
    roiA = as.factor(roiA),
    roiB = as.factor(roiB),
    sex = as.factor(sex)
  )

# Remove incomplete cases
temp.df <- temp.df %>%
    filter(complete.cases(dplyr::select(., fc, scan_age, laterality, roiA_side, sex)))

# Create ordered factor for sex 
temp.df$osex <- ordered(temp.df$sex, levels = c("M","F"))

# Initial BAM model
initial_bam <- bam(
    fc ~ s(scan_age, k = 3, fx = T, by = osex) + s(scan_age, k = 3, fx = T) + laterality + roiA_side + context + osex,
    random = list(id = ~1 + visit),
    data = temp.df,
    REML = TRUE,
    discrete = TRUE
)

# Add residuals to dataframe
temp.df <- temp.df %>%
    mutate(bam.resid = residuals(initial_bam))

# Final BAM model after removing outliers
filtered_df <- temp.df %>%
    mutate(bam.z = abs(scale(bam.resid)[, 1])) %>%
    filter(bam.z < 2)

final_bam_racc_CAT_sex <- bam(
    fc ~ s(scan_age, k = 3, fx = T, by = osex) + s(scan_age, k = 3, fx = T) + laterality + roiA_side + context + osex,
    random = list(id = ~1 + visit),
    data = filtered_df,
    REML = TRUE,
    discrete = TRUE
)

# Summary
model_parameters(final_bam_racc_CAT_sex, standardize = "refit")

# Viz
racc_CAT_sex_plot <- ggeffects::ggpredict(final_bam_racc_CAT_sex, terms = c("scan_age", "osex")) %>%
    ggplot(aes(
        x = x,
        y = predicted,
        group = group
    )) +
    geom_line(aes(color = group), size = 1.25) +
    geom_ribbon(aes(ymin = conf.low, ymax = conf.high, fill = group), alpha = 0.2) +
    theme_modern(axis.title.space = .5, plot.title.space = .5) +
    xlab("Age (Years)") +
    ylab("Functional Connectivity") +
    ggtitle("rACC - CAT") +
    scale_color_manual(name = "Sex", values = c("M" = scales::hue_pal()(2)[2], "F" = scales::hue_pal()(2)[1])) +
    scale_fill_manual(name = "Sex", values = c("M" = scales::hue_pal()(2)[2], "F" = scales::hue_pal()(2)[1])) +
    theme(
        plot.title = element_text(hjust = 0.6),
        legend.position = "none"
    ) +
    coord_cartesian(ylim = c(-.2, .2))

# Data preparation
temp.df <- amygdala_nuclei_7T %>%
  dplyr::select(id, visit, roiA, roiB, roiA_side, roiB_side, laterality, context, scan_age, fc, sex) %>% 
  filter(roiA %in% c("vacc", "CAT"), roiB %in% c("vacc", "CAT"), roiA != roiB) %>%
  distinct() %>%
  mutate(
    laterality = as.factor(laterality),
    roiA_side = as.factor(roiA_side),
    roiB_side = as.factor(roiB_side),
    id = as.factor(id),
    context = as.factor(context),
    visit = as.factor(visit),
    roiA = as.factor(roiA),
    roiB = as.factor(roiB),
    sex = as.factor(sex)
  )

# Remove incomplete cases
temp.df <- temp.df %>%
    filter(complete.cases(dplyr::select(., fc, scan_age, laterality, roiA_side, sex)))

# Create ordered factor for sex 
temp.df$osex <- ordered(temp.df$sex, levels = c("M","F"))

# Initial BAM model
initial_bam <- bam(
    fc ~ s(scan_age, k = 3, fx = T, by = osex) + s(scan_age, k = 3, fx = T) + laterality + roiA_side + context + osex,
    random = list(id = ~1 + visit),
    data = temp.df,
    REML = TRUE,
    discrete = TRUE
)

# Add residuals to dataframe
temp.df <- temp.df %>%
    mutate(bam.resid = residuals(initial_bam))

# Final BAM model after removing outliers
filtered_df <- temp.df %>%
    mutate(bam.z = abs(scale(bam.resid)[, 1])) %>%
    filter(bam.z < 2)

final_bam_vacc_CAT_sex <- bam(
    fc ~ s(scan_age, k = 3, fx = T, by = osex) + s(scan_age, k = 3, fx = T) + laterality + roiA_side + context + osex,
    random = list(id = ~1 + visit),
    data = filtered_df,
    REML = TRUE,
    discrete = TRUE
)

# Summary
model_parameters(final_bam_vacc_CAT_sex, standardize = "refit")

# Viz
vacc_CAT_sex_plot <- ggeffects::ggpredict(final_bam_vacc_CAT_sex, terms = c("scan_age", "osex")) %>%
    ggplot(aes(
        x = x,
        y = predicted,
        group = group
    )) +
    geom_line(aes(color = group), size = 1.25) +
    geom_ribbon(aes(ymin = conf.low, ymax = conf.high, fill = group), alpha = 0.2) +
    theme_modern(axis.title.space = .5, plot.title.space = .5) +
    xlab("Age (Years)") +
    ylab("Functional Connectivity") +
    ggtitle("vACC - CAT") +
    scale_color_manual(name = "Sex", values = c("M" = scales::hue_pal()(2)[2], "F" = scales::hue_pal()(2)[1])) +
    scale_fill_manual(name = "Sex", values = c("M" = scales::hue_pal()(2)[2], "F" = scales::hue_pal()(2)[1])) +
    theme(
        plot.title = element_text(hjust = 0.6),
        legend.position = "none"
    ) +
    coord_cartesian(ylim = c(-.2, .2))

# Data preparation
temp.df <- amygdala_nuclei_7T %>%
  dplyr::select(id, visit, roiA, roiB, roiA_side, roiB_side, laterality, context, scan_age, fc, sex) %>% 
  filter(roiA %in% c("sgacc", "CAT"), roiB %in% c("sgacc", "CAT"), roiA != roiB) %>%
  distinct() %>%
  mutate(
    laterality = as.factor(laterality),
    roiA_side = as.factor(roiA_side),
    roiB_side = as.factor(roiB_side),
    id = as.factor(id),
    context = as.factor(context),
    visit = as.factor(visit),
    roiA = as.factor(roiA),
    roiB = as.factor(roiB),
    sex = as.factor(sex)
  )

# Remove incomplete cases
temp.df <- temp.df %>%
    filter(complete.cases(dplyr::select(., fc, scan_age, laterality, roiA_side, sex)))

# Create ordered factor for sex 
temp.df$osex <- ordered(temp.df$sex, levels = c("M","F"))

# Initial BAM model
initial_bam <- bam(
    fc ~ s(scan_age, k = 3, fx = T, by = osex) + s(scan_age, k = 3, fx = T) + laterality + roiA_side + context + osex,
    random = list(id = ~1 + visit),
    data = temp.df,
    REML = TRUE,
    discrete = TRUE
)

# Add residuals to dataframe
temp.df <- temp.df %>%
    mutate(bam.resid = residuals(initial_bam))

# Final BAM model after removing outliers
filtered_df <- temp.df %>%
    mutate(bam.z = abs(scale(bam.resid)[, 1])) %>%
    filter(bam.z < 2)

final_bam_sgacc_CAT_sex <- bam(
    fc ~ s(scan_age, k = 3, fx = T, by = osex) + s(scan_age, k = 3, fx = T) + laterality + roiA_side + context + osex,
    random = list(id = ~1 + visit),
    data = filtered_df,
    REML = TRUE,
    discrete = TRUE
)

# Summary
model_parameters(final_bam_sgacc_CAT_sex, standardize = "refit")

# Viz
sgacc_CAT_sex_plot <- ggeffects::ggpredict(final_bam_sgacc_CAT_sex, terms = c("scan_age", "osex")) %>%
    ggplot(aes(
        x = x,
        y = predicted,
        group = group
    )) +
    geom_line(aes(color = group), size = 1.25) +
    geom_ribbon(aes(ymin = conf.low, ymax = conf.high, fill = group), alpha = 0.2) +
    theme_modern(axis.title.space = .5, plot.title.space = .5) +
    xlab("Age (Years)") +
    ylab("Functional Connectivity") +
    ggtitle("sgACC - CAT") +
    scale_color_manual(name = "Sex", values = c("M" = scales::hue_pal()(2)[2], "F" = scales::hue_pal()(2)[1])) +
    scale_fill_manual(name = "Sex", values = c("M" = scales::hue_pal()(2)[2], "F" = scales::hue_pal()(2)[1])) +
    theme(
        plot.title = element_text(hjust = 0.6),
        legend.position = "none"
    ) +
    coord_cartesian(ylim = c(-.2, .2))

# Data preparation
temp.df <- amygdala_nuclei_7T %>%
  dplyr::select(id, visit, roiA, roiB, roiA_side, roiB_side, laterality, context, scan_age, fc, sex) %>% 
  filter(roiA %in% c("vlpfc", "CEN"), roiB %in% c("vlpfc", "CEN"), roiA != roiB) %>%
  distinct() %>%
  mutate(
    laterality = as.factor(laterality),
    roiA_side = as.factor(roiA_side),
    roiB_side = as.factor(roiB_side),
    id = as.factor(id),
    context = as.factor(context),
    visit = as.factor(visit),
    roiA = as.factor(roiA),
    roiB = as.factor(roiB),
    sex = as.factor(sex)
  )

# Remove incomplete cases
temp.df <- temp.df %>%
    filter(complete.cases(dplyr::select(., fc, scan_age, laterality, roiA_side, sex)))

# Create ordered factor for sex 
temp.df$osex <- ordered(temp.df$sex, levels = c("M","F"))

# Initial BAM model
initial_bam <- bam(
    fc ~ s(scan_age, k = 3, fx = T, by = osex) + s(scan_age, k = 3, fx = T) + laterality + roiA_side + context + osex,
    random = list(id = ~1 + visit),
    data = temp.df,
    REML = TRUE,
    discrete = TRUE
)

# Add residuals to dataframe
temp.df <- temp.df %>%
    mutate(bam.resid = residuals(initial_bam))

# Final BAM model after removing outliers
filtered_df <- temp.df %>%
    mutate(bam.z = abs(scale(bam.resid)[, 1])) %>%
    filter(bam.z < 2)

final_bam_vlpfc_CEN_sex <- bam(
    fc ~ s(scan_age, k = 3, fx = T, by = osex) + s(scan_age, k = 3, fx = T) + laterality + roiA_side + context + osex,
    random = list(id = ~1 + visit),
    data = filtered_df,
    REML = TRUE,
    discrete = TRUE
)

# Summary
model_parameters(final_bam_vlpfc_CEN_sex, standardize = "refit")

# Viz
vlpfc_CEN_sex_plot <- ggeffects::ggpredict(final_bam_vlpfc_CEN_sex, terms = c("scan_age", "osex")) %>%
    ggplot(aes(
        x = x,
        y = predicted,
        group = group
    )) +
    geom_line(aes(color = group), size = 1.25) +
    geom_ribbon(aes(ymin = conf.low, ymax = conf.high, fill = group), alpha = 0.2) +
    theme_modern(axis.title.space = .5, plot.title.space = .5) +
    xlab("Age (Years)") +
    ylab("Functional Connectivity") +
    ggtitle("vlPFC - CEN") +
    scale_color_manual(name = "Sex", values = c("M" = scales::hue_pal()(2)[2], "F" = scales::hue_pal()(2)[1])) +
    scale_fill_manual(name = "Sex", values = c("M" = scales::hue_pal()(2)[2], "F" = scales::hue_pal()(2)[1])) +
    theme(
        plot.title = element_text(hjust = 0.6),
        legend.position = "none"
    ) +
    coord_cartesian(ylim = c(-.2, .2))

# Data preparation
temp.df <- amygdala_nuclei_7T %>%
  dplyr::select(id, visit, roiA, roiB, roiA_side, roiB_side, laterality, context, scan_age, fc, sex) %>% 
  filter(roiA %in% c("vlpfc", "LN"), roiB %in% c("vlpfc", "LN"), roiA != roiB) %>%
  distinct() %>%
  mutate(
    laterality = as.factor(laterality),
    roiA_side = as.factor(roiA_side),
    roiB_side = as.factor(roiB_side),
    id = as.factor(id),
    context = as.factor(context),
    visit = as.factor(visit),
    roiA = as.factor(roiA),
    roiB = as.factor(roiB),
    sex = as.factor(sex)
  )

# Remove incomplete cases
temp.df <- temp.df %>%
    filter(complete.cases(dplyr::select(., fc, scan_age, laterality, roiA_side, sex)))

# Create ordered factor for sex 
temp.df$osex <- ordered(temp.df$sex, levels = c("M","F"))

# Initial BAM model
initial_bam <- bam(
    fc ~ s(scan_age, k = 3, fx = T, by = osex) + s(scan_age, k = 3, fx = T) + laterality + roiA_side + context + osex,
    random = list(id = ~1 + visit),
    data = temp.df,
    REML = TRUE,
    discrete = TRUE
)

# Add residuals to dataframe
temp.df <- temp.df %>%
    mutate(bam.resid = residuals(initial_bam))

# Final BAM model after removing outliers
filtered_df <- temp.df %>%
    mutate(bam.z = abs(scale(bam.resid)[, 1])) %>%
    filter(bam.z < 2)

final_bam_vlpfc_LN_sex <- bam(
    fc ~ s(scan_age, k = 3, fx = T, by = osex) + s(scan_age, k = 3, fx = T) + laterality + roiA_side + context + osex,
    random = list(id = ~1 + visit),
    data = filtered_df,
    REML = TRUE,
    discrete = TRUE
)

# Summary
model_parameters(final_bam_vlpfc_LN_sex, standardize = "refit")

# Viz
vlpfc_LN_sex_plot <- ggeffects::ggpredict(final_bam_vlpfc_LN_sex, terms = c("scan_age", "osex")) %>%
    ggplot(aes(
        x = x,
        y = predicted,
        group = group
    )) +
    geom_line(aes(color = group), size = 1.25) +
    geom_ribbon(aes(ymin = conf.low, ymax = conf.high, fill = group), alpha = 0.2) +
    theme_modern(axis.title.space = .5, plot.title.space = .5) +
    xlab("Age (Years)") +
    ylab("Functional Connectivity") +
    ggtitle("vlPFC - LN") +
    scale_color_manual(name = "Sex", values = c("M" = scales::hue_pal()(2)[2], "F" = scales::hue_pal()(2)[1])) +
    scale_fill_manual(name = "Sex", values = c("M" = scales::hue_pal()(2)[2], "F" = scales::hue_pal()(2)[1])) +
    theme(
        plot.title = element_text(hjust = 0.6),
        legend.position = "none"
    ) +
    coord_cartesian(ylim = c(-.2, .2))

ggarrange(antvmpfc_CEN_sex_plot, dlpfc_BN_sex_plot, dlpfc_LN_sex_plot, racc_CAT_sex_plot, vacc_CAT_sex_plot, sgacc_CAT_sex_plot, vlpfc_CEN_sex_plot, vlpfc_LN_sex_plot,
          nrow = 2, ncol = 4,
          common.legend = TRUE,
          legend = "right",
          labels = c("A", "B", "C", "D", "E", "F", "G","H"),
          align = "hv")

```

# sex analyses for brain-behavior associations - interactions, sex-specific (separated)
```{r}
# Data preparation
temp.df <- amygdala_nuclei_7T %>%
    filter(roiA %in% c("antvmpfc", "CEN"), roiB %in% c("antvmpfc", "CEN"), roiA != roiB) %>%
    distinct() %>%
    mutate(
        laterality = as.factor(laterality),
        roiA_side = as.factor(roiA_side),
        roiB_side = as.factor(roiB_side),
        id = as.factor(id),
        context = as.factor(context),
        visit = as.factor(visit),
        roiB = as.factor(roiB),
        sex = as.factor(sex)
    )

# Remove missing data
temp.df <- temp.df %>%
    filter(complete.cases(dplyr::select(., fc, scan_age, laterality, roiA_side, internalizing_probs_T, externalizing_probs_T, sex)))

# Initial BAM model
initial_bam <- bam(
  fc ~ s(scan_age, k = 3, fx = T) + internalizing_probs_T * sex + laterality + roiA_side + context,
  random = list(id = ~1 + visit),
  data = temp.df,
  REML = TRUE,
  discrete = TRUE
)

# Add residuals to dataframe
temp.df <- temp.df %>%
    mutate(bam.resid = residuals(initial_bam))

# Final BAM model after removing outliers
filtered_df <- temp.df %>%
    mutate(bam.z = abs(scale(bam.resid)[, 1])) %>%
    filter(bam.z < 2)

final_bam <- bam(
  fc ~ s(scan_age, k = 3, fx = T) + internalizing_probs_T * sex + laterality + roiA_side + context,
  random = list(id = ~1 + visit),
  data = filtered_df,
  REML = TRUE,
  discrete = TRUE
)

# Summary
model_parameters(final_bam, standardize = "refit")


# for significant (p<.05) sex interaction effects, following up on those connections separated by sex for males and females

# Data preparation
temp.df <- amygdala_nuclei_7T %>%
    filter(roiA %in% c("antvmpfc", "CEN"), roiB %in% c("antvmpfc", "CEN"), roiA != roiB, sex == "F") %>%
    distinct() %>%
    mutate(
        laterality = as.factor(laterality),
        roiA_side = as.factor(roiA_side),
        roiB_side = as.factor(roiB_side),
        id = as.factor(id),
        context = as.factor(context),
        visit = as.factor(visit),
        roiB = as.factor(roiB)
    )

# Remove missing data
temp.df <- temp.df %>%
    filter(complete.cases(dplyr::select(., fc, scan_age, laterality, roiA_side, internalizing_probs_T, externalizing_probs_T)))

# Initial BAM model
initial_bam <- bam(
  fc ~ s(scan_age, k = 3, fx = T) + internalizing_probs_T + laterality + roiA_side + context,
  random = list(id = ~1 + visit),
  data = temp.df,
  REML = TRUE,
  discrete = TRUE
)

# Add residuals to dataframe
temp.df <- temp.df %>%
    mutate(bam.resid = residuals(initial_bam))

# Final BAM model after removing outliers
filtered_df <- temp.df %>%
    mutate(bam.z = abs(scale(bam.resid)[, 1])) %>%
    filter(bam.z < 2)

final_bam <- bam(
  fc ~ s(scan_age, k = 3, fx = T) + internalizing_probs_T + laterality + roiA_side + context,
  random = list(id = ~1 + visit),
  data = filtered_df,
  REML = TRUE,
  discrete = TRUE
)

# Summary
model_parameters(final_bam, standardize = "refit")

```

# descriptive stats for amygdala nuclei tSNR
```{r}

roi_tsnr %>% dplyr::select(scan_id, AAA_tsnr) %>% distinct() %>% dplyr::select(AAA_tsnr) %>% drop_na(AAA_tsnr) %>% pull(AAA_tsnr) %>% mean()/2 # 180.3453

roi_tsnr %>% dplyr::select(scan_id, ABN_tsnr) %>% distinct() %>% dplyr::select(ABN_tsnr) %>% drop_na(ABN_tsnr) %>% pull(ABN_tsnr) %>% mean()/2 # 196.2225

roi_tsnr %>% dplyr::select(scan_id, BN_tsnr) %>% distinct() %>% dplyr::select(BN_tsnr) %>% drop_na(BN_tsnr) %>% pull(BN_tsnr) %>% mean()/2 # 168.2505

roi_tsnr %>% dplyr::select(scan_id, CAT_tsnr) %>% distinct() %>% dplyr::select(CAT_tsnr) %>% drop_na(CAT_tsnr) %>% pull(CAT_tsnr) %>% mean()/2 # 176.8056

roi_tsnr %>% dplyr::select(scan_id, CEN_tsnr) %>% distinct() %>% dplyr::select(CEN_tsnr) %>% drop_na(CEN_tsnr) %>% pull(CEN_tsnr) %>% mean()/2 # 208.6545

roi_tsnr %>% dplyr::select(scan_id, CON_tsnr) %>% distinct() %>% dplyr::select(CON_tsnr) %>% drop_na(CON_tsnr) %>% pull(CON_tsnr) %>% mean()/2 # 185.3408

roi_tsnr %>% dplyr::select(scan_id, LN_tsnr) %>% distinct() %>% dplyr::select(LN_tsnr) %>% drop_na(LN_tsnr) %>% pull(LN_tsnr) %>% mean()/2 # 157.4007

roi_tsnr %>% dplyr::select(scan_id, MN_tsnr) %>% distinct() %>% dplyr::select(MN_tsnr) %>% drop_na(MN_tsnr) %>% pull(MN_tsnr) %>% mean()/2 # 197.6403

roi_tsnr %>% dplyr::select(scan_id, PL_tsnr) %>% distinct() %>% dplyr::select(PL_tsnr) %>% drop_na(PL_tsnr) %>% pull(PL_tsnr) %>% mean()/2 # 124.8925

```

# psychological domain decoding analysis - 3dmean approach in adults (18+) only
```{r}
library(cifti, ciftiTools)
ciftiTools.setOption('wb_path', '/Applications/workbench')

## start by running this: /Users/amarojha/Desktop/science/papers/active/frontoamygdala/amyg7T/cognitive_mapping/full_adult_sample/generate_gii_unthresh_good_align.py (for each amygdala nucleus)

ciftiTools::run_wb_cmd("-cifti-create-dense-scalar -left-metric /Users/amarojha/Desktop/science/papers/active/frontoamygdala/amyg7T/cognitive_mapping/full_adult_sample/3dmean_amyg_maps/not_thresholded_good_align/source-Liu2019_desc-abn_map_space-fslr_den-32k_hemi-L.func.gii -right-metric /Users/amarojha/Desktop/science/papers/active/frontoamygdala/amyg7T/cognitive_mapping/full_adult_sample/3dmean_amyg_maps/not_thresholded_good_align/source-Liu2019_desc-abn_map_space-fslr_den-32k_hemi-R.func.gii /Users/amarojha/Desktop/science/papers/active/frontoamygdala/amyg7T/cognitive_mapping/full_adult_sample/3dmean_amyg_maps/not_thresholded_good_align/abn_amyg.dscalar.nii")

ciftiTools::run_wb_cmd("-cifti-parcellate /Users/amarojha/Desktop/science/papers/active/frontoamygdala/amyg7T/cognitive_mapping/full_adult_sample/3dmean_amyg_maps/not_thresholded_good_align/abn_amyg.dscalar.nii /Users/amarojha/Desktop/science/papers/active/frontoamygdala/amyg7T/cognitive_mapping/glasser_space-fsLR_den-32k_desc-atlas.dlabel.nii COLUMN /Users/amarojha/Desktop/science/papers/active/frontoamygdala/amyg7T/cognitive_mapping/full_adult_sample/3dmean_amyg_maps/not_thresholded_good_align/glasser_abn_amyg.pscalar.nii")

neurosynth.terms <- read.csv("/Users/amarojha/Desktop/science/papers/active/frontoamygdala/amyg7T/cognitive_mapping/atl-glasser360_neurosynth.csv") %>% dplyr::select(-timing) #neurosynth term meta-analytic scores for 123 terms present in both NeuroSynth and the Cognitive Atlas, ordered in lh --> rh glasser order
neurosynth.termlist <- names(neurosynth.terms) #list of terms 
# neurosynth.termlist <- neurosynth.termlist[-1]

glasser_abn_amyg_pscalar <- cifti::read_cifti("/Users/amarojha/Desktop/science/papers/active/frontoamygdala/amyg7T/cognitive_mapping/full_adult_sample/3dmean_amyg_maps/not_thresholded_good_align/glasser_abn_amyg.pscalar.nii")

glasser_abn_amyg_parcel <- data.frame(connectivity_abn = glasser_abn_amyg_pscalar$data, orig_parcelname = names(glasser_abn_amyg_pscalar$Parcel))

# Transform the variable names
glasser_abn_amyg_parcel$new_parcelname_temp <- str_replace(glasser_abn_amyg_parcel$orig_parcelname, "_ROI", "")
glasser_abn_amyg_parcel$regionName <- str_replace(glasser_abn_amyg_parcel$new_parcelname_temp, "^(.+)_(.+)$", "\\2_\\1")

glasser_abn_amyg_parcel <- glasser_abn_amyg_parcel %>% 
  dplyr::select(-orig_parcelname, -new_parcelname_temp)

# merge dataframes
abn_amyg_parcel_terms <- full_join(glasser_abn_amyg_parcel, neurosynth.terms)

neurosynth.termlist <- neurosynth.termlist[-1]

output_abn <- lapply(neurosynth.termlist, function(term){
  term.cor <- cor(abn_amyg_parcel_terms$connectivity_abn, abn_amyg_parcel_terms[,term], method = c("spearman"))
  term.results <- data.frame("term" = term, "term.correlation" = term.cor)
  return(term.results)
}
)

output_abn <- do.call(rbind, output_abn)

abn_amyg_parcel_terms_sorted <- abn_amyg_parcel_terms %>% arrange(desc(connectivity_abn))

### grabbing just the top 10% of regions with highest amygdala nuclei connectivity

# sort by connectivity values
abn_amyg_parcel_terms_sorted <- abn_amyg_parcel_terms %>% arrange(desc(connectivity_abn))
abn_amyg_parcel_terms_sorted_top36 <- abn_amyg_parcel_terms_sorted[1:36, ]

# function to run correlations 
output_abn_top36 <- lapply(neurosynth.termlist, function(term){
  term.cor <- cor(abn_amyg_parcel_terms_sorted_top36$connectivity_abn, abn_amyg_parcel_terms_sorted_top36[,term], method = c("spearman"))
  term.results <- data.frame("term" = term, "term.correlation" = term.cor)
  return(term.results)
}
)

output_abn_top36 <- do.call(rbind, output_abn_top36)

# grabbing just the top 10 terms from these with the highest positive correlations 
output_abn_top36_trimmed <- rbind(slice_max(output_abn_top36, order_by = term.correlation, n = 10))

# viz 
ggplot(output_abn_top36_trimmed, aes(x = term.correlation, y = term, color = term.correlation)) +
  geom_segment(aes(y = reorder(term, term.correlation), yend = term, x = 0, xend =  
                     term.correlation), color = "#989898", linewidth = 0.2) +
  geom_point(size = 2.2, alpha = 0.85) +
  theme_light() +
  scale_color_gradientn(colors = c("#FEC22F", "#F59A72", "#9c3a80", "#672975","#323280"), limits = c(0, 0.75)) + ggtitle("ABN") + theme(plot.title = element_text(hjust = 0.5)) 

## repeat this for all amygdala ROIs 


### combining into a single lollipop chart

output_abn_top36_trimmed$Nucleus <- c("ABN")
output_bn_top36_trimmed$Nucleus <- c("BN")
output_cat_top36_trimmed$Nucleus <- c("CAT")
output_cen_top36_trimmed$Nucleus <- c("CEN")
output_ln_top36_trimmed$Nucleus <- c("LN")

output_top36_trimmed_combined <- output_abn_top36_trimmed %>% 
  full_join(output_bn_top36_trimmed) %>% 
  full_join(output_cat_top36_trimmed) %>% 
  full_join(output_cen_top36_trimmed) %>% 
  full_join(output_ln_top36_trimmed)

setwd("/Users/amarojha/Desktop/science/r/data/amygdala_nuclei")
write.csv(output_top36_trimmed_combined, "output_top36_trimmed_combined.csv", row.names = FALSE)
  
```

# psychological domain decoding analysis - 3dlmer approach in all participants (ages 10-32)
```{r}
library(cifti, ciftiTools)
ciftiTools.setOption('wb_path', '/Applications/workbench')

## start by running this: /Users/amarojha/Desktop/science/papers/revise/frontoamygdala/amyg7T/cognitive_mapping/age_bins/generate_gii_modeled_age_bins.py

library(dplyr)
library(stringr)
library(ciftiTools)
library(cifti)

# Define parameters
base_path <- '/Users/amarojha/Desktop/science/papers/revise/frontoamygdala/amyg7T/cognitive_mapping'
output_path <- file.path(base_path, 'age_bins/3dlmer_amyg_maps/not_thresholded')
atlas_path <- file.path(base_path, 'glasser_space-fsLR_den-32k_desc-atlas.dlabel.nii')
neurosynth_csv <- file.path(base_path, 'atl-glasser360_neurosynth.csv')

# Define ROIs and age bins
rois <- c('abn', 'bn', 'cat', 'cen', 'ln')
age_bins <- 10:32  # 10 to 32 inclusive

# Read neurosynth terms once (outside the loop)
neurosynth.terms <- read.csv(neurosynth_csv) %>% 
  dplyr::select(-timing) # neurosynth term meta-analytic scores
neurosynth.termlist <- names(neurosynth.terms) # list of terms
neurosynth.termlist <- neurosynth.termlist[-1] # remove the first column (assuming it's an index)

# Container for all results
all_results <- list()

# Process each ROI and age bin
for (roi in rois) {
  for (bin_num in age_bins) {
    tryCatch({
      cat(sprintf("Processing %s%d...\n", roi, bin_num))
      
      # File paths
      left_metric <- file.path(output_path, sprintf("source-Liu2019_desc-%s%d_map_space-fslr_den-32k_hemi-L.func.gii", roi, bin_num))
      right_metric <- file.path(output_path, sprintf("source-Liu2019_desc-%s%d_map_space-fslr_den-32k_hemi-R.func.gii", roi, bin_num))
      dscalar_output <- file.path(output_path, sprintf("%s%d_amyg.dscalar.nii", roi, bin_num))
      pscalar_output <- file.path(output_path, sprintf("glasser_%s%d_amyg.pscalar.nii", roi, bin_num))
      
      # Check if input files exist
      if (!file.exists(left_metric) || !file.exists(right_metric)) {
        cat(sprintf("Missing input files for %s%d, skipping.\n", roi, bin_num))
        next
      }
      
      # 1. Create dense scalar from left and right hemisphere GIfTI files
      wb_cmd <- sprintf("-cifti-create-dense-scalar -left-metric %s -right-metric %s %s", 
                        left_metric, right_metric, dscalar_output)
      ciftiTools::run_wb_cmd(wb_cmd)
      cat(sprintf("Created dense scalar for %s%d\n", roi, bin_num))
      
      # 2. Parcellate the dense scalar using Glasser atlas
      wb_cmd <- sprintf("-cifti-parcellate %s %s COLUMN %s", 
                        dscalar_output, atlas_path, pscalar_output)
      ciftiTools::run_wb_cmd(wb_cmd)
      cat(sprintf("Parcellated %s%d\n", roi, bin_num))
      
      # 3-4. Read the parcellated scalar
      pscalar_data <- cifti::read_cifti(pscalar_output)
      parcel_df <- data.frame(
        connectivity = pscalar_data$data,
        orig_parcelname = names(pscalar_data$Parcel)
      )
      names(parcel_df)[1] <- sprintf("connectivity_%s%d", roi, bin_num)
      
      # 5. Transform parcel names
      parcel_df$new_parcelname_temp <- str_replace(parcel_df$orig_parcelname, "_ROI", "")
      parcel_df$regionName <- str_replace(parcel_df$new_parcelname_temp, "^(.+)_(.+)$", "\\2_\\1")
      parcel_df <- parcel_df %>% 
        dplyr::select(-orig_parcelname, -new_parcelname_temp)
      
      # 6. Join with neurosynth terms
      parcel_terms_df <- full_join(parcel_df, neurosynth.terms)
      
      # 7. Calculate Spearman correlations
      conn_col <- sprintf("connectivity_%s%d", roi, bin_num)
      term_results <- lapply(neurosynth.termlist, function(term) {
        term.cor <- cor(parcel_terms_df[[conn_col]], parcel_terms_df[[term]], method = "spearman")
        data.frame(term = term, term.correlation = term.cor, roi = roi, age_bin = bin_num)
      })
      
      # Combine results for this ROI and bin
      roi_bin_results <- do.call(rbind, term_results)
      
      # Add to overall results
      all_results[[sprintf("%s%d", roi, bin_num)]] <- roi_bin_results
      
      # Optionally save individual results
      write.csv(roi_bin_results, 
                file.path(output_path, sprintf("correlation_%s%d.csv", roi, bin_num)),
                row.names = FALSE)
      
      cat(sprintf("Completed correlation analysis for %s%d\n", roi, bin_num))
    }, error = function(e) {
      cat(sprintf("Error processing %s%d: %s\n", roi, bin_num, e$message))
    })
  }
}

# Combine all results
final_results <- do.call(rbind, all_results)

# Save combined results
write.csv(final_results, 
          file.path(output_path, "all_roi_age_bin_correlations_3dlmer.csv"),
          row.names = FALSE)

cat("Analysis complete. Results saved to all_roi_age_bin_correlations_3dlmer.csv\n")

```

# figure 1: participant demographics
```{r}
# part of figure 1:

df_mini <- amygdala_nuclei_7T %>% 
  dplyr::select(id, scan_age, sex) %>% 
  rename(age = scan_age) %>% 
  drop_na(id, age, sex) %>%
  unique() 

LNCDR::waterfall_plot(d = df_mini, aes(fill = sex))

age_ranked <- LNCDR::waterfall_group(df_mini %>% dplyr::select(age=age, id=id, sex=sex))

gp_waterfall <- lunaize(
  ggplot(age_ranked) + aes(x = age, y = age_id, group = age_id) + 
    geom_line() + geom_point(aes(color=sex))
   ) + ylab("Participant") + xlab("Age") + 
  theme(legend.position=c(.1,.9), legend.title=element_blank(), 
        axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0)))

```

# figure 2: age effects
```{r}
## figure 2, panel A
# Data preparation
temp.df <- amygdala_nuclei_7T %>%
  dplyr::select(id, visit, roiA, roiB, roiA_side, roiB_side, laterality, context, scan_age, fc) %>% 
  filter(
    (roiA %in% c("antvmpfc", "vlpfc") & roiB == "CEN") |
    (roiB %in% c("antvmpfc", "vlpfc") & roiA == "CEN")
  ) %>%
  distinct() %>%
  mutate(
    laterality = as.factor(laterality),
    roiA_side = as.factor(roiA_side),
    roiB_side = as.factor(roiB_side),
    id = as.factor(id),
    context = as.factor(context),
    visit = as.factor(visit),
    roiA = as.factor(roiA),
    roiB = as.factor(roiB),
    connection_type = case_when(
      (roiA == "antvmpfc" & roiB == "CEN") | (roiB == "antvmpfc" & roiA == "CEN") ~ "antvmpfc_CEN",
      (roiA == "vlpfc" & roiB == "CEN") | (roiB == "vlpfc" & roiA == "CEN") ~ "vlpfc_CEN",
      TRUE ~ NA_character_
    )
  ) %>%
  mutate(connection_type = as.factor(connection_type))

# Remove incomplete cases
temp.df <- temp.df %>%
    filter(complete.cases(dplyr::select(., fc, scan_age, laterality, roiA_side)))

# Initial BAM model
initial_bam <- bam(
    fc ~ s(scan_age, k = 3, fx = T, by = connection_type) + connection_type + laterality + roiA_side + context,
    random = list(id = ~1 + visit),
    data = temp.df,
    REML = TRUE,
    discrete = TRUE
)

# Add residuals to dataframe
temp.df <- temp.df %>%
    mutate(bam.resid = residuals(initial_bam))

# Final BAM model after removing outliers
filtered_df <- temp.df %>%
    mutate(bam.z = abs(scale(bam.resid)[, 1])) %>%
    filter(bam.z < 2)

final_bam_CEN <- bam(
    fc ~ s(scan_age, k = 3, fx = T, by = connection_type) + connection_type + laterality + roiA_side + context,
    random = list(id = ~1 + visit),
    data = filtered_df,
    REML = TRUE,
    discrete = TRUE
)

## figure 2, panel B
# Data preparation
temp.df <- amygdala_nuclei_7T %>%
  dplyr::select(id, visit, roiA, roiB, roiA_side, roiB_side, laterality, context, scan_age, fc) %>% 
  filter(
    (roiA %in% c("dlpfc", "vlpfc") & roiB == "LN") |
    (roiB %in% c("dlpfc", "vlpfc") & roiA == "LN")
  ) %>%
  distinct() %>%
  mutate(
    laterality = as.factor(laterality),
    roiA_side = as.factor(roiA_side),
    roiB_side = as.factor(roiB_side),
    id = as.factor(id),
    context = as.factor(context),
    visit = as.factor(visit),
    roiA = as.factor(roiA),
    roiB = as.factor(roiB),
    connection_type = case_when(
      (roiA == "dlpfc" & roiB == "LN") | (roiB == "dlpfc" & roiA == "LN") ~ "dlpfc_LN",
      (roiA == "vlpfc" & roiB == "LN") | (roiB == "vlpfc" & roiA == "LN") ~ "vlpfc_LN",
      TRUE ~ NA_character_
    )
  ) %>%
  mutate(connection_type = as.factor(connection_type))

# Remove incomplete cases
temp.df <- temp.df %>%
    filter(complete.cases(dplyr::select(., fc, scan_age, laterality, roiA_side)))

# Initial BAM model
initial_bam <- bam(
    fc ~ s(scan_age, k = 3, fx = T, by = connection_type) + connection_type + laterality + roiA_side + context,
    random = list(id = ~1 + visit),
    data = temp.df,
    REML = TRUE,
    discrete = TRUE
)

# Add residuals to dataframe
temp.df <- temp.df %>%
    mutate(bam.resid = residuals(initial_bam))

# Final BAM model after removing outliers
filtered_df <- temp.df %>%
    mutate(bam.z = abs(scale(bam.resid)[, 1])) %>%
    filter(bam.z < 2)

final_bam_LN <- bam(
    fc ~ s(scan_age, k = 3, fx = T, by = connection_type) + connection_type + laterality + roiA_side + context,
    random = list(id = ~1 + visit),
    data = filtered_df,
    REML = TRUE,
    discrete = TRUE
)

## figure 2, panel C
# Data preparation
temp.df <- amygdala_nuclei_7T %>%
  dplyr::select(id, visit, roiA, roiB, roiA_side, roiB_side, laterality, context, scan_age, fc) %>% 
  filter(
    (roiA %in% c("racc", "sgacc", "vacc") & roiB == "CAT") |
    (roiB %in% c("racc", "sgacc", "vacc") & roiA == "CAT")
  ) %>%
  distinct() %>%
  mutate(
    laterality = as.factor(laterality),
    roiA_side = as.factor(roiA_side),
    roiB_side = as.factor(roiB_side),
    id = as.factor(id),
    context = as.factor(context),
    visit = as.factor(visit),
    roiA = as.factor(roiA),
    roiB = as.factor(roiB),
    connection_type = case_when(
      (roiA == "racc" & roiB == "CAT") | (roiB == "racc" & roiA == "CAT") ~ "racc_CAT",
      (roiA == "sgacc" & roiB == "CAT") | (roiB == "sgacc" & roiA == "CAT") ~ "sgacc_CAT",
      (roiA == "vacc" & roiB == "CAT") | (roiB == "vacc" & roiA == "CAT") ~ "vacc_CAT",
      TRUE ~ NA_character_
    )
  ) %>%
  mutate(connection_type = as.factor(connection_type))

# Remove incomplete cases
temp.df <- temp.df %>%
    filter(complete.cases(dplyr::select(., fc, scan_age, laterality, roiA_side)))

# Initial BAM model
initial_bam <- bam(
    fc ~ s(scan_age, k = 3, fx = T, by = connection_type) + connection_type + laterality + roiA_side + context,
    random = list(id = ~1 + visit),
    data = temp.df,
    REML = TRUE,
    discrete = TRUE
)

# Add residuals to dataframe
temp.df <- temp.df %>%
    mutate(bam.resid = residuals(initial_bam))

# Final BAM model after removing outliers
filtered_df <- temp.df %>%
    mutate(bam.z = abs(scale(bam.resid)[, 1])) %>%
    filter(bam.z < 2)

final_bam_CAT <- bam(
    fc ~ s(scan_age, k = 3, fx = T, by = connection_type) + connection_type + laterality + roiA_side + context,
    random = list(id = ~1 + visit),
    data = filtered_df,
    REML = TRUE,
    discrete = TRUE
)

## figure 2, panel D
# Data preparation
temp.df <- amygdala_nuclei_7T %>%
  dplyr::select(id, visit, roiA, roiB, roiA_side, roiB_side, laterality, context, scan_age, fc) %>% 
  filter(
    (roiA %in% c("dlpfc") & roiB == "BN") |
    (roiB %in% c("dlpfc") & roiA == "BN")
  ) %>%
  distinct() %>%
  mutate(
    laterality = as.factor(laterality),
    roiA_side = as.factor(roiA_side),
    roiB_side = as.factor(roiB_side),
    id = as.factor(id),
    context = as.factor(context),
    visit = as.factor(visit),
    roiA = as.factor(roiA),
    roiB = as.factor(roiB)) 

# Remove incomplete cases
temp.df <- temp.df %>%
    filter(complete.cases(dplyr::select(., fc, scan_age, laterality, roiA_side)))

# Initial BAM model
initial_bam <- bam(
    fc ~ s(scan_age, k = 3, fx = T) + laterality + roiA_side + context,
    random = list(id = ~1 + visit),
    data = temp.df,
    REML = TRUE,
    discrete = TRUE
)

# Add residuals to dataframe
temp.df <- temp.df %>%
    mutate(bam.resid = residuals(initial_bam))

# Final BAM model after removing outliers
filtered_df <- temp.df %>%
    mutate(bam.z = abs(scale(bam.resid)[, 1])) %>%
    filter(bam.z < 2)

final_bam_BN <- bam(
    fc ~ s(scan_age, k = 3, fx = T) + laterality + roiA_side + context,
    random = list(id = ~1 + visit),
    data = filtered_df,
    REML = TRUE,
    discrete = TRUE
)

# Viz with custom colours for each connection_type
fig2_panela <- ggeffects::ggpredict(final_bam_CEN, terms = c("scan_age", "connection_type")) %>% 
  ggplot(aes(
    x        = x, 
    y        = predicted,
    group    = group,
    linetype = group,
    colour   = group,
    fill      = group
  )) +
  geom_line(size = 1) +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high), alpha = 0.2, colour = NA) +
  scale_colour_manual(
    values = c(
      antvmpfc_CEN = "#1C3A23",
      vlpfc_CEN    = "#0C4740"
    )
  ) +
  scale_fill_manual(
    values = c(
      antvmpfc_CEN = "#1C3A23",
      vlpfc_CEN    = "#0C4740"
    )
  ) +
  theme_modern(axis.title.space = 0.5, plot.title.space = 0.5) +
  xlab("Age (Years)") +
  ylab("Functional Connectivity") + 
  ggtitle("Central Nucleus") +
  theme(
    plot.title      = element_text(hjust = 0.6),
    legend.position = "none"
  ) +
  coord_cartesian(ylim = c(-.2, .2))

# Viz with custom colours for dlpfc_LN and vlpfc_LN
fig2_panelb <- ggeffects::ggpredict(final_bam_LN, terms = c("scan_age", "connection_type")) %>% 
  ggplot(aes(
    x        = x, 
    y        = predicted,
    group    = group,
    linetype = group,
    colour   = group,
    fill     = group
  )) +
  geom_line(size = 1) +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high), alpha = 0.2, colour = NA) +
  scale_colour_manual(
    values = c(
      dlpfc_LN = "#1A4C64",
      vlpfc_LN = "#364D7E"
    )
  ) +
  scale_fill_manual(
    values = c(
      dlpfc_LN = "#1A4C64",
      vlpfc_LN = "#364D7E"
    )
  ) +
  theme_modern(axis.title.space = 0.5, plot.title.space = 0.5) +
  xlab("Age (Years)") +
  ylab("Functional Connectivity") + 
  ggtitle("Lateral Nucleus") +
  theme(
    plot.title      = element_text(hjust = 0.6),
    legend.position = "none"
  ) +
  coord_cartesian(ylim = c(-.2, .2))

# Viz with custom colours for racc_CAT, vacc_CAT, and sgacc_CAT
fig2_panelc <- ggeffects::ggpredict(final_bam_CAT, terms = c("scan_age", "connection_type")) %>% 
  ggplot(aes(
    x        = x, 
    y        = predicted,
    group    = group,
    linetype = group,
    colour   = group,
    fill     = group
  )) +
  geom_line(size = 1) +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high), alpha = 0.2, colour = NA) +
  scale_colour_manual(
    values = c(
      racc_CAT  = "#594F89",
      vacc_CAT  = "#835689",
      sgacc_CAT = "#B16787"
    )
  ) +
  scale_fill_manual(
    values = c(
      racc_CAT  = "#594F89",
      vacc_CAT  = "#835689",
      sgacc_CAT = "#B16787"
    )
  ) +
  theme_modern(axis.title.space = 0.5, plot.title.space = 0.5) +
  xlab("Age (Years)") +
  ylab("Functional Connectivity") + 
  ggtitle("Corticoamygdaloid Transition Area") +
  theme(
    plot.title      = element_text(hjust = 0.6),
    legend.position = "none"
  ) +
  coord_cartesian(ylim = c(-.2, .2))

# Viz for BN with custom colour #1e3011
fig2_paneld <- ggeffects::ggpredict(final_bam_BN, terms = c("scan_age")) %>% 
  ggplot(aes(
    x     = x, 
    y     = predicted,
    group = group
  )) +
  geom_line(color = "#DE8787", size = 1) +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high), 
              fill   = "#DE8787", 
              alpha  = 0.2, 
              colour = NA) +
  theme_modern(axis.title.space = 0.5, plot.title.space = 0.5) +
  xlab("Age (Years)") +
  ylab("Functional Connectivity") + 
  ggtitle("Basal Nucleus") +
  theme(
    plot.title      = element_text(hjust = 0.6),
    legend.position = "none"
  ) +
  coord_cartesian(ylim = c(-.2, .2))


### combining into single figure:

combined_fig <- ggarrange(fig2_panela, fig2_panelb, fig2_panelc, fig2_paneld,
                          labels = c("A", "B", "C", "D"),
                          # top = "Age-Related Development of Fronto-Amygdala Circuitry",
                          ncol = 2, nrow = 2,
                          align = "hv")

# Print the combined figure
print(combined_fig)

## manually added figure legend to denote PFC subregions for each panel

### graphical abstract bit ###

# Viz with custom colours for each connection_type
fig2_panela <- ggeffects::ggpredict(final_bam_CEN, terms = c("scan_age", "connection_type")) %>% 
  ggplot(aes(
    x        = x, 
    y        = predicted,
    group    = group,
    linetype = group,
    colour   = group,
    fill      = group
  )) +
  geom_line(size = 2) +
  # geom_ribbon(aes(ymin = conf.low, ymax = conf.high), alpha = 0.2, colour = NA) +
  scale_colour_manual(
    values = c(
      antvmpfc_CEN = "#1C3A23",
      vlpfc_CEN    = "#0C4740"
    )
  ) +
  scale_fill_manual(
    values = c(
      antvmpfc_CEN = "#1C3A23",
      vlpfc_CEN    = "#0C4740"
    )
  ) +
  theme_modern(axis.title.space = 0.5, plot.title.space = 0.5) +
  xlab("Age") +
  ylab("Functional Connectivity") + 
  # ggtitle("Central Nucleus") +
  theme(
    plot.title      = element_text(hjust = 0.6),
    legend.position = "none"
  ) +
  coord_cartesian(ylim = c(-.2, .2)) +
  scale_x_continuous(breaks = seq(10, 30, by = 10)) +
  scale_y_continuous(breaks = seq(-0.2, 0.2, by = 0.2))

# Viz with custom colours for dlpfc_LN and vlpfc_LN
fig2_panelb <- ggeffects::ggpredict(final_bam_LN, terms = c("scan_age", "connection_type")) %>% 
  ggplot(aes(
    x        = x, 
    y        = predicted,
    group    = group,
    linetype = group,
    colour   = group,
    fill     = group
  )) +
  geom_line(size = 2) +
  # geom_ribbon(aes(ymin = conf.low, ymax = conf.high), alpha = 0.2, colour = NA) +
  scale_colour_manual(
    values = c(
      dlpfc_LN = "#1A4C64",
      vlpfc_LN = "#364D7E"
    )
  ) +
  scale_fill_manual(
    values = c(
      dlpfc_LN = "#1A4C64",
      vlpfc_LN = "#364D7E"
    )
  ) +
  theme_modern(axis.title.space = 0.5, plot.title.space = 0.5) +
  xlab("Age") +
  ylab("Functional Connectivity") + 
  # ggtitle("Lateral Nucleus") +
  theme(
    plot.title      = element_text(hjust = 0.6),
    legend.position = "none"
  ) +
  coord_cartesian(ylim = c(-.2, .2)) +
  scale_x_continuous(breaks = seq(10, 30, by = 10)) +
  scale_y_continuous(breaks = seq(-0.2, 0.2, by = 0.2))

# Viz with custom colours for racc_CAT, vacc_CAT, and sgacc_CAT
fig2_panelc <- ggeffects::ggpredict(final_bam_CAT, terms = c("scan_age", "connection_type")) %>% 
  ggplot(aes(
    x        = x, 
    y        = predicted,
    group    = group,
    linetype = group,
    colour   = group,
    fill     = group
  )) +
  geom_line(size = 2) +
  # geom_ribbon(aes(ymin = conf.low, ymax = conf.high), alpha = 0.2, colour = NA) +
  scale_colour_manual(
    values = c(
      racc_CAT  = "#594F89",
      vacc_CAT  = "#835689",
      sgacc_CAT = "#B16787"
    )
  ) +
  scale_fill_manual(
    values = c(
      racc_CAT  = "#594F89",
      vacc_CAT  = "#835689",
      sgacc_CAT = "#B16787"
    )
  ) +
  theme_modern(axis.title.space = 0.5, plot.title.space = 0.5) +
  xlab("Age") +
  ylab("Functional Connectivity") + 
  # ggtitle("Corticoamygdaloid Transition Area") +
  theme(
    plot.title      = element_text(hjust = 0.6),
    legend.position = "none"
  ) +
  coord_cartesian(ylim = c(-.2, .2)) +
  scale_x_continuous(breaks = seq(10, 30, by = 10)) +
  scale_y_continuous(breaks = seq(-0.2, 0.2, by = 0.2))

# Viz for BN with custom colour #1e3011
fig2_paneld <- ggeffects::ggpredict(final_bam_BN, terms = c("scan_age")) %>% 
  ggplot(aes(
    x     = x, 
    y     = predicted,
    group = group
  )) +
  geom_line(color = "#DE8787", size = 2) +
  # geom_ribbon(aes(ymin = conf.low, ymax = conf.high), 
  #             fill   = "#DE8787", 
  #             alpha  = 0.2, 
  #             colour = NA) +
  theme_modern(axis.title.space = 0.5, plot.title.space = 0.5) +
  xlab("Age") +
  ylab("Functional Connectivity") + 
  # ggtitle("Basal Nucleus") +
  theme(
    plot.title      = element_text(hjust = 0.6),
    legend.position = "none"
  ) +
  coord_cartesian(ylim = c(-.2, .2)) +
  scale_x_continuous(breaks = seq(10, 30, by = 10)) +
  scale_y_continuous(breaks = seq(-0.2, 0.2, by = 0.2))

ggarrange(fig2_panela, fig2_panelb, fig2_panelc, fig2_paneld,
                          # top = "Age-Related Development of Fronto-Amygdala Circuitry",
                          ncol = 4, nrow = 1,
                          align = "hv")

```

# figure 3: brain-behavior associations 
```{r}
library(ggplot2)
library(dplyr)
library(cowplot)
library(sjPlot)
library(mgcv)
library(ggeffects)
library(grid)
library(gridExtra)


# -------- DATA PREPARATION FOR EACH ROI PAIR --------

# 1. ant vmPFC - CEN and Internalizing
temp.df <- amygdala_nuclei_7T %>%
    filter(roiA %in% c("antvmpfc", "CEN"), roiB %in% c("antvmpfc", "CEN"), roiA != roiB) %>%
    distinct() %>%
    mutate(
        laterality = as.factor(laterality),
        roiA_side = as.factor(roiA_side),
        roiB_side = as.factor(roiB_side),
        id = as.factor(id),
        context = as.factor(context),
        visit = as.factor(visit),
        roiB = as.factor(roiB)
    )

# Remove missing data
temp.df <- temp.df %>%
    filter(complete.cases(dplyr::select(., fc, scan_age, laterality, roiA_side, internalizing_probs_T, externalizing_probs_T)))

# Initial BAM model
initial_bam <- bam(
  fc ~ s(scan_age, k = 3, fx = T) + internalizing_probs_T + laterality + roiA_side + context,
  random = list(id = ~1 + visit),
  data = temp.df,
  REML = TRUE,
  discrete = TRUE
)

# Add residuals to dataframe
temp.df <- temp.df %>%
    mutate(bam.resid = residuals(initial_bam))

# Final BAM model after removing outliers
filtered_df <- temp.df %>%
    mutate(bam.z = abs(scale(bam.resid)[, 1])) %>%
    filter(bam.z < 2)

final_bam_antvmpfc_CEN_int <- bam(
  fc ~ s(scan_age, k = 3, fx = T) + internalizing_probs_T + laterality + roiA_side + context,
  random = list(id = ~1 + visit),
  data = filtered_df,
  REML = TRUE,
  discrete = TRUE
)

# 2. vACC - CAT and Internalizing
temp.df <- amygdala_nuclei_7T %>%
    filter(roiA %in% c("vacc", "CAT"), roiB %in% c("vacc", "CAT"), roiA != roiB) %>%
    distinct() %>%
    mutate(
        laterality = as.factor(laterality),
        roiA_side = as.factor(roiA_side),
        roiB_side = as.factor(roiB_side),
        id = as.factor(id),
        context = as.factor(context),
        visit = as.factor(visit),
        roiB = as.factor(roiB)
    )

# Remove missing data
temp.df <- temp.df %>%
    filter(complete.cases(dplyr::select(., fc, scan_age, laterality, roiA_side, internalizing_probs_T, externalizing_probs_T)))

# Initial BAM model
initial_bam <- bam(
  fc ~ s(scan_age, k = 3, fx = T) + internalizing_probs_T + laterality + roiA_side + context,
  random = list(id = ~1 + visit),
  data = temp.df,
  REML = TRUE,
  discrete = TRUE
)

# Add residuals to dataframe
temp.df <- temp.df %>%
    mutate(bam.resid = residuals(initial_bam))

# Final BAM model after removing outliers
filtered_df <- temp.df %>%
    mutate(bam.z = abs(scale(bam.resid)[, 1])) %>%
    filter(bam.z < 2)

final_bam_vacc_CAT_int <- bam(
  fc ~ s(scan_age, k = 3, fx = T) + internalizing_probs_T + laterality + roiA_side + context,
  random = list(id = ~1 + visit),
  data = filtered_df,
  REML = TRUE,
  discrete = TRUE
)

# 3. sgACC - CAT and Externalizing
temp.df <- amygdala_nuclei_7T %>%
    filter(roiA %in% c("sgacc", "CAT"), roiB %in% c("sgacc", "CAT"), roiA != roiB) %>%
    distinct() %>%
    mutate(
        laterality = as.factor(laterality),
        roiA_side = as.factor(roiA_side),
        roiB_side = as.factor(roiB_side),
        id = as.factor(id),
        context = as.factor(context),
        visit = as.factor(visit),
        roiB = as.factor(roiB)
    )

# Remove missing data
temp.df <- temp.df %>%
    filter(complete.cases(dplyr::select(., fc, scan_age, laterality, roiA_side, internalizing_probs_T, externalizing_probs_T)))

# Initial BAM model
initial_bam <- bam(
  fc ~ s(scan_age, k = 3, fx = T) + externalizing_probs_T + laterality + roiA_side + context,
  random = list(id = ~1 + visit),
  data = temp.df,
  REML = TRUE,
  discrete = TRUE
)

# Add residuals to dataframe
temp.df <- temp.df %>%
    mutate(bam.resid = residuals(initial_bam))

# Final BAM model after removing outliers
filtered_df <- temp.df %>%
    mutate(bam.z = abs(scale(bam.resid)[, 1])) %>%
    filter(bam.z < 2)

final_bam_sgacc_CAT_ext <- bam(
  fc ~ s(scan_age, k = 3, fx = T) + externalizing_probs_T + laterality + roiA_side + context,
  random = list(id = ~1 + visit),
  data = filtered_df,
  REML = TRUE,
  discrete = TRUE
)

# 4. sgACC - CAT and DERS
temp.df <- amygdala_nuclei_7T %>%
    filter(roiA %in% c("sgacc", "CAT"), roiB %in% c("sgacc", "CAT"), roiA != roiB) %>%
    distinct() %>%
    mutate(
        laterality = as.factor(laterality),
        roiA_side = as.factor(roiA_side),
        roiB_side = as.factor(roiB_side),
        id = as.factor(id),
        context = as.factor(context),
        visit = as.factor(visit),
        roiB = as.factor(roiB)
    )

# Remove missing data
temp.df <- temp.df %>%
    filter(complete.cases(dplyr::select(., fc, scan_age, laterality, roiA_side, ders_total)))

# Initial BAM model
initial_bam <- bam(
  fc ~ s(scan_age, k = 3, fx = T) + ders_total + laterality + roiA_side + context,
  random = list(id = ~1 + visit),
  data = temp.df,
  REML = TRUE,
  discrete = TRUE
)

# Add residuals to dataframe
temp.df <- temp.df %>%
    mutate(bam.resid = residuals(initial_bam))

# Final BAM model after removing outliers
filtered_df <- temp.df %>%
    mutate(bam.z = abs(scale(bam.resid)[, 1])) %>%
    filter(bam.z < 2)

final_bam_sgacc_CAT_ders <- bam(
  fc ~ s(scan_age, k = 3, fx = T) + ders_total + laterality + roiA_side + context,
  random = list(id = ~1 + visit),
  data = filtered_df,
  REML = TRUE,
  discrete = TRUE
)

# 5. rACC - CAT and DERS
temp.df <- amygdala_nuclei_7T %>%
    filter(roiA %in% c("racc", "CAT"), roiB %in% c("racc", "CAT"), roiA != roiB) %>%
    distinct() %>%
    mutate(
        laterality = as.factor(laterality),
        roiA_side = as.factor(roiA_side),
        roiB_side = as.factor(roiB_side),
        id = as.factor(id),
        context = as.factor(context),
        visit = as.factor(visit),
        roiB = as.factor(roiB)
    )

# Remove missing data
temp.df <- temp.df %>%
    filter(complete.cases(dplyr::select(., fc, scan_age, laterality, roiA_side, ders_total)))

# Initial BAM model
initial_bam <- bam(
  fc ~ s(scan_age, k = 3, fx = T) + ders_total + laterality + roiA_side + context,
  random = list(id = ~1 + visit),
  data = temp.df,
  REML = TRUE,
  discrete = TRUE
)

# Add residuals to dataframe
temp.df <- temp.df %>%
    mutate(bam.resid = residuals(initial_bam))

# Final BAM model after removing outliers
filtered_df <- temp.df %>%
    mutate(bam.z = abs(scale(bam.resid)[, 1])) %>%
    filter(bam.z < 2)

final_bam_racc_CAT_ders <- bam(
  fc ~ s(scan_age, k = 3, fx = T) + ders_total + laterality + roiA_side + context,
  random = list(id = ~1 + visit),
  data = filtered_df,
  REML = TRUE,
  discrete = TRUE
)

# 6. dlPFC - LN and DERS
temp.df <- amygdala_nuclei_7T %>%
    filter(roiA %in% c("dlpfc", "LN"), roiB %in% c("dlpfc", "LN"), roiA != roiB) %>%
    distinct() %>%
    mutate(
        laterality = as.factor(laterality),
        roiA_side = as.factor(roiA_side),
        roiB_side = as.factor(roiB_side),
        id = as.factor(id),
        context = as.factor(context),
        visit = as.factor(visit),
        roiB = as.factor(roiB)
    )

# Remove missing data
temp.df <- temp.df %>%
    filter(complete.cases(dplyr::select(., fc, scan_age, laterality, roiA_side, ders_total)))

# Initial BAM model
initial_bam <- bam(
  fc ~ s(scan_age, k = 3, fx = T) + ders_total + laterality + roiA_side + context,
  random = list(id = ~1 + visit),
  data = temp.df,
  REML = TRUE,
  discrete = TRUE
)

# Add residuals to dataframe
temp.df <- temp.df %>%
    mutate(bam.resid = residuals(initial_bam))

# Final BAM model after removing outliers
filtered_df <- temp.df %>%
    mutate(bam.z = abs(scale(bam.resid)[, 1])) %>%
    filter(bam.z < 2)

final_bam_dlpfc_LN_ders <- bam(
  fc ~ s(scan_age, k = 3, fx = T) + ders_total + laterality + roiA_side + context,
  random = list(id = ~1 + visit),
  data = filtered_df,
  REML = TRUE,
  discrete = TRUE
)

# 7. sgACC - CAT and MGS Accuracy Variability
temp.df <- amygdala_nuclei_7T %>%
    filter(roiA %in% c("sgacc", "CAT"), roiB %in% c("sgacc", "CAT"), roiA != roiB) %>%
    distinct() %>%
    mutate(
        laterality = as.factor(laterality),
        roiA_side = as.factor(roiA_side),
        roiB_side = as.factor(roiB_side),
        id = as.factor(id),
        context = as.factor(context),
        visit = as.factor(visit),
        roiB = as.factor(roiB)
    )

# Remove missing data
temp.df <- temp.df %>%
    filter(complete.cases(dplyr::select(., fc, scan_age, laterality, roiA_side, mgs_acc_var)))

# Initial BAM model
initial_bam <- bam(
  fc ~ s(scan_age, k = 3, fx = T) + mgs_acc_var + laterality + roiA_side + context,
  random = list(id = ~1 + visit),
  data = temp.df,
  REML = TRUE,
  discrete = TRUE
)

# Add residuals to dataframe
temp.df <- temp.df %>%
    mutate(bam.resid = residuals(initial_bam))

# Final BAM model after removing outliers
filtered_df <- temp.df %>%
    mutate(bam.z = abs(scale(bam.resid)[, 1])) %>%
    filter(bam.z < 2)

final_bam_sgacc_CAT_mgsaccvar <- bam(
  fc ~ s(scan_age, k = 3, fx = T) + mgs_acc_var + laterality + roiA_side + context,
  random = list(id = ~1 + visit),
  data = filtered_df,
  REML = TRUE,
  discrete = TRUE
)

# 8. ant vmPFC - CEN and MGS Latency
temp.df <- amygdala_nuclei_7T %>%
    filter(roiA %in% c("antvmpfc", "CEN"), roiB %in% c("antvmpfc", "CEN"), roiA != roiB) %>%
    distinct() %>%
    mutate(
        laterality = as.factor(laterality),
        roiA_side = as.factor(roiA_side),
        roiB_side = as.factor(roiB_side),
        id = as.factor(id),
        context = as.factor(context),
        visit = as.factor(visit),
        roiB = as.factor(roiB)
    )

# Remove missing data
temp.df <- temp.df %>%
    filter(complete.cases(dplyr::select(., fc, scan_age, laterality, roiA_side, mgs_lat)))

# Initial BAM model
initial_bam <- bam(
  fc ~ s(scan_age, k = 3, fx = T) + mgs_lat + laterality + roiA_side + context,
  random = list(id = ~1 + visit),
  data = temp.df,
  REML = TRUE,
  discrete = TRUE
)

# Add residuals to dataframe
temp.df <- temp.df %>%
    mutate(bam.resid = residuals(initial_bam))

# Final BAM model after removing outliers
filtered_df <- temp.df %>%
    mutate(bam.z = abs(scale(bam.resid)[, 1])) %>%
    filter(bam.z < 2)

final_bam_antvmpfc_CEN_mgslat <- bam(
  fc ~ s(scan_age, k = 3, fx = T) + mgs_lat + laterality + roiA_side + context,
  random = list(id = ~1 + visit),
  data = filtered_df,
  REML = TRUE,
  discrete = TRUE
)

# 9. dlPFC - LN and MGS Latency
temp.df <- amygdala_nuclei_7T %>%
    filter(roiA %in% c("dlpfc", "LN"), roiB %in% c("dlpfc", "LN"), roiA != roiB) %>%
    distinct() %>%
    mutate(
        laterality = as.factor(laterality),
        roiA_side = as.factor(roiA_side),
        roiB_side = as.factor(roiB_side),
        id = as.factor(id),
        context = as.factor(context),
        visit = as.factor(visit),
        roiB = as.factor(roiB)
    )

# Remove missing data
temp.df <- temp.df %>%
    filter(complete.cases(dplyr::select(., fc, scan_age, laterality, roiA_side, mgs_lat)))

# Initial BAM model
initial_bam <- bam(
  fc ~ s(scan_age, k = 3, fx = T) + mgs_lat + laterality + roiA_side + context,
  random = list(id = ~1 + visit),
  data = temp.df,
  REML = TRUE,
  discrete = TRUE
)

# Add residuals to dataframe
temp.df <- temp.df %>%
    mutate(bam.resid = residuals(initial_bam))

# Final BAM model after removing outliers
filtered_df <- temp.df %>%
    mutate(bam.z = abs(scale(bam.resid)[, 1])) %>%
    filter(bam.z < 2)

final_bam_dlpfc_LN_mgslat <- bam(
  fc ~ s(scan_age, k = 3, fx = T) + mgs_lat + laterality + roiA_side + context,
  random = list(id = ~1 + visit),
  data = filtered_df,
  REML = TRUE,
  discrete = TRUE
)

# 10. vlPFC - LN and MGS Latency Variability
temp.df <- amygdala_nuclei_7T %>%
    filter(roiA %in% c("vlpfc", "LN"), roiB %in% c("vlpfc", "LN"), roiA != roiB) %>%
    distinct() %>%
    mutate(
        laterality = as.factor(laterality),
        roiA_side = as.factor(roiA_side),
        roiB_side = as.factor(roiB_side),
        id = as.factor(id),
        context = as.factor(context),
        visit = as.factor(visit),
        roiB = as.factor(roiB)
    )

# Remove missing data
temp.df <- temp.df %>%
    filter(complete.cases(dplyr::select(., fc, scan_age, laterality, roiA_side, mgs_lat_var)))

# Initial BAM model
initial_bam <- bam(
  fc ~ s(scan_age, k = 3, fx = T) + mgs_lat_var + laterality + roiA_side + context,
  random = list(id = ~1 + visit),
  data = temp.df,
  REML = TRUE,
  discrete = TRUE
)

# Add residuals to dataframe
temp.df <- temp.df %>%
    mutate(bam.resid = residuals(initial_bam))

# Final BAM model after removing outliers
filtered_df <- temp.df %>%
    mutate(bam.z = abs(scale(bam.resid)[, 1])) %>%
    filter(bam.z < 2)

final_bam_vlpfc_LN_mgslatvar <- bam(
  fc ~ s(scan_age, k = 3, fx = T) + mgs_lat_var + laterality + roiA_side + context,
  random = list(id = ~1 + visit),
  data = filtered_df,
  REML = TRUE,
  discrete = TRUE
)


###################################
######### visualizations ##########
###################################

y_limits <- c(-0.4, 0.5)

uniform_plot <- function(model, term, title, color = "#4884B6", x_label = NULL, 
                         y_label = "Functional Connectivity", annotation = NULL) {
  p <- plot_model(
    model, 
    type = "pred", 
    terms = c(term),
    show.data = TRUE,
    dot.size = 0.5,
    dot.alpha = 0.25,
    line.size = 1.0,
    colors = color,
    title = title
  ) +
    ylab(y_label) +
    {if (!is.null(x_label)) xlab(x_label) else xlab("")} +
    coord_fixed(ratio = diff(range(get_model_data(model, type = "pred", terms = c(term))$x)) / 
                       diff(y_limits),
                ylim = y_limits) +
    {if (!is.null(annotation)) 
      annotate("text", x = -Inf, y = -Inf, label = annotation, 
               hjust = -0.1, vjust = -0.8, size = 3, parse = TRUE)
     else theme()} +
    theme_void() +
    theme(
      panel.border = element_rect(color = "black", fill = NA, size = 1),
      panel.grid.minor = element_blank(),
      panel.grid.major = element_blank(),
      plot.title = element_text(size = 14, hjust = 0.5, margin = margin(b = 2, t = 20)),
      axis.text = element_text(size = 12, color = "black"),
      axis.title = element_text(size = 12),
      axis.title.x = element_text(margin = margin(t = 5)),
      axis.title.y = element_text(margin = margin(r = 5), angle = 90, vjust = 0.5, hjust = 0.5),
      plot.margin = margin(t = 2, r = 2, b = 25, l = 2),
      legend.position = "none",
      axis.ticks = element_line(color = "black"),
      axis.ticks.length = unit(0.25, "cm")
    )
  p <- p + theme(
    panel.border = element_rect(color = "black", fill = NA, size = 1)  # Set uniform border size
  )
  return(p)
}


### CMA nuclei ###

antvmpfc_CEN_int <- uniform_plot(
  final_bam_antvmpfc_CEN_int, 
  "internalizing_probs_T", 
  "ant. vmPFC - CEN",
  "#1C3A23",
  "Internalizing Behaviors (T-score)",
  annotation = annotations$A
)

antvmpfc_CEN_mgslat <- uniform_plot(
  final_bam_antvmpfc_CEN_mgslat, 
  "mgs_lat", 
  "ant. vmPFC - CEN",
  "#1C3A23",
  "MGS Correct Trial Latency (s)",
  annotation = annotations$H
)

### BLA nuclei ###

dlpfc_LN_ders <- uniform_plot(
  final_bam_dlpfc_LN_ders, 
  "ders_total", 
  "dlPFC - LN",
  "#1A4C64",
  "Difficulties in Emotion Regulation",
  annotation = annotations$F
)

dlpfc_LN_mgslat <- uniform_plot(
  final_bam_dlpfc_LN_mgslat, 
  "mgs_lat", 
  "dlPFC - LN",
  "#1A4C64",
  "MGS Correct Trial Latency (s)",
  annotation = annotations$I
)

vlpfc_LN_mgslatvar <- uniform_plot(
  final_bam_vlpfc_LN_mgslatvar, 
  "mgs_lat_var", 
  "vlPFC - LN",
  "#364D7E",
  "MGS Correct Trial Latency Variability (SD)",
  annotation = annotations$J
)

### SFA nuclei ###

vacc_CAT_int <- uniform_plot(
  final_bam_vacc_CAT_int, 
  "internalizing_probs_T", 
  "vACC - CAT",
  "#835689",
  "Internalizing Behaviors (T-score)",
  annotation = annotations$B
)

sgacc_CAT_ext <- uniform_plot(
  final_bam_sgacc_CAT_ext, 
  "externalizing_probs_T", 
  "sgACC - CAT",
  "#B16787",
  "Externalizing Behaviors (T-score)",
  annotation = annotations$C
)

sgacc_CAT_ders <- uniform_plot(
  final_bam_sgacc_CAT_ders, 
  "ders_total", 
  "sgACC - CAT",
  "#B16787",
  "Difficulties in Emotion Regulation",
  annotation = annotations$D
)

racc_CAT_ders <- uniform_plot(
  final_bam_racc_CAT_ders, 
  "ders_total", 
  "rACC - CAT",
  "#594F89",
  "Difficulties in Emotion Regulation",
  annotation = annotations$E
)

sgacc_CAT_mgsaccvar <- uniform_plot(
  final_bam_sgacc_CAT_mgsaccvar, 
  "mgs_acc_var", 
  "sgACC - CAT",
  "#B16787",
  "MGS Accuracy Variability (SD)",
  annotation = annotations$G
)

### combining into one figure

plot_grid(
  dlpfc_LN_ders, dlpfc_LN_mgslat, vlpfc_LN_mgslatvar, antvmpfc_CEN_int, antvmpfc_CEN_mgslat, racc_CAT_ders, sgacc_CAT_ders, sgacc_CAT_ext, sgacc_CAT_mgsaccvar, vacc_CAT_int,
  nrow = 2,
  labels = "AUTO",
  label_size = 12,
  align = "v"
)

```

# figure 4: psychological decoding domain analysis
```{r}
# figure 4a
output_top36_trimmed_combined <- vroom("output_top36_trimmed_combined.csv")

custom_colors <- c("ABN" = "#E99235",  
                   "BN" = "#CF3F4E",
                   "CAT" = "#173C78",
                   "CEN" = "#C63CF6",
                   "LN" = "#4884B6")

# viz 
fig4a <- output_top36_trimmed_combined %>% 
  mutate(term = str_replace_all(term, "_", " ")) %>% 
  ggplot(aes(x = term.correlation, y = term, color = Nucleus)) +
  geom_segment(aes(y = reorder(term, term.correlation), 
                   yend = term, 
                   x = 0.35, 
                   xend = term.correlation), 
               color = "#989898", 
               linewidth = 0.2) +
  geom_point(size = 2.2, alpha = 0.5) +
  theme_modern() +
  scale_color_manual(values = custom_colors) +
  labs(
    x = "Correlation",
    y = "Psychological Term",
    color = "Amygdala Seed"
  ) +
  xlim(0.35, 0.8) + 
  theme(
    axis.title.x = element_text(margin = margin(t = 0, r = 0, b = 0, l = 0)),
    axis.title.y = element_text(margin = margin(t = 0, r = 0, b = 0, l = 0)),
    legend.position = "right"
  )

# figure 4b

library(dplyr)
library(ggplot2)
library(tidyr)
library(patchwork)
library(gridExtra)

# read in data
all_results_3dlmer <- vroom("/Users/amarojha/Desktop/science/papers/submitted/frontoamygdala/amyg7T/cognitive_mapping/age_bins/3dlmer_amyg_maps/not_thresholded/all_roi_age_bin_correlations_3dlmer.csv")

# Make sure age_bin is treated as a numeric variable for proper ordering
all_results_3dlmer$age_bin <- as.numeric(all_results_3dlmer$age_bin)

custom_colors <- c("ABN" = "#E99235",  
                   "BN"  = "#CF3F4E",
                   "CAT" = "#173C78",
                   "CEN" = "#C63CF6",
                   "LN"  = "#4884B6")


# viz
# grab top 20 terms by max correlation
top_20_terms <- all_results_3dlmer %>% 
  filter(term.correlation > 0) %>% 
  group_by(term) %>% 
  summarise(max_correlation = max(term.correlation)) %>% 
  arrange(desc(max_correlation)) %>% 
  slice(1:20) %>% 
  pull(term)

# viz
fig4b <- all_results_3dlmer %>% 
  filter(term.correlation > 0, term %in% top_20_terms) %>% 
  mutate(
    term = str_replace_all(term, "_", " "),  
    ROI = toupper(roi),
    term = factor(term, levels = unique(term[order(-term.correlation)]))) %>% 
  ggplot(aes(x = age_bin, y = term.correlation, color = ROI)) +
    geom_line(linewidth = .5) +
    facet_wrap(~term, scales = "fixed") + 
    scale_color_manual(values = custom_colors) +
    scale_x_continuous(breaks = c(10, 20, 30)) +
    labs(
      x = "Age (Years)",
      y = "Correlation",
      color = "Amygdala Seed"
    ) +
    theme_minimal(base_size = 14) +
    theme(
      panel.border = element_rect(color = "black", fill = NA, linewidth = 0.6),
      panel.spacing = unit(0.5, "lines"),
      legend.position = "right",
      legend.title = element_text(size = 13),
      legend.text = element_text(size = 11),
      strip.text = element_text(face = "bold", size = 9),
      axis.text = element_text(size = 11),
      axis.title = element_text(size = 13)
    )

# combined fig

# adding subplot labels
fig4a_t <- fig4a +
  labs(tag = "A") +
  theme(
    plot.tag = element_text(size = 16, face = "bold"),
    plot.tag.position = c(0, 1)
  )

fig4b_t <- fig4b +
  labs(tag = "B") +
  theme(
    plot.tag = element_text(size = 16, face = "bold"),
    plot.tag.position = c(0, 1)
  )

grid.arrange(
  fig4a_t,
  fig4b_t,
  ncol = 2,
  widths = c(2/5, 3/5)
)

```

# supp. fig: rank stability 
```{r}
library(dplyr)
library(ggplot2)
library(forcats)  
library(ggh4x)
library(tidytext)

rank_data <- all_results_3dlmer %>%
    group_by(roi, age_bin) %>%
    mutate(
      rank = rank(-abs(term.correlation)),
      term_clean = gsub("_", " ", term),
      ROI = toupper(roi)
    ) %>%
    ungroup() %>%
    mutate(roi = factor(roi, levels = c("ABN", "BN", "CAT", "CEN", "LN")))

pal = pnw_palette("Shuksan", 100)

top_terms_data <- rank_data %>%
  group_by(ROI, term_clean) %>%
  dplyr::summarize(max_corr = max(term.correlation, na.rm = TRUE), .groups = 'drop_last') %>%
  slice_max(order_by = max_corr, n = 10) %>%
  ungroup()

plot_data <- rank_data %>%
  inner_join(top_terms_data, by = c("ROI", "term_clean")) %>%
  mutate(
    term_clean_ordered = reorder_within(term_clean, term.correlation, ROI),
    age_bin = factor(age_bin)
  )

ggplot(plot_data, aes(x = age_bin,
                      y = term_clean_ordered,
                      fill = term.correlation)) +
    geom_tile(color = "grey80", linewidth = 0.2) +
    geom_text(aes(label = rank), color = "black", size = 2) +
    scale_y_reordered() +
    scale_fill_gradientn(
        colours = pnw_palette("Shuksan", 100),
        name    = "Correlation"
    ) +
    ggh4x::facet_wrap2(
        ~ ROI,
        scales = "free_y",
        ncol = 1,
        axes = "all" 
    ) +
    labs(
        x     = "Age Bin",
        y     = "Term"
    ) +
    theme_minimal(base_size = 12) +
    theme(
        axis.text.y   = element_text(size = 8),
        axis.text.x   = element_text(size = 6),
        axis.title.x  = element_text(size = 10, face = "bold"),
        strip.text    = element_text(size = 10, face = "bold"),
        panel.grid    = element_blank(),
        legend.position = "right",
        panel.spacing.y = unit(1, "lines")
    )

```

# does separating by nuclei improve model fits? 
```{r}
#### using AICs to test whether there's a significant difference between bams with age-by-ROI vs just age (per PFC ROI):

# Data preparation
temp.df <- amygdala_nuclei_7T %>%
  dplyr::select(id, visit, roiA, roiB, roiA_side, roiB_side, laterality, context, scan_age, fc) %>% 
  filter(
    (roiA == "antvmpfc" & roiB %in% c("ABN", "BN", "CAT", "CEN", "LN")) |
    (roiB == "antvmpfc" & roiA %in% c("ABN", "BN", "CAT", "CEN", "LN"))
  ) %>%
  distinct() %>%
  mutate(
    laterality = as.factor(laterality),
    roiA_side = as.factor(roiA_side),
    roiB_side = as.factor(roiB_side),
    id = as.factor(id),
    context = as.factor(context),
    visit = as.factor(visit),
    roiA = as.factor(roiA),
    roiB = as.factor(roiB)
  )

# Remove incomplete cases
temp.df <- temp.df %>%
    filter(complete.cases(dplyr::select(., fc, scan_age, laterality, roiA_side)))

# Initial BAM model
initial_bam <- bam(
    fc ~ s(scan_age, k = 3, fx = T, by = roiB) + roiB + laterality + roiA_side + context,
    random = list(id = ~1 + visit),
    data = temp.df,
    REML = TRUE,
    discrete = TRUE
)

# Add residuals to dataframe
temp.df <- temp.df %>%
    mutate(bam.resid = residuals(initial_bam))

# Final BAM model after removing outliers
filtered_df <- temp.df %>%
    mutate(bam.z = abs(scale(bam.resid)[, 1])) %>%
    filter(bam.z < 2)

final_bam_by_amyg_roi_antvmpfc <- bam(
    fc ~ s(scan_age, k = 3, fx = T, by = roiB) + roiB + laterality + roiA_side + context,
    random = list(id = ~1 + visit),
    data = filtered_df,
    REML = TRUE,
    discrete = TRUE
)

# Data preparation
temp.df <- amygdala_nuclei_7T %>%
  dplyr::select(id, visit, roiA, roiB, roiA_side, roiB_side, laterality, context, scan_age, fc) %>% 
  filter(
    (roiA == "antvmpfc" & roiB %in% c("ABN", "BN", "CAT", "CEN", "LN")) |
    (roiB == "antvmpfc" & roiA %in% c("ABN", "BN", "CAT", "CEN", "LN"))
  ) %>%
  distinct() %>%
  mutate(
    laterality = as.factor(laterality),
    roiA_side = as.factor(roiA_side),
    roiB_side = as.factor(roiB_side),
    id = as.factor(id),
    context = as.factor(context),
    visit = as.factor(visit),
    roiA = as.factor(roiA),
    roiB = as.factor(roiB)
  )

# Remove incomplete cases
temp.df <- temp.df %>%
    filter(complete.cases(dplyr::select(., fc, scan_age, laterality, roiA_side)))

# Initial BAM model
initial_bam <- bam(
    fc ~ s(scan_age, k = 3, fx = T) + roiB + laterality + roiA_side + context,
    random = list(id = ~1 + visit),
    data = temp.df,
    REML = TRUE,
    discrete = TRUE
)

# Add residuals to dataframe
temp.df <- temp.df %>%
    mutate(bam.resid = residuals(initial_bam))

# Final BAM model after removing outliers
filtered_df <- temp.df %>%
    mutate(bam.z = abs(scale(bam.resid)[, 1])) %>%
    filter(bam.z < 2)

final_bam_not_by_amyg_roi_antvmpfc <- bam(
    fc ~ s(scan_age, k = 3, fx = T) + roiB + laterality + roiA_side + context,
    random = list(id = ~1 + visit),
    data = filtered_df,
    REML = TRUE,
    discrete = TRUE
)


## comparing AICs for each PFC ROI:

# ant. vmPFC
AIC(final_bam_by_amyg_roi_antvmpfc) # -5149.914
AIC(final_bam_not_by_amyg_roi_antvmpfc) # -5151.182

# sgACC
AIC(final_bam_by_amyg_roi_sgacc) # -4321.956
AIC(final_bam_not_by_amyg_roi_sgacc) # -4320.315

# rACC
AIC(final_bam_by_amyg_roi_racc) # -5389.172
AIC(final_bam_not_by_amyg_roi_racc) # -5391.715

# vACC
AIC(final_bam_by_amyg_roi_vacc) # -5058.549
AIC(final_bam_not_by_amyg_roi_vacc) # -5096.28

# dlPFC
AIC(final_bam_by_amyg_roi_dlpfc) # -6695.553
AIC(final_bam_not_by_amyg_roi_dlpfc) # -6695.61

# vlPFC
AIC(final_bam_by_amyg_roi_vlpfc) # -5583.266
AIC(final_bam_not_by_amyg_roi_vlpfc) # -5540.57
```

# supp. figure: age-related connections with data points + derivative bars
```{r}
bam.statistics <- data.frame(
  BAM.smooth_Fvalue = numeric(),
  BAM.smooth.pvalue = numeric(),
  smooth.change.onset = numeric(),
  smooth.peak.change = numeric(),
  smooth.decrease.onset = numeric(),
  smooth.decrease.offset = numeric(),
  smooth.increase.onset = numeric(),
  smooth.increase.offset = numeric(),
  smooth.last.change = numeric()
  )

bam.fittedvalues <- data.frame(scan_age = numeric(), fitted = numeric(), fitted2 = numeric(), se = numeric(), lower_ci = numeric(), upper_ci=numeric())

bam.smoothestimates <- data.frame(scan_age = numeric(), estimate = numeric(), se = numeric())

bam.derivatives <- data.frame(scan_age = numeric(), derivative = numeric(), lower = numeric(),
                              upper = numeric(), significant = numeric(), significant_deriv = numeric()) 

bam.pred <- data.frame(scan_age = numeric(), predicted = numeric(), se = numeric(),
                              lower = numeric(), upper = numeric()) 
  
## fitting my model
temp.df <- amygdala_nuclei_7T %>%
  dplyr::select(id, visit, roiA, roiB, roiA_side, roiB_side, laterality, context, scan_age, fc) %>% 
  filter(
    (roiA == "antvmpfc" & roiB == "CEN") |
    (roiB == "antvmpfc" & roiA == "CEN")
  ) %>%
  distinct() %>%
  mutate(
    laterality = as.factor(laterality),
    roiA_side = as.factor(roiA_side),
    roiB_side = as.factor(roiB_side),
    id = as.factor(id),
    context = as.factor(context),
    visit = as.factor(visit),
    roiA = as.factor(roiA),
    roiB = as.factor(roiB),
  )

# Remove incomplete cases
temp.df <- temp.df %>%
    filter(complete.cases(dplyr::select(., fc, scan_age, laterality, roiA_side)))

# Initial BAM model
initial_bam <- bam(
    fc ~ s(scan_age, k = 3, fx = T) + laterality + roiA_side + context,
    random = list(id = ~1 + visit),
    data = temp.df,
    REML = TRUE,
    discrete = TRUE
)

# Add residuals to dataframe
temp.df <- temp.df %>%
    mutate(bam.resid = residuals(initial_bam))

# Final BAM model after removing outliers
filtered_df <- temp.df %>%
    mutate(bam.z = abs(scale(bam.resid)[, 1])) %>%
    filter(bam.z < 2)

final_bam_antvmpfc_CEN <- bam(
    fc ~ s(scan_age, k = 3, fx = T) + laterality + roiA_side + context,
    random = list(id = ~1 + visit),
    data = filtered_df,
    REML = TRUE,
    discrete = TRUE
)


bam.results <- summary(final_bam_antvmpfc_CEN)

df <- as.data.frame(unclass(final_bam_antvmpfc_CEN$model),stringsAsFactors = TRUE)
np <- 200
thisPred <- data.frame(init = rep(0,np))
theseVars <- attr(final_bam_antvmpfc_CEN$terms, "term.labels")
varClasses <- attr(final_bam_antvmpfc_CEN$terms,"dataClasses")
thisResp <- as.character(final_bam_antvmpfc_CEN$terms[[2]])
smooth_var <- "scan_age"
for (v in c(1:length(theseVars))) {
  thisVar <- theseVars[[v]]
  thisClass <- varClasses[thisVar]
  if (thisVar == smooth_var) {
    thisPred[,smooth_var] = seq(min(df[,smooth_var],na.rm=T), max(df[,smooth_var], na.rm=T), length.out = np)
  } else {
      switch (thisClass,
              "numeric" = {thisPred[,thisVar] = median(df[,thisVar])}, #make predictions based on median value
              "character" = {thisPred[,thisVar] = levels(df[,thisVar])[[1]]}, #make predictions based on first level of char
              "factor" = {thisPred[,thisVar] = levels(df[,thisVar])[[1]]}, #make predictions based on first level of factor 
              "ordered" = {thisPred[,thisVar] = levels(df[,thisVar])[[1]]} #make predictions based on first level of ordinal variable
      )
    }
  }
  pred <- thisPred %>% dplyr::select(-init)
  
## MODEL STATSTICS ##  
#bam derivatives
#Get derivatives of the smooth function using finite differences
derv <- gratia::derivatives(final_bam_antvmpfc_CEN, term = sprintf('s(%s)',smooth_var), data = pred, interval = "simultaneous", unconditional = F) #derivative at 200 indices of smooth_var with a simultaneous CI
  #Identify derivative significance window(s)
  derv <- derv %>% #add "sig" column (TRUE/FALSE) to derv
    mutate(sig = !(0 > .lower_ci & 0 < .upper_ci)) #derivative is sig if the lower CI is not < 0 while the upper CI is > 0 (i.e., when the CI does not include 0)
  derv$sig_deriv = derv$.derivative*derv$sig #add "sig_deriv derivatives column where non-significant derivatives are set to 0
  mean.derivative <- mean(derv$.derivative)
  
  #Model summary outputs
  #Signed F value for the smooth term and bam-based significance of the smooth term
  bam.smooth.F <- bam.results$s.table[1,3] #first row is s(smooth_var), third entry is F
  bam.smooth.Rsq <- bam.results$r.sq
  if(mean.derivative < 0){ #if the average derivative is less than 0, make the effect size estimate negative
    bam.smooth.F <- bam.smooth.F*-1}
  
  bam.smooth.pvalue <- bam.results$s.table[1,4] #first row is s(smooth_var), fourth entry is p-value

 #Derivative-based temporal characteristics
  #Age of developmental change onset
  if(sum(derv$sig) > 0){ #if derivative is significant at at least 1 age
    change.onset <- min(derv$scan_age[derv$sig==T])} #find first age in the smooth where derivative is significant
  if(sum(derv$sig) == 0){ #if bam derivative is never significant
    change.onset <- NA} #assign NA
 
  #Age of maximal developmental change
  if(sum(derv$sig) > 0){ 
    derv$abs_sig_deriv = round(abs(derv$sig_deriv),5) #absolute value significant derivatives
    maxval <- max(derv$abs_sig_deriv) #find the largest derivative
    window.peak.change <- derv$scan_age[derv$abs_sig_deriv == maxval] #identify the age(s) at which the derivative is greatest in absolute magnitude
    peak.change <- mean(window.peak.change)} #identify the age of peak developmental change
  if(sum(derv$sig) == 0){ 
    peak.change <- NA}  
 
  #Age of decrease onset
  if(sum(derv$sig) > 0){ 
    decreasing.range <- derv$scan_age[derv$sig_deriv < 0] #identify all ages with a significant negative derivative (i.e., smooth_var indices where y is decreasing)
    if(length(decreasing.range) > 0)
      decrease.onset <- min(decreasing.range) #find youngest age with a significant negative derivative
    if(length(decreasing.range) == 0)
      decrease.onset <- NA}
  if(sum(derv$sig) == 0){
    decrease.onset <- NA}  

    #Age of decrease offset
  if(sum(derv$sig) > 0){ 
    decreasing.range <- derv$scan_age[derv$sig_deriv < 0] #identify all ages with a significant negative derivative (i.e., smooth_var indices where y is decreasing)
    if(length(decreasing.range) > 0){
      last.decrease <- max(decreasing.range) #find oldest age with a significant negative derivative
      if(last.decrease == derv$scan_age[length(derv$scan_age)]) #if the last age of significant decrease is the oldest in the dataset
        decrease.offset <- last.decrease
      if(last.decrease != derv$scan_age[length(derv$scan_age)]){ 
        decrease.offset.row <- which(derv$scan_age == last.decrease) + 1 #use above to find the first age when the derivative is not significant
        decrease.offset <- derv$scan_age[decrease.offset.row]}
    }
    if(length(decreasing.range) == 0)
      decrease.offset <- NA}
  if(sum(derv$sig) == 0){ 
    decrease.offset <- NA}  

  #Age of increase onset
  if(sum(derv$sig) > 0){ 
    increasing.range <- derv$scan_age[derv$sig_deriv > 0] #identify all ages with a significant positive derivative (i.e., smooth_var indices where y is increasing)
    if(length(increasing.range) > 0)
      increase.onset <- min(increasing.range) #find oldest age with a significant positive derivative
    if(length(increasing.range) == 0)
      increase.onset <- NA}
  if(sum(derv$sig) == 0){ 
    increase.onset <- NA}  
 
#Age of increase offset
  if(sum(derv$sig) > 0){ 
    increasing.range <- derv$scan_age[derv$sig_deriv > 0] #identify all ages with a significant positive derivative (i.e., smooth_var indices where y is increasing)
    if(length(increasing.range) > 0){
      last.increase <- max(increasing.range) #find oldest age with a significant positive derivative
      if(last.increase == derv$scan_age[length(derv$scan_age)]) #if the last age of significant increase is the oldest in the dataset
        increase.offset <- last.increase
      if(last.increase != derv$scan_age[length(derv$scan_age)]){ 
        increase.offset.row <- which(derv$scan_age == last.increase) + 1 #use above to find the first age when the derivative is not significant
        increase.offset <- derv$scan_age[increase.offset.row]}
    }
    if(length(increasing.range) == 0)
      increase.offset <- NA}
  if(sum(derv$sig) == 0){ 
    increase.offset <- NA}  
  
 #Age of last change
  if(sum(derv$sig) > 0){ 
    change.offset <- max(derv$scan_age[derv$sig==T])} #find last age in the smooth where derivative is significant
  if(sum(derv$sig) == 0){ 
    change.offset <- NA}  
  
# bam.statistics$Traj_Group[subst] <- traj_group[subst]
# bam.statistics$bam.smooth_Fvalue[subst] <- bam.smooth.F
# bam.statistics$bam.smooth_RSq[subst] <- bam.smooth.Rsq

# bam.statistics$bam.smooth.pvalue[subst] <- bam.smooth.pvalue

# bam.statistics$smooth.change.onset[subst] <- change.onset
# bam.statistics$smooth.peak.change[subst] <- peak.change
# bam.statistics$smooth.decrease.onset[subst] <- decrease.onset
# bam.statistics$smooth.decrease.offset[subst] <- decrease.offset
# bam.statistics$smooth.increase.onset[subst] <- increase.onset
# bam.statistics$smooth.increase.offset[subst] <- increase.offset
# bam.statistics$smooth.last.change[subst] <- change.offset

 #Generate predictions (fitted values) based on the bam model and predication data frame
bam.fittedvalues_temp <- gratia::fitted_values(object = final_bam_antvmpfc_CEN, data = pred)
bam.fittedvalues_temp$.fitted2 <- plogis(bam.fittedvalues_temp$.fitted) * 33 # changed from AP's '30' as my age range is a bit higher 

# bam.fittedvalues_temp <- plogis(fitted(final_bam_CEN))*30

temp_fit <- data.frame(
  scan_age = bam.fittedvalues_temp$scan_age, 
  fitted = bam.fittedvalues_temp$.fitted, 
  fitted2 = bam.fittedvalues_temp$.fitted2, 
  se = bam.fittedvalues_temp$.se, 
  lower_ci = bam.fittedvalues_temp$.lower_ci, 
  upper_ci = bam.fittedvalues_temp$.upper_ci)
bam.fittedvalues <- bind_rows(bam.fittedvalues, temp_fit)

bam.smoothestimates_temp <- gratia::smooth_estimates(object = final_bam_antvmpfc_CEN, data = pred, smooth = sprintf('s(%s)',smooth_var))

temp_smooth <- data.frame(
  scan_age = bam.smoothestimates_temp$scan_age, 
  estimate = bam.smoothestimates_temp$.estimate,  
  se = bam.smoothestimates_temp$.se)
bam.smoothestimates <- bind_rows(bam.smoothestimates, temp_smooth)

temp_deriv <- data.frame(
  scan_age = derv$scan_age, 
  derivative = derv$.derivative, 
  lower = derv$.lower_ci,
  upper = derv$.upper_ci, 
  significant = derv$sig, 
  significant_deriv = derv$sig_deriv)

bam.derivatives <- bind_rows(bam.derivatives, temp_deriv)

bam.pred_temp <- ggpredict(final_bam_antvmpfc_CEN, terms=c("scan_age"))

temp_pred <- data.frame(
  scan_age = bam.pred_temp$x,
  predicted = bam.pred_temp$predicted, 
  se = bam.pred_temp$std.error,
  lower = bam.pred_temp$conf.low, 
  upper = bam.pred_temp$conf.high)

bam.pred <- bind_rows(bam.pred, temp_pred)  


#Calculate the average first derivative in each region at each substance
deriv_rate <- bam.derivatives %>% do(deriv_rate = mean(.$derivative)) %>% unnest(cols = "deriv_rate")

bam.statistics <- merge(bam.statistics, deriv_rate)

#Main plot 
antvmpfc_cen_main <- ggeffects::ggpredict(final_bam_antvmpfc_CEN, terms = c("scan_age")) %>% 
  ggplot(aes(x = x, 
             y = predicted,
             group = group,
             linetype = group)) +
  geom_point(data = filtered_df, 
             aes(x = scan_age, y = fc), 
             color = "#1C3A23", 
             alpha = 0.75, 
             size = 0.25,
             inherit.aes = FALSE) +           
  geom_line(color = "#1C3A23", size = 1.5) +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high), fill = "#1C3A23", alpha = 0.2) +
  theme_modern(axis.title.space = .5, plot.title.space = .5) +
  xlab("Age (Years)") +
  ylab("Functional Connectivity") + 
  ggtitle("ant. vmPFC - CEN") +
  theme(
    plot.title = element_text(hjust = 0.6),
    legend.position = "none") +
  coord_cartesian(ylim = c(-.5, .5)) +
  scale_x_continuous(limits = c(10, 33), breaks = seq(10, 35, by = 5), expand = c(0, 0)) #make this same as below 
 
# Deriv plot 
#max_val = .38
derv <- bam.derivatives 
d1 <- ggplot(data=derv) + geom_tile(aes(x = scan_age, y = .5, fill = significant_deriv))+
      scale_fill_gradient2(low = "#1C3A23", midpoint = 0, mid = "white",
                           high = "#1C3A23")+ #, limits = c(0, max_val))+ 
    theme(aspect.ratio = .05, panel.grid.major = element_blank(),
          panel.grid.minor=element_blank(),
          panel.background=element_blank(), 
          axis.text = element_blank(),
          axis.title.x = element_blank(),
          axis.title.y = element_blank(),
          axis.line = element_blank(), 
          axis.ticks = element_blank(),
          legend.key.width = unit(1,"cm"),
          legend.key.height = unit(.5,"cm"),
          legend.position = "none",
          plot.margin = unit(c(0, 0, 0, 0), "cm"))+
    guides(fill = guide_colorbar(reverse = F,direction = "horizontal",title.position = "top")) + 
  scale_x_continuous(limits = c(10, 33), breaks = seq(10, 35, by = 5), expand = c(0, 0)) + #make this same as above 
         labs(y="All", x="Age")


# max_val & including as limits if you want your derivs to be consistent across multiple plots (range)
# Adjust the value to the max of your derivs

antvmpfc_cen <- plot_grid(antvmpfc_cen_main, d1, 
          ncol = 1, 
          align = "v", 
          axis = "lr",
          rel_heights = c(4, 0.5))

print(antvmpfc_cen)


bam.statistics <- data.frame(
  BAM.smooth_Fvalue = numeric(),
  BAM.smooth.pvalue = numeric(),
  smooth.change.onset = numeric(),
  smooth.peak.change = numeric(),
  smooth.decrease.onset = numeric(),
  smooth.decrease.offset = numeric(),
  smooth.increase.onset = numeric(),
  smooth.increase.offset = numeric(),
  smooth.last.change = numeric()
  )

bam.fittedvalues <- data.frame(scan_age = numeric(), fitted = numeric(), fitted2 = numeric(), se = numeric(), lower_ci = numeric(), upper_ci=numeric())

bam.smoothestimates <- data.frame(scan_age = numeric(), estimate = numeric(), se = numeric())

bam.derivatives <- data.frame(scan_age = numeric(), derivative = numeric(), lower = numeric(),
                              upper = numeric(), significant = numeric(), significant_deriv = numeric()) 

bam.pred <- data.frame(scan_age = numeric(), predicted = numeric(), se = numeric(),
                              lower = numeric(), upper = numeric()) 
  
## fitting my model
temp.df <- amygdala_nuclei_7T %>%
  dplyr::select(id, visit, roiA, roiB, roiA_side, roiB_side, laterality, context, scan_age, fc) %>% 
  filter(
    (roiA == "dlpfc" & roiB == "BN") |
    (roiB == "dlpfc" & roiA == "BN")
  ) %>%
  distinct() %>%
  mutate(
    laterality = as.factor(laterality),
    roiA_side = as.factor(roiA_side),
    roiB_side = as.factor(roiB_side),
    id = as.factor(id),
    context = as.factor(context),
    visit = as.factor(visit),
    roiA = as.factor(roiA),
    roiB = as.factor(roiB),
  )

# Remove incomplete cases
temp.df <- temp.df %>%
    filter(complete.cases(dplyr::select(., fc, scan_age, laterality, roiA_side)))

# Initial BAM model
initial_bam <- bam(
    fc ~ s(scan_age, k = 3, fx = T) + laterality + roiA_side + context,
    random = list(id = ~1 + visit),
    data = temp.df,
    REML = TRUE,
    discrete = TRUE
)

# Add residuals to dataframe
temp.df <- temp.df %>%
    mutate(bam.resid = residuals(initial_bam))

# Final BAM model after removing outliers
filtered_df <- temp.df %>%
    mutate(bam.z = abs(scale(bam.resid)[, 1])) %>%
    filter(bam.z < 2)

final_bam_dlpfc_BN <- bam(
    fc ~ s(scan_age, k = 3, fx = T) + laterality + roiA_side + context,
    random = list(id = ~1 + visit),
    data = filtered_df,
    REML = TRUE,
    discrete = TRUE
)


bam.results <- summary(final_bam_dlpfc_BN)

df <- as.data.frame(unclass(final_bam_dlpfc_BN$model),stringsAsFactors = TRUE)
np <- 200
thisPred <- data.frame(init = rep(0,np))
theseVars <- attr(final_bam_dlpfc_BN$terms, "term.labels")
varClasses <- attr(final_bam_dlpfc_BN$terms,"dataClasses")
thisResp <- as.character(final_bam_dlpfc_BN$terms[[2]])
smooth_var <- "scan_age"
for (v in c(1:length(theseVars))) {
  thisVar <- theseVars[[v]]
  thisClass <- varClasses[thisVar]
  if (thisVar == smooth_var) {
    thisPred[,smooth_var] = seq(min(df[,smooth_var],na.rm=T), max(df[,smooth_var], na.rm=T), length.out = np)
  } else {
      switch (thisClass,
              "numeric" = {thisPred[,thisVar] = median(df[,thisVar])}, #make predictions based on median value
              "character" = {thisPred[,thisVar] = levels(df[,thisVar])[[1]]}, #make predictions based on first level of char
              "factor" = {thisPred[,thisVar] = levels(df[,thisVar])[[1]]}, #make predictions based on first level of factor 
              "ordered" = {thisPred[,thisVar] = levels(df[,thisVar])[[1]]} #make predictions based on first level of ordinal variable
      )
    }
  }
  pred <- thisPred %>% dplyr::select(-init)
  
## MODEL STATSTICS ##  
#bam derivatives
#Get derivatives of the smooth function using finite differences
derv <- gratia::derivatives(final_bam_dlpfc_BN, term = sprintf('s(%s)',smooth_var), data = pred, interval = "simultaneous", unconditional = F) #derivative at 200 indices of smooth_var with a simultaneous CI
  #Identify derivative significance window(s)
  derv <- derv %>% #add "sig" column (TRUE/FALSE) to derv
    mutate(sig = !(0 > .lower_ci & 0 < .upper_ci)) #derivative is sig if the lower CI is not < 0 while the upper CI is > 0 (i.e., when the CI does not include 0)
  derv$sig_deriv = derv$.derivative*derv$sig #add "sig_deriv derivatives column where non-significant derivatives are set to 0
  mean.derivative <- mean(derv$.derivative)
  
  #Model summary outputs
  #Signed F value for the smooth term and bam-based significance of the smooth term
  bam.smooth.F <- bam.results$s.table[1,3] #first row is s(smooth_var), third entry is F
  bam.smooth.Rsq <- bam.results$r.sq
  if(mean.derivative < 0){ #if the average derivative is less than 0, make the effect size estimate negative
    bam.smooth.F <- bam.smooth.F*-1}
  
  bam.smooth.pvalue <- bam.results$s.table[1,4] #first row is s(smooth_var), fourth entry is p-value

 #Derivative-based temporal characteristics
  #Age of developmental change onset
  if(sum(derv$sig) > 0){ #if derivative is significant at at least 1 age
    change.onset <- min(derv$scan_age[derv$sig==T])} #find first age in the smooth where derivative is significant
  if(sum(derv$sig) == 0){ #if bam derivative is never significant
    change.onset <- NA} #assign NA
 
  #Age of maximal developmental change
  if(sum(derv$sig) > 0){ 
    derv$abs_sig_deriv = round(abs(derv$sig_deriv),5) #absolute value significant derivatives
    maxval <- max(derv$abs_sig_deriv) #find the largest derivative
    window.peak.change <- derv$scan_age[derv$abs_sig_deriv == maxval] #identify the age(s) at which the derivative is greatest in absolute magnitude
    peak.change <- mean(window.peak.change)} #identify the age of peak developmental change
  if(sum(derv$sig) == 0){ 
    peak.change <- NA}  
 
  #Age of decrease onset
  if(sum(derv$sig) > 0){ 
    decreasing.range <- derv$scan_age[derv$sig_deriv < 0] #identify all ages with a significant negative derivative (i.e., smooth_var indices where y is decreasing)
    if(length(decreasing.range) > 0)
      decrease.onset <- min(decreasing.range) #find youngest age with a significant negative derivative
    if(length(decreasing.range) == 0)
      decrease.onset <- NA}
  if(sum(derv$sig) == 0){
    decrease.onset <- NA}  

    #Age of decrease offset
  if(sum(derv$sig) > 0){ 
    decreasing.range <- derv$scan_age[derv$sig_deriv < 0] #identify all ages with a significant negative derivative (i.e., smooth_var indices where y is decreasing)
    if(length(decreasing.range) > 0){
      last.decrease <- max(decreasing.range) #find oldest age with a significant negative derivative
      if(last.decrease == derv$scan_age[length(derv$scan_age)]) #if the last age of significant decrease is the oldest in the dataset
        decrease.offset <- last.decrease
      if(last.decrease != derv$scan_age[length(derv$scan_age)]){ 
        decrease.offset.row <- which(derv$scan_age == last.decrease) + 1 #use above to find the first age when the derivative is not significant
        decrease.offset <- derv$scan_age[decrease.offset.row]}
    }
    if(length(decreasing.range) == 0)
      decrease.offset <- NA}
  if(sum(derv$sig) == 0){ 
    decrease.offset <- NA}  

  #Age of increase onset
  if(sum(derv$sig) > 0){ 
    increasing.range <- derv$scan_age[derv$sig_deriv > 0] #identify all ages with a significant positive derivative (i.e., smooth_var indices where y is increasing)
    if(length(increasing.range) > 0)
      increase.onset <- min(increasing.range) #find oldest age with a significant positive derivative
    if(length(increasing.range) == 0)
      increase.onset <- NA}
  if(sum(derv$sig) == 0){ 
    increase.onset <- NA}  
 
#Age of increase offset
  if(sum(derv$sig) > 0){ 
    increasing.range <- derv$scan_age[derv$sig_deriv > 0] #identify all ages with a significant positive derivative (i.e., smooth_var indices where y is increasing)
    if(length(increasing.range) > 0){
      last.increase <- max(increasing.range) #find oldest age with a significant positive derivative
      if(last.increase == derv$scan_age[length(derv$scan_age)]) #if the last age of significant increase is the oldest in the dataset
        increase.offset <- last.increase
      if(last.increase != derv$scan_age[length(derv$scan_age)]){ 
        increase.offset.row <- which(derv$scan_age == last.increase) + 1 #use above to find the first age when the derivative is not significant
        increase.offset <- derv$scan_age[increase.offset.row]}
    }
    if(length(increasing.range) == 0)
      increase.offset <- NA}
  if(sum(derv$sig) == 0){ 
    increase.offset <- NA}  
  
 #Age of last change
  if(sum(derv$sig) > 0){ 
    change.offset <- max(derv$scan_age[derv$sig==T])} #find last age in the smooth where derivative is significant
  if(sum(derv$sig) == 0){ 
    change.offset <- NA}  
  
# bam.statistics$Traj_Group[subst] <- traj_group[subst]
# bam.statistics$bam.smooth_Fvalue[subst] <- bam.smooth.F
# bam.statistics$bam.smooth_RSq[subst] <- bam.smooth.Rsq

# bam.statistics$bam.smooth.pvalue[subst] <- bam.smooth.pvalue

# bam.statistics$smooth.change.onset[subst] <- change.onset
# bam.statistics$smooth.peak.change[subst] <- peak.change
# bam.statistics$smooth.decrease.onset[subst] <- decrease.onset
# bam.statistics$smooth.decrease.offset[subst] <- decrease.offset
# bam.statistics$smooth.increase.onset[subst] <- increase.onset
# bam.statistics$smooth.increase.offset[subst] <- increase.offset
# bam.statistics$smooth.last.change[subst] <- change.offset

 #Generate predictions (fitted values) based on the bam model and predication data frame
bam.fittedvalues_temp <- gratia::fitted_values(object = final_bam_dlpfc_BN, data = pred)
bam.fittedvalues_temp$.fitted2 <- plogis(bam.fittedvalues_temp$.fitted) * 33 # changed from AP's '30' as my age range is a bit higher 

# bam.fittedvalues_temp <- plogis(fitted(final_bam_CEN))*30

temp_fit <- data.frame(
  scan_age = bam.fittedvalues_temp$scan_age, 
  fitted = bam.fittedvalues_temp$.fitted, 
  fitted2 = bam.fittedvalues_temp$.fitted2, 
  se = bam.fittedvalues_temp$.se, 
  lower_ci = bam.fittedvalues_temp$.lower_ci, 
  upper_ci = bam.fittedvalues_temp$.upper_ci)
bam.fittedvalues <- bind_rows(bam.fittedvalues, temp_fit)

bam.smoothestimates_temp <- gratia::smooth_estimates(object = final_bam_dlpfc_BN, data = pred, smooth = sprintf('s(%s)',smooth_var))

temp_smooth <- data.frame(
  scan_age = bam.smoothestimates_temp$scan_age, 
  estimate = bam.smoothestimates_temp$.estimate,  
  se = bam.smoothestimates_temp$.se)
bam.smoothestimates <- bind_rows(bam.smoothestimates, temp_smooth)

temp_deriv <- data.frame(
  scan_age = derv$scan_age, 
  derivative = derv$.derivative, 
  lower = derv$.lower_ci,
  upper = derv$.upper_ci, 
  significant = derv$sig, 
  significant_deriv = derv$sig_deriv)

bam.derivatives <- bind_rows(bam.derivatives, temp_deriv)

bam.pred_temp <- ggpredict(final_bam_dlpfc_BN, terms=c("scan_age"))

temp_pred <- data.frame(
  scan_age = bam.pred_temp$x,
  predicted = bam.pred_temp$predicted, 
  se = bam.pred_temp$std.error,
  lower = bam.pred_temp$conf.low, 
  upper = bam.pred_temp$conf.high)

bam.pred <- bind_rows(bam.pred, temp_pred)  


#Calculate the average first derivative in each region at each substance
deriv_rate <- bam.derivatives %>% do(deriv_rate = mean(.$derivative)) %>% unnest(cols = "deriv_rate")

bam.statistics <- merge(bam.statistics, deriv_rate)

#Main plot 
dlpfc_bn_main <- ggeffects::ggpredict(final_bam_dlpfc_BN, terms = c("scan_age")) %>% 
  ggplot(aes(x = x, 
             y = predicted,
             group = group,
             linetype = group)) +
  geom_point(data = filtered_df, 
             aes(x = scan_age, y = fc), 
             color = "#DE8787", 
             alpha = 0.75, 
             size = 0.25,
             inherit.aes = FALSE) +           
  geom_line(color = "#DE8787", size = 1.5) +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high), fill = "#DE8787", alpha = 0.2) +
  theme_modern(axis.title.space = .5, plot.title.space = .5) +
  xlab("Age (Years)") +
  ylab("Functional Connectivity") + 
  ggtitle("dlPFC - BN") +
  theme(
    plot.title = element_text(hjust = 0.6),
    legend.position = "none") +
  coord_cartesian(ylim = c(-.5, .5)) +
  scale_x_continuous(limits = c(10, 33), breaks = seq(10, 35, by = 5), expand = c(0, 0)) #make this same as below 
 
# Deriv plot 
#max_val = .38
derv <- bam.derivatives 
d1 <- ggplot(data=derv) + geom_tile(aes(x = scan_age, y = .5, fill = significant_deriv))+
      scale_fill_gradient2(low = "#DE8787", midpoint = 0, mid = "white",
                           high = "#DE8787")+ #, limits = c(0, max_val))+ 
    theme(aspect.ratio = .05, panel.grid.major = element_blank(),
          panel.grid.minor=element_blank(),
          panel.background=element_blank(), 
          axis.text = element_blank(),
          axis.title.x = element_blank(),
          axis.title.y = element_blank(),
          axis.line = element_blank(), 
          axis.ticks = element_blank(),
          legend.key.width = unit(1,"cm"),
          legend.key.height = unit(.5,"cm"),
          legend.position = "none",
          plot.margin = unit(c(0, 0, 0, 0), "cm"))+
    guides(fill = guide_colorbar(reverse = F,direction = "horizontal",title.position = "top")) + 
  scale_x_continuous(limits = c(10, 33), breaks = seq(10, 35, by = 5), expand = c(0, 0)) + #make this same as above 
         labs(y="All", x="Age")


# max_val & including as limits if you want your derivs to be consistent across multiple plots (range)
# Adjust the value to the max of your derivs

dlpfc_bn <- plot_grid(dlpfc_bn_main, d1, 
          ncol = 1, 
          align = "v", 
          axis = "lr",
          rel_heights = c(4, 0.5))

print(dlpfc_bn)

bam.statistics <- data.frame(
  BAM.smooth_Fvalue = numeric(),
  BAM.smooth.pvalue = numeric(),
  smooth.change.onset = numeric(),
  smooth.peak.change = numeric(),
  smooth.decrease.onset = numeric(),
  smooth.decrease.offset = numeric(),
  smooth.increase.onset = numeric(),
  smooth.increase.offset = numeric(),
  smooth.last.change = numeric()
  )

bam.fittedvalues <- data.frame(scan_age = numeric(), fitted = numeric(), fitted2 = numeric(), se = numeric(), lower_ci = numeric(), upper_ci=numeric())

bam.smoothestimates <- data.frame(scan_age = numeric(), estimate = numeric(), se = numeric())

bam.derivatives <- data.frame(scan_age = numeric(), derivative = numeric(), lower = numeric(),
                              upper = numeric(), significant = numeric(), significant_deriv = numeric()) 

bam.pred <- data.frame(scan_age = numeric(), predicted = numeric(), se = numeric(),
                              lower = numeric(), upper = numeric()) 
  
## fitting my model
temp.df <- amygdala_nuclei_7T %>%
  dplyr::select(id, visit, roiA, roiB, roiA_side, roiB_side, laterality, context, scan_age, fc) %>% 
  filter(
    (roiA == "dlpfc" & roiB == "LN") |
    (roiB == "dlpfc" & roiA == "LN")
  ) %>%
  distinct() %>%
  mutate(
    laterality = as.factor(laterality),
    roiA_side = as.factor(roiA_side),
    roiB_side = as.factor(roiB_side),
    id = as.factor(id),
    context = as.factor(context),
    visit = as.factor(visit),
    roiA = as.factor(roiA),
    roiB = as.factor(roiB),
  )

# Remove incomplete cases
temp.df <- temp.df %>%
    filter(complete.cases(dplyr::select(., fc, scan_age, laterality, roiA_side)))

# Initial BAM model
initial_bam <- bam(
    fc ~ s(scan_age, k = 3, fx = T) + laterality + roiA_side + context,
    random = list(id = ~1 + visit),
    data = temp.df,
    REML = TRUE,
    discrete = TRUE
)

# Add residuals to dataframe
temp.df <- temp.df %>%
    mutate(bam.resid = residuals(initial_bam))

# Final BAM model after removing outliers
filtered_df <- temp.df %>%
    mutate(bam.z = abs(scale(bam.resid)[, 1])) %>%
    filter(bam.z < 2)

final_bam_dlpfc_LN <- bam(
    fc ~ s(scan_age, k = 3, fx = T) + laterality + roiA_side + context,
    random = list(id = ~1 + visit),
    data = filtered_df,
    REML = TRUE,
    discrete = TRUE
)


bam.results <- summary(final_bam_dlpfc_LN)

df <- as.data.frame(unclass(final_bam_dlpfc_LN$model),stringsAsFactors = TRUE)
np <- 200
thisPred <- data.frame(init = rep(0,np))
theseVars <- attr(final_bam_dlpfc_LN$terms, "term.labels")
varClasses <- attr(final_bam_dlpfc_LN$terms,"dataClasses")
thisResp <- as.character(final_bam_dlpfc_LN$terms[[2]])
smooth_var <- "scan_age"
for (v in c(1:length(theseVars))) {
  thisVar <- theseVars[[v]]
  thisClass <- varClasses[thisVar]
  if (thisVar == smooth_var) {
    thisPred[,smooth_var] = seq(min(df[,smooth_var],na.rm=T), max(df[,smooth_var], na.rm=T), length.out = np)
  } else {
      switch (thisClass,
              "numeric" = {thisPred[,thisVar] = median(df[,thisVar])}, #make predictions based on median value
              "character" = {thisPred[,thisVar] = levels(df[,thisVar])[[1]]}, #make predictions based on first level of char
              "factor" = {thisPred[,thisVar] = levels(df[,thisVar])[[1]]}, #make predictions based on first level of factor 
              "ordered" = {thisPred[,thisVar] = levels(df[,thisVar])[[1]]} #make predictions based on first level of ordinal variable
      )
    }
  }
  pred <- thisPred %>% dplyr::select(-init)
  
## MODEL STATSTICS ##  
#bam derivatives
#Get derivatives of the smooth function using finite differences
derv <- gratia::derivatives(final_bam_dlpfc_LN, term = sprintf('s(%s)',smooth_var), data = pred, interval = "simultaneous", unconditional = F) #derivative at 200 indices of smooth_var with a simultaneous CI
  #Identify derivative significance window(s)
  derv <- derv %>% #add "sig" column (TRUE/FALSE) to derv
    mutate(sig = !(0 > .lower_ci & 0 < .upper_ci)) #derivative is sig if the lower CI is not < 0 while the upper CI is > 0 (i.e., when the CI does not include 0)
  derv$sig_deriv = derv$.derivative*derv$sig #add "sig_deriv derivatives column where non-significant derivatives are set to 0
  mean.derivative <- mean(derv$.derivative)
  
  #Model summary outputs
  #Signed F value for the smooth term and bam-based significance of the smooth term
  bam.smooth.F <- bam.results$s.table[1,3] #first row is s(smooth_var), third entry is F
  bam.smooth.Rsq <- bam.results$r.sq
  if(mean.derivative < 0){ #if the average derivative is less than 0, make the effect size estimate negative
    bam.smooth.F <- bam.smooth.F*-1}
  
  bam.smooth.pvalue <- bam.results$s.table[1,4] #first row is s(smooth_var), fourth entry is p-value

 #Derivative-based temporal characteristics
  #Age of developmental change onset
  if(sum(derv$sig) > 0){ #if derivative is significant at at least 1 age
    change.onset <- min(derv$scan_age[derv$sig==T])} #find first age in the smooth where derivative is significant
  if(sum(derv$sig) == 0){ #if bam derivative is never significant
    change.onset <- NA} #assign NA
 
  #Age of maximal developmental change
  if(sum(derv$sig) > 0){ 
    derv$abs_sig_deriv = round(abs(derv$sig_deriv),5) #absolute value significant derivatives
    maxval <- max(derv$abs_sig_deriv) #find the largest derivative
    window.peak.change <- derv$scan_age[derv$abs_sig_deriv == maxval] #identify the age(s) at which the derivative is greatest in absolute magnitude
    peak.change <- mean(window.peak.change)} #identify the age of peak developmental change
  if(sum(derv$sig) == 0){ 
    peak.change <- NA}  
 
  #Age of decrease onset
  if(sum(derv$sig) > 0){ 
    decreasing.range <- derv$scan_age[derv$sig_deriv < 0] #identify all ages with a significant negative derivative (i.e., smooth_var indices where y is decreasing)
    if(length(decreasing.range) > 0)
      decrease.onset <- min(decreasing.range) #find youngest age with a significant negative derivative
    if(length(decreasing.range) == 0)
      decrease.onset <- NA}
  if(sum(derv$sig) == 0){
    decrease.onset <- NA}  

    #Age of decrease offset
  if(sum(derv$sig) > 0){ 
    decreasing.range <- derv$scan_age[derv$sig_deriv < 0] #identify all ages with a significant negative derivative (i.e., smooth_var indices where y is decreasing)
    if(length(decreasing.range) > 0){
      last.decrease <- max(decreasing.range) #find oldest age with a significant negative derivative
      if(last.decrease == derv$scan_age[length(derv$scan_age)]) #if the last age of significant decrease is the oldest in the dataset
        decrease.offset <- last.decrease
      if(last.decrease != derv$scan_age[length(derv$scan_age)]){ 
        decrease.offset.row <- which(derv$scan_age == last.decrease) + 1 #use above to find the first age when the derivative is not significant
        decrease.offset <- derv$scan_age[decrease.offset.row]}
    }
    if(length(decreasing.range) == 0)
      decrease.offset <- NA}
  if(sum(derv$sig) == 0){ 
    decrease.offset <- NA}  

  #Age of increase onset
  if(sum(derv$sig) > 0){ 
    increasing.range <- derv$scan_age[derv$sig_deriv > 0] #identify all ages with a significant positive derivative (i.e., smooth_var indices where y is increasing)
    if(length(increasing.range) > 0)
      increase.onset <- min(increasing.range) #find oldest age with a significant positive derivative
    if(length(increasing.range) == 0)
      increase.onset <- NA}
  if(sum(derv$sig) == 0){ 
    increase.onset <- NA}  
 
#Age of increase offset
  if(sum(derv$sig) > 0){ 
    increasing.range <- derv$scan_age[derv$sig_deriv > 0] #identify all ages with a significant positive derivative (i.e., smooth_var indices where y is increasing)
    if(length(increasing.range) > 0){
      last.increase <- max(increasing.range) #find oldest age with a significant positive derivative
      if(last.increase == derv$scan_age[length(derv$scan_age)]) #if the last age of significant increase is the oldest in the dataset
        increase.offset <- last.increase
      if(last.increase != derv$scan_age[length(derv$scan_age)]){ 
        increase.offset.row <- which(derv$scan_age == last.increase) + 1 #use above to find the first age when the derivative is not significant
        increase.offset <- derv$scan_age[increase.offset.row]}
    }
    if(length(increasing.range) == 0)
      increase.offset <- NA}
  if(sum(derv$sig) == 0){ 
    increase.offset <- NA}  
  
 #Age of last change
  if(sum(derv$sig) > 0){ 
    change.offset <- max(derv$scan_age[derv$sig==T])} #find last age in the smooth where derivative is significant
  if(sum(derv$sig) == 0){ 
    change.offset <- NA}  
  
# bam.statistics$Traj_Group[subst] <- traj_group[subst]
# bam.statistics$bam.smooth_Fvalue[subst] <- bam.smooth.F
# bam.statistics$bam.smooth_RSq[subst] <- bam.smooth.Rsq

# bam.statistics$bam.smooth.pvalue[subst] <- bam.smooth.pvalue

# bam.statistics$smooth.change.onset[subst] <- change.onset
# bam.statistics$smooth.peak.change[subst] <- peak.change
# bam.statistics$smooth.decrease.onset[subst] <- decrease.onset
# bam.statistics$smooth.decrease.offset[subst] <- decrease.offset
# bam.statistics$smooth.increase.onset[subst] <- increase.onset
# bam.statistics$smooth.increase.offset[subst] <- increase.offset
# bam.statistics$smooth.last.change[subst] <- change.offset

 #Generate predictions (fitted values) based on the bam model and predication data frame
bam.fittedvalues_temp <- gratia::fitted_values(object = final_bam_dlpfc_LN, data = pred)
bam.fittedvalues_temp$.fitted2 <- plogis(bam.fittedvalues_temp$.fitted) * 33 # changed from AP's '30' as my age range is a bit higher 

# bam.fittedvalues_temp <- plogis(fitted(final_bam_CEN))*30

temp_fit <- data.frame(
  scan_age = bam.fittedvalues_temp$scan_age, 
  fitted = bam.fittedvalues_temp$.fitted, 
  fitted2 = bam.fittedvalues_temp$.fitted2, 
  se = bam.fittedvalues_temp$.se, 
  lower_ci = bam.fittedvalues_temp$.lower_ci, 
  upper_ci = bam.fittedvalues_temp$.upper_ci)
bam.fittedvalues <- bind_rows(bam.fittedvalues, temp_fit)

bam.smoothestimates_temp <- gratia::smooth_estimates(object = final_bam_dlpfc_LN, data = pred, smooth = sprintf('s(%s)',smooth_var))

temp_smooth <- data.frame(
  scan_age = bam.smoothestimates_temp$scan_age, 
  estimate = bam.smoothestimates_temp$.estimate,  
  se = bam.smoothestimates_temp$.se)
bam.smoothestimates <- bind_rows(bam.smoothestimates, temp_smooth)

temp_deriv <- data.frame(
  scan_age = derv$scan_age, 
  derivative = derv$.derivative, 
  lower = derv$.lower_ci,
  upper = derv$.upper_ci, 
  significant = derv$sig, 
  significant_deriv = derv$sig_deriv)

bam.derivatives <- bind_rows(bam.derivatives, temp_deriv)

bam.pred_temp <- ggpredict(final_bam_dlpfc_LN, terms=c("scan_age"))

temp_pred <- data.frame(
  scan_age = bam.pred_temp$x,
  predicted = bam.pred_temp$predicted, 
  se = bam.pred_temp$std.error,
  lower = bam.pred_temp$conf.low, 
  upper = bam.pred_temp$conf.high)

bam.pred <- bind_rows(bam.pred, temp_pred)  


#Calculate the average first derivative in each region at each substance
deriv_rate <- bam.derivatives %>% do(deriv_rate = mean(.$derivative)) %>% unnest(cols = "deriv_rate")

bam.statistics <- merge(bam.statistics, deriv_rate)

#Main plot 
dlpfc_ln_main <- ggeffects::ggpredict(final_bam_dlpfc_LN, terms = c("scan_age")) %>% 
  ggplot(aes(x = x, 
             y = predicted,
             group = group,
             linetype = group)) +
  geom_point(data = filtered_df, 
             aes(x = scan_age, y = fc), 
             color = "#1A4C64", 
             alpha = 0.75, 
             size = 0.25,
             inherit.aes = FALSE) +           
  geom_line(color = "#1A4C64", size = 1.5) +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high), fill = "#1A4C64", alpha = 0.2) +
  theme_modern(axis.title.space = .5, plot.title.space = .5) +
  xlab("Age (Years)") +
  ylab("Functional Connectivity") + 
  ggtitle("dlPFC - LN") +
  theme(
    plot.title = element_text(hjust = 0.6),
    legend.position = "none") +
  coord_cartesian(ylim = c(-.5, .5)) +
  scale_x_continuous(limits = c(10, 33), breaks = seq(10, 35, by = 5), expand = c(0, 0)) #make this same as below 
 
# Deriv plot 
#max_val = .38
derv <- bam.derivatives 
d1 <- ggplot(data=derv) + geom_tile(aes(x = scan_age, y = .5, fill = significant_deriv))+
      scale_fill_gradient2(low = "#1A4C64", midpoint = 0, mid = "white",
                           high = "#1A4C64")+ #, limits = c(0, max_val))+ 
    theme(aspect.ratio = .05, panel.grid.major = element_blank(),
          panel.grid.minor=element_blank(),
          panel.background=element_blank(), 
          axis.text = element_blank(),
          axis.title.x = element_blank(),
          axis.title.y = element_blank(),
          axis.line = element_blank(), 
          axis.ticks = element_blank(),
          legend.key.width = unit(1,"cm"),
          legend.key.height = unit(.5,"cm"),
          legend.position = "none",
          plot.margin = unit(c(0, 0, 0, 0), "cm"))+
    guides(fill = guide_colorbar(reverse = F,direction = "horizontal",title.position = "top")) + 
  scale_x_continuous(limits = c(10, 33), breaks = seq(10, 35, by = 5), expand = c(0, 0)) + #make this same as above 
         labs(y="All", x="Age")


# max_val & including as limits if you want your derivs to be consistent across multiple plots (range)
# Adjust the value to the max of your derivs

dlpfc_ln <- plot_grid(dlpfc_ln_main, d1, 
          ncol = 1, 
          align = "v", 
          axis = "lr",
          rel_heights = c(4, 0.5))

print(dlpfc_ln)

bam.statistics <- data.frame(
  BAM.smooth_Fvalue = numeric(),
  BAM.smooth.pvalue = numeric(),
  smooth.change.onset = numeric(),
  smooth.peak.change = numeric(),
  smooth.decrease.onset = numeric(),
  smooth.decrease.offset = numeric(),
  smooth.increase.onset = numeric(),
  smooth.increase.offset = numeric(),
  smooth.last.change = numeric()
  )

bam.fittedvalues <- data.frame(scan_age = numeric(), fitted = numeric(), fitted2 = numeric(), se = numeric(), lower_ci = numeric(), upper_ci=numeric())

bam.smoothestimates <- data.frame(scan_age = numeric(), estimate = numeric(), se = numeric())

bam.derivatives <- data.frame(scan_age = numeric(), derivative = numeric(), lower = numeric(),
                              upper = numeric(), significant = numeric(), significant_deriv = numeric()) 

bam.pred <- data.frame(scan_age = numeric(), predicted = numeric(), se = numeric(),
                              lower = numeric(), upper = numeric()) 
  
## fitting my model
temp.df <- amygdala_nuclei_7T %>%
  dplyr::select(id, visit, roiA, roiB, roiA_side, roiB_side, laterality, context, scan_age, fc) %>% 
  filter(
    (roiA == "racc" & roiB == "CAT") |
    (roiB == "racc" & roiA == "CAT")
  ) %>%
  distinct() %>%
  mutate(
    laterality = as.factor(laterality),
    roiA_side = as.factor(roiA_side),
    roiB_side = as.factor(roiB_side),
    id = as.factor(id),
    context = as.factor(context),
    visit = as.factor(visit),
    roiA = as.factor(roiA),
    roiB = as.factor(roiB),
  )

# Remove incomplete cases
temp.df <- temp.df %>%
    filter(complete.cases(dplyr::select(., fc, scan_age, laterality, roiA_side)))

# Initial BAM model
initial_bam <- bam(
    fc ~ s(scan_age, k = 3, fx = T) + laterality + roiA_side + context,
    random = list(id = ~1 + visit),
    data = temp.df,
    REML = TRUE,
    discrete = TRUE
)

# Add residuals to dataframe
temp.df <- temp.df %>%
    mutate(bam.resid = residuals(initial_bam))

# Final BAM model after removing outliers
filtered_df <- temp.df %>%
    mutate(bam.z = abs(scale(bam.resid)[, 1])) %>%
    filter(bam.z < 2)

final_bam_racc_CAT <- bam(
    fc ~ s(scan_age, k = 3, fx = T) + laterality + roiA_side + context,
    random = list(id = ~1 + visit),
    data = filtered_df,
    REML = TRUE,
    discrete = TRUE
)


bam.results <- summary(final_bam_racc_CAT)

df <- as.data.frame(unclass(final_bam_racc_CAT$model),stringsAsFactors = TRUE)
np <- 200
thisPred <- data.frame(init = rep(0,np))
theseVars <- attr(final_bam_racc_CAT$terms, "term.labels")
varClasses <- attr(final_bam_racc_CAT$terms,"dataClasses")
thisResp <- as.character(final_bam_racc_CAT$terms[[2]])
smooth_var <- "scan_age"
for (v in c(1:length(theseVars))) {
  thisVar <- theseVars[[v]]
  thisClass <- varClasses[thisVar]
  if (thisVar == smooth_var) {
    thisPred[,smooth_var] = seq(min(df[,smooth_var],na.rm=T), max(df[,smooth_var], na.rm=T), length.out = np)
  } else {
      switch (thisClass,
              "numeric" = {thisPred[,thisVar] = median(df[,thisVar])}, #make predictions based on median value
              "character" = {thisPred[,thisVar] = levels(df[,thisVar])[[1]]}, #make predictions based on first level of char
              "factor" = {thisPred[,thisVar] = levels(df[,thisVar])[[1]]}, #make predictions based on first level of factor 
              "ordered" = {thisPred[,thisVar] = levels(df[,thisVar])[[1]]} #make predictions based on first level of ordinal variable
      )
    }
  }
  pred <- thisPred %>% dplyr::select(-init)
  
## MODEL STATSTICS ##  
#bam derivatives
#Get derivatives of the smooth function using finite differences
derv <- gratia::derivatives(final_bam_racc_CAT, term = sprintf('s(%s)',smooth_var), data = pred, interval = "simultaneous", unconditional = F) #derivative at 200 indices of smooth_var with a simultaneous CI
  #Identify derivative significance window(s)
  derv <- derv %>% #add "sig" column (TRUE/FALSE) to derv
    mutate(sig = !(0 > .lower_ci & 0 < .upper_ci)) #derivative is sig if the lower CI is not < 0 while the upper CI is > 0 (i.e., when the CI does not include 0)
  derv$sig_deriv = derv$.derivative*derv$sig #add "sig_deriv derivatives column where non-significant derivatives are set to 0
  mean.derivative <- mean(derv$.derivative)
  
  #Model summary outputs
  #Signed F value for the smooth term and bam-based significance of the smooth term
  bam.smooth.F <- bam.results$s.table[1,3] #first row is s(smooth_var), third entry is F
  bam.smooth.Rsq <- bam.results$r.sq
  if(mean.derivative < 0){ #if the average derivative is less than 0, make the effect size estimate negative
    bam.smooth.F <- bam.smooth.F*-1}
  
  bam.smooth.pvalue <- bam.results$s.table[1,4] #first row is s(smooth_var), fourth entry is p-value

 #Derivative-based temporal characteristics
  #Age of developmental change onset
  if(sum(derv$sig) > 0){ #if derivative is significant at at least 1 age
    change.onset <- min(derv$scan_age[derv$sig==T])} #find first age in the smooth where derivative is significant
  if(sum(derv$sig) == 0){ #if bam derivative is never significant
    change.onset <- NA} #assign NA
 
  #Age of maximal developmental change
  if(sum(derv$sig) > 0){ 
    derv$abs_sig_deriv = round(abs(derv$sig_deriv),5) #absolute value significant derivatives
    maxval <- max(derv$abs_sig_deriv) #find the largest derivative
    window.peak.change <- derv$scan_age[derv$abs_sig_deriv == maxval] #identify the age(s) at which the derivative is greatest in absolute magnitude
    peak.change <- mean(window.peak.change)} #identify the age of peak developmental change
  if(sum(derv$sig) == 0){ 
    peak.change <- NA}  
 
  #Age of decrease onset
  if(sum(derv$sig) > 0){ 
    decreasing.range <- derv$scan_age[derv$sig_deriv < 0] #identify all ages with a significant negative derivative (i.e., smooth_var indices where y is decreasing)
    if(length(decreasing.range) > 0)
      decrease.onset <- min(decreasing.range) #find youngest age with a significant negative derivative
    if(length(decreasing.range) == 0)
      decrease.onset <- NA}
  if(sum(derv$sig) == 0){
    decrease.onset <- NA}  

    #Age of decrease offset
  if(sum(derv$sig) > 0){ 
    decreasing.range <- derv$scan_age[derv$sig_deriv < 0] #identify all ages with a significant negative derivative (i.e., smooth_var indices where y is decreasing)
    if(length(decreasing.range) > 0){
      last.decrease <- max(decreasing.range) #find oldest age with a significant negative derivative
      if(last.decrease == derv$scan_age[length(derv$scan_age)]) #if the last age of significant decrease is the oldest in the dataset
        decrease.offset <- last.decrease
      if(last.decrease != derv$scan_age[length(derv$scan_age)]){ 
        decrease.offset.row <- which(derv$scan_age == last.decrease) + 1 #use above to find the first age when the derivative is not significant
        decrease.offset <- derv$scan_age[decrease.offset.row]}
    }
    if(length(decreasing.range) == 0)
      decrease.offset <- NA}
  if(sum(derv$sig) == 0){ 
    decrease.offset <- NA}  

  #Age of increase onset
  if(sum(derv$sig) > 0){ 
    increasing.range <- derv$scan_age[derv$sig_deriv > 0] #identify all ages with a significant positive derivative (i.e., smooth_var indices where y is increasing)
    if(length(increasing.range) > 0)
      increase.onset <- min(increasing.range) #find oldest age with a significant positive derivative
    if(length(increasing.range) == 0)
      increase.onset <- NA}
  if(sum(derv$sig) == 0){ 
    increase.onset <- NA}  
 
#Age of increase offset
  if(sum(derv$sig) > 0){ 
    increasing.range <- derv$scan_age[derv$sig_deriv > 0] #identify all ages with a significant positive derivative (i.e., smooth_var indices where y is increasing)
    if(length(increasing.range) > 0){
      last.increase <- max(increasing.range) #find oldest age with a significant positive derivative
      if(last.increase == derv$scan_age[length(derv$scan_age)]) #if the last age of significant increase is the oldest in the dataset
        increase.offset <- last.increase
      if(last.increase != derv$scan_age[length(derv$scan_age)]){ 
        increase.offset.row <- which(derv$scan_age == last.increase) + 1 #use above to find the first age when the derivative is not significant
        increase.offset <- derv$scan_age[increase.offset.row]}
    }
    if(length(increasing.range) == 0)
      increase.offset <- NA}
  if(sum(derv$sig) == 0){ 
    increase.offset <- NA}  
  
 #Age of last change
  if(sum(derv$sig) > 0){ 
    change.offset <- max(derv$scan_age[derv$sig==T])} #find last age in the smooth where derivative is significant
  if(sum(derv$sig) == 0){ 
    change.offset <- NA}  
  
# bam.statistics$Traj_Group[subst] <- traj_group[subst]
# bam.statistics$bam.smooth_Fvalue[subst] <- bam.smooth.F
# bam.statistics$bam.smooth_RSq[subst] <- bam.smooth.Rsq

# bam.statistics$bam.smooth.pvalue[subst] <- bam.smooth.pvalue

# bam.statistics$smooth.change.onset[subst] <- change.onset
# bam.statistics$smooth.peak.change[subst] <- peak.change
# bam.statistics$smooth.decrease.onset[subst] <- decrease.onset
# bam.statistics$smooth.decrease.offset[subst] <- decrease.offset
# bam.statistics$smooth.increase.onset[subst] <- increase.onset
# bam.statistics$smooth.increase.offset[subst] <- increase.offset
# bam.statistics$smooth.last.change[subst] <- change.offset

 #Generate predictions (fitted values) based on the bam model and predication data frame
bam.fittedvalues_temp <- gratia::fitted_values(object = final_bam_racc_CAT, data = pred)
bam.fittedvalues_temp$.fitted2 <- plogis(bam.fittedvalues_temp$.fitted) * 33 # changed from AP's '30' as my age range is a bit higher 

# bam.fittedvalues_temp <- plogis(fitted(final_bam_CEN))*30

temp_fit <- data.frame(
  scan_age = bam.fittedvalues_temp$scan_age, 
  fitted = bam.fittedvalues_temp$.fitted, 
  fitted2 = bam.fittedvalues_temp$.fitted2, 
  se = bam.fittedvalues_temp$.se, 
  lower_ci = bam.fittedvalues_temp$.lower_ci, 
  upper_ci = bam.fittedvalues_temp$.upper_ci)
bam.fittedvalues <- bind_rows(bam.fittedvalues, temp_fit)

bam.smoothestimates_temp <- gratia::smooth_estimates(object = final_bam_racc_CAT, data = pred, smooth = sprintf('s(%s)',smooth_var))

temp_smooth <- data.frame(
  scan_age = bam.smoothestimates_temp$scan_age, 
  estimate = bam.smoothestimates_temp$.estimate,  
  se = bam.smoothestimates_temp$.se)
bam.smoothestimates <- bind_rows(bam.smoothestimates, temp_smooth)

temp_deriv <- data.frame(
  scan_age = derv$scan_age, 
  derivative = derv$.derivative, 
  lower = derv$.lower_ci,
  upper = derv$.upper_ci, 
  significant = derv$sig, 
  significant_deriv = derv$sig_deriv)

bam.derivatives <- bind_rows(bam.derivatives, temp_deriv)

bam.pred_temp <- ggpredict(final_bam_racc_CAT, terms=c("scan_age"))

temp_pred <- data.frame(
  scan_age = bam.pred_temp$x,
  predicted = bam.pred_temp$predicted, 
  se = bam.pred_temp$std.error,
  lower = bam.pred_temp$conf.low, 
  upper = bam.pred_temp$conf.high)

bam.pred <- bind_rows(bam.pred, temp_pred)  


#Calculate the average first derivative in each region at each substance
deriv_rate <- bam.derivatives %>% do(deriv_rate = mean(.$derivative)) %>% unnest(cols = "deriv_rate")

bam.statistics <- merge(bam.statistics, deriv_rate)

#Main plot 
racc_cat_main <- ggeffects::ggpredict(final_bam_racc_CAT, terms = c("scan_age")) %>% 
  ggplot(aes(x = x, 
             y = predicted,
             group = group,
             linetype = group)) +
  geom_point(data = filtered_df, 
             aes(x = scan_age, y = fc), 
             color = "#594F89", 
             alpha = 0.75, 
             size = 0.25,
             inherit.aes = FALSE) +           
  geom_line(color = "#594F89", size = 1.5) +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high), fill = "#594F89", alpha = 0.2) +
  theme_modern(axis.title.space = .5, plot.title.space = .5) +
  xlab("Age (Years)") +
  ylab("Functional Connectivity") + 
  ggtitle("rACC - CAT") +
  theme(
    plot.title = element_text(hjust = 0.6),
    legend.position = "none") +
  coord_cartesian(ylim = c(-.5, .5)) +
  scale_x_continuous(limits = c(10, 33), breaks = seq(10, 35, by = 5), expand = c(0, 0)) #make this same as below 
 
# Deriv plot 
#max_val = .38
derv <- bam.derivatives 
d1 <- ggplot(data=derv) + geom_tile(aes(x = scan_age, y = .5, fill = significant_deriv))+
      scale_fill_gradient2(low = "#594F89", midpoint = 0, mid = "white",
                           high = "#594F89")+ #, limits = c(0, max_val))+ 
    theme(aspect.ratio = .05, panel.grid.major = element_blank(),
          panel.grid.minor=element_blank(),
          panel.background=element_blank(), 
          axis.text = element_blank(),
          axis.title.x = element_blank(),
          axis.title.y = element_blank(),
          axis.line = element_blank(), 
          axis.ticks = element_blank(),
          legend.key.width = unit(1,"cm"),
          legend.key.height = unit(.5,"cm"),
          legend.position = "none",
          plot.margin = unit(c(0, 0, 0, 0), "cm"))+
    guides(fill = guide_colorbar(reverse = F,direction = "horizontal",title.position = "top")) + 
  scale_x_continuous(limits = c(10, 33), breaks = seq(10, 35, by = 5), expand = c(0, 0)) + #make this same as above 
         labs(y="All", x="Age")


# max_val & including as limits if you want your derivs to be consistent across multiple plots (range)
# Adjust the value to the max of your derivs

racc_cat <- plot_grid(racc_cat_main, d1, 
          ncol = 1, 
          align = "v", 
          axis = "lr",
          rel_heights = c(4, 0.5))

print(racc_cat)

bam.statistics <- data.frame(
  BAM.smooth_Fvalue = numeric(),
  BAM.smooth.pvalue = numeric(),
  smooth.change.onset = numeric(),
  smooth.peak.change = numeric(),
  smooth.decrease.onset = numeric(),
  smooth.decrease.offset = numeric(),
  smooth.increase.onset = numeric(),
  smooth.increase.offset = numeric(),
  smooth.last.change = numeric()
  )

bam.fittedvalues <- data.frame(scan_age = numeric(), fitted = numeric(), fitted2 = numeric(), se = numeric(), lower_ci = numeric(), upper_ci=numeric())

bam.smoothestimates <- data.frame(scan_age = numeric(), estimate = numeric(), se = numeric())

bam.derivatives <- data.frame(scan_age = numeric(), derivative = numeric(), lower = numeric(),
                              upper = numeric(), significant = numeric(), significant_deriv = numeric()) 

bam.pred <- data.frame(scan_age = numeric(), predicted = numeric(), se = numeric(),
                              lower = numeric(), upper = numeric()) 
  
## fitting my model
temp.df <- amygdala_nuclei_7T %>%
  dplyr::select(id, visit, roiA, roiB, roiA_side, roiB_side, laterality, context, scan_age, fc) %>% 
  filter(
    (roiA == "sgacc" & roiB == "CAT") |
    (roiB == "sgacc" & roiA == "CAT")
  ) %>%
  distinct() %>%
  mutate(
    laterality = as.factor(laterality),
    roiA_side = as.factor(roiA_side),
    roiB_side = as.factor(roiB_side),
    id = as.factor(id),
    context = as.factor(context),
    visit = as.factor(visit),
    roiA = as.factor(roiA),
    roiB = as.factor(roiB),
  )

# Remove incomplete cases
temp.df <- temp.df %>%
    filter(complete.cases(dplyr::select(., fc, scan_age, laterality, roiA_side)))

# Initial BAM model
initial_bam <- bam(
    fc ~ s(scan_age, k = 3, fx = T) + laterality + roiA_side + context,
    random = list(id = ~1 + visit),
    data = temp.df,
    REML = TRUE,
    discrete = TRUE
)

# Add residuals to dataframe
temp.df <- temp.df %>%
    mutate(bam.resid = residuals(initial_bam))

# Final BAM model after removing outliers
filtered_df <- temp.df %>%
    mutate(bam.z = abs(scale(bam.resid)[, 1])) %>%
    filter(bam.z < 2)

final_bam_sgacc_CAT <- bam(
    fc ~ s(scan_age, k = 3, fx = T) + laterality + roiA_side + context,
    random = list(id = ~1 + visit),
    data = filtered_df,
    REML = TRUE,
    discrete = TRUE
)


bam.results <- summary(final_bam_sgacc_CAT)

df <- as.data.frame(unclass(final_bam_sgacc_CAT$model),stringsAsFactors = TRUE)
np <- 200
thisPred <- data.frame(init = rep(0,np))
theseVars <- attr(final_bam_sgacc_CAT$terms, "term.labels")
varClasses <- attr(final_bam_sgacc_CAT$terms,"dataClasses")
thisResp <- as.character(final_bam_sgacc_CAT$terms[[2]])
smooth_var <- "scan_age"
for (v in c(1:length(theseVars))) {
  thisVar <- theseVars[[v]]
  thisClass <- varClasses[thisVar]
  if (thisVar == smooth_var) {
    thisPred[,smooth_var] = seq(min(df[,smooth_var],na.rm=T), max(df[,smooth_var], na.rm=T), length.out = np)
  } else {
      switch (thisClass,
              "numeric" = {thisPred[,thisVar] = median(df[,thisVar])}, #make predictions based on median value
              "character" = {thisPred[,thisVar] = levels(df[,thisVar])[[1]]}, #make predictions based on first level of char
              "factor" = {thisPred[,thisVar] = levels(df[,thisVar])[[1]]}, #make predictions based on first level of factor 
              "ordered" = {thisPred[,thisVar] = levels(df[,thisVar])[[1]]} #make predictions based on first level of ordinal variable
      )
    }
  }
  pred <- thisPred %>% dplyr::select(-init)
  
## MODEL STATSTICS ##  
#bam derivatives
#Get derivatives of the smooth function using finite differences
derv <- gratia::derivatives(final_bam_sgacc_CAT, term = sprintf('s(%s)',smooth_var), data = pred, interval = "simultaneous", unconditional = F) #derivative at 200 indices of smooth_var with a simultaneous CI
  #Identify derivative significance window(s)
  derv <- derv %>% #add "sig" column (TRUE/FALSE) to derv
    mutate(sig = !(0 > .lower_ci & 0 < .upper_ci)) #derivative is sig if the lower CI is not < 0 while the upper CI is > 0 (i.e., when the CI does not include 0)
  derv$sig_deriv = derv$.derivative*derv$sig #add "sig_deriv derivatives column where non-significant derivatives are set to 0
  mean.derivative <- mean(derv$.derivative)
  
  #Model summary outputs
  #Signed F value for the smooth term and bam-based significance of the smooth term
  bam.smooth.F <- bam.results$s.table[1,3] #first row is s(smooth_var), third entry is F
  bam.smooth.Rsq <- bam.results$r.sq
  if(mean.derivative < 0){ #if the average derivative is less than 0, make the effect size estimate negative
    bam.smooth.F <- bam.smooth.F*-1}
  
  bam.smooth.pvalue <- bam.results$s.table[1,4] #first row is s(smooth_var), fourth entry is p-value

 #Derivative-based temporal characteristics
  #Age of developmental change onset
  if(sum(derv$sig) > 0){ #if derivative is significant at at least 1 age
    change.onset <- min(derv$scan_age[derv$sig==T])} #find first age in the smooth where derivative is significant
  if(sum(derv$sig) == 0){ #if bam derivative is never significant
    change.onset <- NA} #assign NA
 
  #Age of maximal developmental change
  if(sum(derv$sig) > 0){ 
    derv$abs_sig_deriv = round(abs(derv$sig_deriv),5) #absolute value significant derivatives
    maxval <- max(derv$abs_sig_deriv) #find the largest derivative
    window.peak.change <- derv$scan_age[derv$abs_sig_deriv == maxval] #identify the age(s) at which the derivative is greatest in absolute magnitude
    peak.change <- mean(window.peak.change)} #identify the age of peak developmental change
  if(sum(derv$sig) == 0){ 
    peak.change <- NA}  
 
  #Age of decrease onset
  if(sum(derv$sig) > 0){ 
    decreasing.range <- derv$scan_age[derv$sig_deriv < 0] #identify all ages with a significant negative derivative (i.e., smooth_var indices where y is decreasing)
    if(length(decreasing.range) > 0)
      decrease.onset <- min(decreasing.range) #find youngest age with a significant negative derivative
    if(length(decreasing.range) == 0)
      decrease.onset <- NA}
  if(sum(derv$sig) == 0){
    decrease.onset <- NA}  

    #Age of decrease offset
  if(sum(derv$sig) > 0){ 
    decreasing.range <- derv$scan_age[derv$sig_deriv < 0] #identify all ages with a significant negative derivative (i.e., smooth_var indices where y is decreasing)
    if(length(decreasing.range) > 0){
      last.decrease <- max(decreasing.range) #find oldest age with a significant negative derivative
      if(last.decrease == derv$scan_age[length(derv$scan_age)]) #if the last age of significant decrease is the oldest in the dataset
        decrease.offset <- last.decrease
      if(last.decrease != derv$scan_age[length(derv$scan_age)]){ 
        decrease.offset.row <- which(derv$scan_age == last.decrease) + 1 #use above to find the first age when the derivative is not significant
        decrease.offset <- derv$scan_age[decrease.offset.row]}
    }
    if(length(decreasing.range) == 0)
      decrease.offset <- NA}
  if(sum(derv$sig) == 0){ 
    decrease.offset <- NA}  

  #Age of increase onset
  if(sum(derv$sig) > 0){ 
    increasing.range <- derv$scan_age[derv$sig_deriv > 0] #identify all ages with a significant positive derivative (i.e., smooth_var indices where y is increasing)
    if(length(increasing.range) > 0)
      increase.onset <- min(increasing.range) #find oldest age with a significant positive derivative
    if(length(increasing.range) == 0)
      increase.onset <- NA}
  if(sum(derv$sig) == 0){ 
    increase.onset <- NA}  
 
#Age of increase offset
  if(sum(derv$sig) > 0){ 
    increasing.range <- derv$scan_age[derv$sig_deriv > 0] #identify all ages with a significant positive derivative (i.e., smooth_var indices where y is increasing)
    if(length(increasing.range) > 0){
      last.increase <- max(increasing.range) #find oldest age with a significant positive derivative
      if(last.increase == derv$scan_age[length(derv$scan_age)]) #if the last age of significant increase is the oldest in the dataset
        increase.offset <- last.increase
      if(last.increase != derv$scan_age[length(derv$scan_age)]){ 
        increase.offset.row <- which(derv$scan_age == last.increase) + 1 #use above to find the first age when the derivative is not significant
        increase.offset <- derv$scan_age[increase.offset.row]}
    }
    if(length(increasing.range) == 0)
      increase.offset <- NA}
  if(sum(derv$sig) == 0){ 
    increase.offset <- NA}  
  
 #Age of last change
  if(sum(derv$sig) > 0){ 
    change.offset <- max(derv$scan_age[derv$sig==T])} #find last age in the smooth where derivative is significant
  if(sum(derv$sig) == 0){ 
    change.offset <- NA}  
  
# bam.statistics$Traj_Group[subst] <- traj_group[subst]
# bam.statistics$bam.smooth_Fvalue[subst] <- bam.smooth.F
# bam.statistics$bam.smooth_RSq[subst] <- bam.smooth.Rsq

# bam.statistics$bam.smooth.pvalue[subst] <- bam.smooth.pvalue

# bam.statistics$smooth.change.onset[subst] <- change.onset
# bam.statistics$smooth.peak.change[subst] <- peak.change
# bam.statistics$smooth.decrease.onset[subst] <- decrease.onset
# bam.statistics$smooth.decrease.offset[subst] <- decrease.offset
# bam.statistics$smooth.increase.onset[subst] <- increase.onset
# bam.statistics$smooth.increase.offset[subst] <- increase.offset
# bam.statistics$smooth.last.change[subst] <- change.offset

 #Generate predictions (fitted values) based on the bam model and predication data frame
bam.fittedvalues_temp <- gratia::fitted_values(object = final_bam_sgacc_CAT, data = pred)
bam.fittedvalues_temp$.fitted2 <- plogis(bam.fittedvalues_temp$.fitted) * 33 # changed from AP's '30' as my age range is a bit higher 

# bam.fittedvalues_temp <- plogis(fitted(final_bam_CEN))*30

temp_fit <- data.frame(
  scan_age = bam.fittedvalues_temp$scan_age, 
  fitted = bam.fittedvalues_temp$.fitted, 
  fitted2 = bam.fittedvalues_temp$.fitted2, 
  se = bam.fittedvalues_temp$.se, 
  lower_ci = bam.fittedvalues_temp$.lower_ci, 
  upper_ci = bam.fittedvalues_temp$.upper_ci)
bam.fittedvalues <- bind_rows(bam.fittedvalues, temp_fit)

bam.smoothestimates_temp <- gratia::smooth_estimates(object = final_bam_sgacc_CAT, data = pred, smooth = sprintf('s(%s)',smooth_var))

temp_smooth <- data.frame(
  scan_age = bam.smoothestimates_temp$scan_age, 
  estimate = bam.smoothestimates_temp$.estimate,  
  se = bam.smoothestimates_temp$.se)
bam.smoothestimates <- bind_rows(bam.smoothestimates, temp_smooth)

temp_deriv <- data.frame(
  scan_age = derv$scan_age, 
  derivative = derv$.derivative, 
  lower = derv$.lower_ci,
  upper = derv$.upper_ci, 
  significant = derv$sig, 
  significant_deriv = derv$sig_deriv)

bam.derivatives <- bind_rows(bam.derivatives, temp_deriv)

bam.pred_temp <- ggpredict(final_bam_sgacc_CAT, terms=c("scan_age"))

temp_pred <- data.frame(
  scan_age = bam.pred_temp$x,
  predicted = bam.pred_temp$predicted, 
  se = bam.pred_temp$std.error,
  lower = bam.pred_temp$conf.low, 
  upper = bam.pred_temp$conf.high)

bam.pred <- bind_rows(bam.pred, temp_pred)  


#Calculate the average first derivative in each region at each substance
deriv_rate <- bam.derivatives %>% do(deriv_rate = mean(.$derivative)) %>% unnest(cols = "deriv_rate")

bam.statistics <- merge(bam.statistics, deriv_rate)

#Main plot 
sgacc_cat_main <- ggeffects::ggpredict(final_bam_sgacc_CAT, terms = c("scan_age")) %>% 
  ggplot(aes(x = x, 
             y = predicted,
             group = group,
             linetype = group)) +
  geom_point(data = filtered_df, 
             aes(x = scan_age, y = fc), 
             color = "#B16787", 
             alpha = 0.75, 
             size = 0.25,
             inherit.aes = FALSE) +           
  geom_line(color = "#B16787", size = 1.5) +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high), fill = "#B16787", alpha = 0.2) +
  theme_modern(axis.title.space = .5, plot.title.space = .5) +
  xlab("Age (Years)") +
  ylab("Functional Connectivity") + 
  ggtitle("sgACC - CAT") +
  theme(
    plot.title = element_text(hjust = 0.6),
    legend.position = "none") +
  coord_cartesian(ylim = c(-.5, .5)) +
  scale_x_continuous(limits = c(10, 33), breaks = seq(10, 35, by = 5), expand = c(0, 0)) #make this same as below 
 
# Deriv plot 
#max_val = .38
derv <- bam.derivatives 
d1 <- ggplot(data=derv) + geom_tile(aes(x = scan_age, y = .5, fill = significant_deriv))+
      scale_fill_gradient2(low = "#B16787", midpoint = 0, mid = "white",
                           high = "#B16787")+ #, limits = c(0, max_val))+ 
    theme(aspect.ratio = .05, panel.grid.major = element_blank(),
          panel.grid.minor=element_blank(),
          panel.background=element_blank(), 
          axis.text = element_blank(),
          axis.title.x = element_blank(),
          axis.title.y = element_blank(),
          axis.line = element_blank(), 
          axis.ticks = element_blank(),
          legend.key.width = unit(1,"cm"),
          legend.key.height = unit(.5,"cm"),
          legend.position = "none",
          plot.margin = unit(c(0, 0, 0, 0), "cm"))+
    guides(fill = guide_colorbar(reverse = F,direction = "horizontal",title.position = "top")) + 
  scale_x_continuous(limits = c(10, 33), breaks = seq(10, 35, by = 5), expand = c(0, 0)) + #make this same as above 
         labs(y="All", x="Age")


# max_val & including as limits if you want your derivs to be consistent across multiple plots (range)
# Adjust the value to the max of your derivs

sgacc_cat <- plot_grid(sgacc_cat_main, d1, 
          ncol = 1, 
          align = "v", 
          axis = "lr",
          rel_heights = c(4, 0.5))

print(sgacc_cat)

bam.statistics <- data.frame(
  BAM.smooth_Fvalue = numeric(),
  BAM.smooth.pvalue = numeric(),
  smooth.change.onset = numeric(),
  smooth.peak.change = numeric(),
  smooth.decrease.onset = numeric(),
  smooth.decrease.offset = numeric(),
  smooth.increase.onset = numeric(),
  smooth.increase.offset = numeric(),
  smooth.last.change = numeric()
  )

bam.fittedvalues <- data.frame(scan_age = numeric(), fitted = numeric(), fitted2 = numeric(), se = numeric(), lower_ci = numeric(), upper_ci=numeric())

bam.smoothestimates <- data.frame(scan_age = numeric(), estimate = numeric(), se = numeric())

bam.derivatives <- data.frame(scan_age = numeric(), derivative = numeric(), lower = numeric(),
                              upper = numeric(), significant = numeric(), significant_deriv = numeric()) 

bam.pred <- data.frame(scan_age = numeric(), predicted = numeric(), se = numeric(),
                              lower = numeric(), upper = numeric()) 
  
## fitting my model
temp.df <- amygdala_nuclei_7T %>%
  dplyr::select(id, visit, roiA, roiB, roiA_side, roiB_side, laterality, context, scan_age, fc) %>% 
  filter(
    (roiA == "vacc" & roiB == "CAT") |
    (roiB == "vacc" & roiA == "CAT")
  ) %>%
  distinct() %>%
  mutate(
    laterality = as.factor(laterality),
    roiA_side = as.factor(roiA_side),
    roiB_side = as.factor(roiB_side),
    id = as.factor(id),
    context = as.factor(context),
    visit = as.factor(visit),
    roiA = as.factor(roiA),
    roiB = as.factor(roiB),
  )

# Remove incomplete cases
temp.df <- temp.df %>%
    filter(complete.cases(dplyr::select(., fc, scan_age, laterality, roiA_side)))

# Initial BAM model
initial_bam <- bam(
    fc ~ s(scan_age, k = 3, fx = T) + laterality + roiA_side + context,
    random = list(id = ~1 + visit),
    data = temp.df,
    REML = TRUE,
    discrete = TRUE
)

# Add residuals to dataframe
temp.df <- temp.df %>%
    mutate(bam.resid = residuals(initial_bam))

# Final BAM model after removing outliers
filtered_df <- temp.df %>%
    mutate(bam.z = abs(scale(bam.resid)[, 1])) %>%
    filter(bam.z < 2)

final_bam_vacc_CAT <- bam(
    fc ~ s(scan_age, k = 3, fx = T) + laterality + roiA_side + context,
    random = list(id = ~1 + visit),
    data = filtered_df,
    REML = TRUE,
    discrete = TRUE
)


bam.results <- summary(final_bam_vacc_CAT)

df <- as.data.frame(unclass(final_bam_vacc_CAT$model),stringsAsFactors = TRUE)
np <- 200
thisPred <- data.frame(init = rep(0,np))
theseVars <- attr(final_bam_vacc_CAT$terms, "term.labels")
varClasses <- attr(final_bam_vacc_CAT$terms,"dataClasses")
thisResp <- as.character(final_bam_vacc_CAT$terms[[2]])
smooth_var <- "scan_age"
for (v in c(1:length(theseVars))) {
  thisVar <- theseVars[[v]]
  thisClass <- varClasses[thisVar]
  if (thisVar == smooth_var) {
    thisPred[,smooth_var] = seq(min(df[,smooth_var],na.rm=T), max(df[,smooth_var], na.rm=T), length.out = np)
  } else {
      switch (thisClass,
              "numeric" = {thisPred[,thisVar] = median(df[,thisVar])}, #make predictions based on median value
              "character" = {thisPred[,thisVar] = levels(df[,thisVar])[[1]]}, #make predictions based on first level of char
              "factor" = {thisPred[,thisVar] = levels(df[,thisVar])[[1]]}, #make predictions based on first level of factor 
              "ordered" = {thisPred[,thisVar] = levels(df[,thisVar])[[1]]} #make predictions based on first level of ordinal variable
      )
    }
  }
  pred <- thisPred %>% dplyr::select(-init)
  
## MODEL STATSTICS ##  
#bam derivatives
#Get derivatives of the smooth function using finite differences
derv <- gratia::derivatives(final_bam_vacc_CAT, term = sprintf('s(%s)',smooth_var), data = pred, interval = "simultaneous", unconditional = F) #derivative at 200 indices of smooth_var with a simultaneous CI
  #Identify derivative significance window(s)
  derv <- derv %>% #add "sig" column (TRUE/FALSE) to derv
    mutate(sig = !(0 > .lower_ci & 0 < .upper_ci)) #derivative is sig if the lower CI is not < 0 while the upper CI is > 0 (i.e., when the CI does not include 0)
  derv$sig_deriv = derv$.derivative*derv$sig #add "sig_deriv derivatives column where non-significant derivatives are set to 0
  mean.derivative <- mean(derv$.derivative)
  
  #Model summary outputs
  #Signed F value for the smooth term and bam-based significance of the smooth term
  bam.smooth.F <- bam.results$s.table[1,3] #first row is s(smooth_var), third entry is F
  bam.smooth.Rsq <- bam.results$r.sq
  if(mean.derivative < 0){ #if the average derivative is less than 0, make the effect size estimate negative
    bam.smooth.F <- bam.smooth.F*-1}
  
  bam.smooth.pvalue <- bam.results$s.table[1,4] #first row is s(smooth_var), fourth entry is p-value

 #Derivative-based temporal characteristics
  #Age of developmental change onset
  if(sum(derv$sig) > 0){ #if derivative is significant at at least 1 age
    change.onset <- min(derv$scan_age[derv$sig==T])} #find first age in the smooth where derivative is significant
  if(sum(derv$sig) == 0){ #if bam derivative is never significant
    change.onset <- NA} #assign NA
 
  #Age of maximal developmental change
  if(sum(derv$sig) > 0){ 
    derv$abs_sig_deriv = round(abs(derv$sig_deriv),5) #absolute value significant derivatives
    maxval <- max(derv$abs_sig_deriv) #find the largest derivative
    window.peak.change <- derv$scan_age[derv$abs_sig_deriv == maxval] #identify the age(s) at which the derivative is greatest in absolute magnitude
    peak.change <- mean(window.peak.change)} #identify the age of peak developmental change
  if(sum(derv$sig) == 0){ 
    peak.change <- NA}  
 
  #Age of decrease onset
  if(sum(derv$sig) > 0){ 
    decreasing.range <- derv$scan_age[derv$sig_deriv < 0] #identify all ages with a significant negative derivative (i.e., smooth_var indices where y is decreasing)
    if(length(decreasing.range) > 0)
      decrease.onset <- min(decreasing.range) #find youngest age with a significant negative derivative
    if(length(decreasing.range) == 0)
      decrease.onset <- NA}
  if(sum(derv$sig) == 0){
    decrease.onset <- NA}  

    #Age of decrease offset
  if(sum(derv$sig) > 0){ 
    decreasing.range <- derv$scan_age[derv$sig_deriv < 0] #identify all ages with a significant negative derivative (i.e., smooth_var indices where y is decreasing)
    if(length(decreasing.range) > 0){
      last.decrease <- max(decreasing.range) #find oldest age with a significant negative derivative
      if(last.decrease == derv$scan_age[length(derv$scan_age)]) #if the last age of significant decrease is the oldest in the dataset
        decrease.offset <- last.decrease
      if(last.decrease != derv$scan_age[length(derv$scan_age)]){ 
        decrease.offset.row <- which(derv$scan_age == last.decrease) + 1 #use above to find the first age when the derivative is not significant
        decrease.offset <- derv$scan_age[decrease.offset.row]}
    }
    if(length(decreasing.range) == 0)
      decrease.offset <- NA}
  if(sum(derv$sig) == 0){ 
    decrease.offset <- NA}  

  #Age of increase onset
  if(sum(derv$sig) > 0){ 
    increasing.range <- derv$scan_age[derv$sig_deriv > 0] #identify all ages with a significant positive derivative (i.e., smooth_var indices where y is increasing)
    if(length(increasing.range) > 0)
      increase.onset <- min(increasing.range) #find oldest age with a significant positive derivative
    if(length(increasing.range) == 0)
      increase.onset <- NA}
  if(sum(derv$sig) == 0){ 
    increase.onset <- NA}  
 
#Age of increase offset
  if(sum(derv$sig) > 0){ 
    increasing.range <- derv$scan_age[derv$sig_deriv > 0] #identify all ages with a significant positive derivative (i.e., smooth_var indices where y is increasing)
    if(length(increasing.range) > 0){
      last.increase <- max(increasing.range) #find oldest age with a significant positive derivative
      if(last.increase == derv$scan_age[length(derv$scan_age)]) #if the last age of significant increase is the oldest in the dataset
        increase.offset <- last.increase
      if(last.increase != derv$scan_age[length(derv$scan_age)]){ 
        increase.offset.row <- which(derv$scan_age == last.increase) + 1 #use above to find the first age when the derivative is not significant
        increase.offset <- derv$scan_age[increase.offset.row]}
    }
    if(length(increasing.range) == 0)
      increase.offset <- NA}
  if(sum(derv$sig) == 0){ 
    increase.offset <- NA}  
  
 #Age of last change
  if(sum(derv$sig) > 0){ 
    change.offset <- max(derv$scan_age[derv$sig==T])} #find last age in the smooth where derivative is significant
  if(sum(derv$sig) == 0){ 
    change.offset <- NA}  
  
# bam.statistics$Traj_Group[subst] <- traj_group[subst]
# bam.statistics$bam.smooth_Fvalue[subst] <- bam.smooth.F
# bam.statistics$bam.smooth_RSq[subst] <- bam.smooth.Rsq

# bam.statistics$bam.smooth.pvalue[subst] <- bam.smooth.pvalue

# bam.statistics$smooth.change.onset[subst] <- change.onset
# bam.statistics$smooth.peak.change[subst] <- peak.change
# bam.statistics$smooth.decrease.onset[subst] <- decrease.onset
# bam.statistics$smooth.decrease.offset[subst] <- decrease.offset
# bam.statistics$smooth.increase.onset[subst] <- increase.onset
# bam.statistics$smooth.increase.offset[subst] <- increase.offset
# bam.statistics$smooth.last.change[subst] <- change.offset

 #Generate predictions (fitted values) based on the bam model and predication data frame
bam.fittedvalues_temp <- gratia::fitted_values(object = final_bam_vacc_CAT, data = pred)
bam.fittedvalues_temp$.fitted2 <- plogis(bam.fittedvalues_temp$.fitted) * 33 # changed from AP's '30' as my age range is a bit higher 

# bam.fittedvalues_temp <- plogis(fitted(final_bam_CEN))*30

temp_fit <- data.frame(
  scan_age = bam.fittedvalues_temp$scan_age, 
  fitted = bam.fittedvalues_temp$.fitted, 
  fitted2 = bam.fittedvalues_temp$.fitted2, 
  se = bam.fittedvalues_temp$.se, 
  lower_ci = bam.fittedvalues_temp$.lower_ci, 
  upper_ci = bam.fittedvalues_temp$.upper_ci)
bam.fittedvalues <- bind_rows(bam.fittedvalues, temp_fit)

bam.smoothestimates_temp <- gratia::smooth_estimates(object = final_bam_vacc_CAT, data = pred, smooth = sprintf('s(%s)',smooth_var))

temp_smooth <- data.frame(
  scan_age = bam.smoothestimates_temp$scan_age, 
  estimate = bam.smoothestimates_temp$.estimate,  
  se = bam.smoothestimates_temp$.se)
bam.smoothestimates <- bind_rows(bam.smoothestimates, temp_smooth)

temp_deriv <- data.frame(
  scan_age = derv$scan_age, 
  derivative = derv$.derivative, 
  lower = derv$.lower_ci,
  upper = derv$.upper_ci, 
  significant = derv$sig, 
  significant_deriv = derv$sig_deriv)

bam.derivatives <- bind_rows(bam.derivatives, temp_deriv)

bam.pred_temp <- ggpredict(final_bam_vacc_CAT, terms=c("scan_age"))

temp_pred <- data.frame(
  scan_age = bam.pred_temp$x,
  predicted = bam.pred_temp$predicted, 
  se = bam.pred_temp$std.error,
  lower = bam.pred_temp$conf.low, 
  upper = bam.pred_temp$conf.high)

bam.pred <- bind_rows(bam.pred, temp_pred)  


#Calculate the average first derivative in each region at each substance
deriv_rate <- bam.derivatives %>% do(deriv_rate = mean(.$derivative)) %>% unnest(cols = "deriv_rate")

bam.statistics <- merge(bam.statistics, deriv_rate)

#Main plot 
vacc_cat_main <- ggeffects::ggpredict(final_bam_vacc_CAT, terms = c("scan_age")) %>% 
  ggplot(aes(x = x, 
             y = predicted,
             group = group,
             linetype = group)) +
  geom_point(data = filtered_df, 
             aes(x = scan_age, y = fc), 
             color = "#835689", 
             alpha = 0.75, 
             size = 0.25,
             inherit.aes = FALSE) +           
  geom_line(color = "#835689", size = 1.5) +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high), fill = "#835689", alpha = 0.2) +
  theme_modern(axis.title.space = .5, plot.title.space = .5) +
  xlab("Age (Years)") +
  ylab("Functional Connectivity") + 
  ggtitle("vACC - CAT") +
  theme(
    plot.title = element_text(hjust = 0.6),
    legend.position = "none") +
  coord_cartesian(ylim = c(-.5, .5)) +
  scale_x_continuous(limits = c(10, 33), breaks = seq(10, 35, by = 5), expand = c(0, 0)) #make this same as below 
 
# Deriv plot 
#max_val = .38
derv <- bam.derivatives 
d1 <- ggplot(data=derv) + geom_tile(aes(x = scan_age, y = .5, fill = significant_deriv))+
      scale_fill_gradient2(low = "#835689", midpoint = 0, mid = "white",
                           high = "#835689")+ #, limits = c(0, max_val))+ 
    theme(aspect.ratio = .05, panel.grid.major = element_blank(),
          panel.grid.minor=element_blank(),
          panel.background=element_blank(), 
          axis.text = element_blank(),
          axis.title.x = element_blank(),
          axis.title.y = element_blank(),
          axis.line = element_blank(), 
          axis.ticks = element_blank(),
          legend.key.width = unit(1,"cm"),
          legend.key.height = unit(.5,"cm"),
          legend.position = "none",
          plot.margin = unit(c(0, 0, 0, 0), "cm"))+
    guides(fill = guide_colorbar(reverse = F,direction = "horizontal",title.position = "top")) + 
  scale_x_continuous(limits = c(10, 33), breaks = seq(10, 35, by = 5), expand = c(0, 0)) + #make this same as above 
         labs(y="All", x="Age")


# max_val & including as limits if you want your derivs to be consistent across multiple plots (range)
# Adjust the value to the max of your derivs

vacc_cat <- plot_grid(vacc_cat_main, d1, 
          ncol = 1, 
          align = "v", 
          axis = "lr",
          rel_heights = c(4, 0.5))

print(vacc_cat)

bam.statistics <- data.frame(
  BAM.smooth_Fvalue = numeric(),
  BAM.smooth.pvalue = numeric(),
  smooth.change.onset = numeric(),
  smooth.peak.change = numeric(),
  smooth.decrease.onset = numeric(),
  smooth.decrease.offset = numeric(),
  smooth.increase.onset = numeric(),
  smooth.increase.offset = numeric(),
  smooth.last.change = numeric()
  )

bam.fittedvalues <- data.frame(scan_age = numeric(), fitted = numeric(), fitted2 = numeric(), se = numeric(), lower_ci = numeric(), upper_ci=numeric())

bam.smoothestimates <- data.frame(scan_age = numeric(), estimate = numeric(), se = numeric())

bam.derivatives <- data.frame(scan_age = numeric(), derivative = numeric(), lower = numeric(),
                              upper = numeric(), significant = numeric(), significant_deriv = numeric()) 

bam.pred <- data.frame(scan_age = numeric(), predicted = numeric(), se = numeric(),
                              lower = numeric(), upper = numeric()) 
  
## fitting my model
temp.df <- amygdala_nuclei_7T %>%
  dplyr::select(id, visit, roiA, roiB, roiA_side, roiB_side, laterality, context, scan_age, fc) %>% 
  filter(
    (roiA == "vlpfc" & roiB == "CEN") |
    (roiB == "vlpfc" & roiA == "CEN")
  ) %>%
  distinct() %>%
  mutate(
    laterality = as.factor(laterality),
    roiA_side = as.factor(roiA_side),
    roiB_side = as.factor(roiB_side),
    id = as.factor(id),
    context = as.factor(context),
    visit = as.factor(visit),
    roiA = as.factor(roiA),
    roiB = as.factor(roiB),
  )

# Remove incomplete cases
temp.df <- temp.df %>%
    filter(complete.cases(dplyr::select(., fc, scan_age, laterality, roiA_side)))

# Initial BAM model
initial_bam <- bam(
    fc ~ s(scan_age, k = 3, fx = T) + laterality + roiA_side + context,
    random = list(id = ~1 + visit),
    data = temp.df,
    REML = TRUE,
    discrete = TRUE
)

# Add residuals to dataframe
temp.df <- temp.df %>%
    mutate(bam.resid = residuals(initial_bam))

# Final BAM model after removing outliers
filtered_df <- temp.df %>%
    mutate(bam.z = abs(scale(bam.resid)[, 1])) %>%
    filter(bam.z < 2)

final_bam_vlpfc_cen <- bam(
    fc ~ s(scan_age, k = 3, fx = T) + laterality + roiA_side + context,
    random = list(id = ~1 + visit),
    data = filtered_df,
    REML = TRUE,
    discrete = TRUE
)


bam.results <- summary(final_bam_vlpfc_cen)

df <- as.data.frame(unclass(final_bam_vlpfc_cen$model),stringsAsFactors = TRUE)
np <- 200
thisPred <- data.frame(init = rep(0,np))
theseVars <- attr(final_bam_vlpfc_cen$terms, "term.labels")
varClasses <- attr(final_bam_vlpfc_cen$terms,"dataClasses")
thisResp <- as.character(final_bam_vlpfc_cen$terms[[2]])
smooth_var <- "scan_age"
for (v in c(1:length(theseVars))) {
  thisVar <- theseVars[[v]]
  thisClass <- varClasses[thisVar]
  if (thisVar == smooth_var) {
    thisPred[,smooth_var] = seq(min(df[,smooth_var],na.rm=T), max(df[,smooth_var], na.rm=T), length.out = np)
  } else {
      switch (thisClass,
              "numeric" = {thisPred[,thisVar] = median(df[,thisVar])}, #make predictions based on median value
              "character" = {thisPred[,thisVar] = levels(df[,thisVar])[[1]]}, #make predictions based on first level of char
              "factor" = {thisPred[,thisVar] = levels(df[,thisVar])[[1]]}, #make predictions based on first level of factor 
              "ordered" = {thisPred[,thisVar] = levels(df[,thisVar])[[1]]} #make predictions based on first level of ordinal variable
      )
    }
  }
  pred <- thisPred %>% dplyr::select(-init)
  
## MODEL STATSTICS ##  
#bam derivatives
#Get derivatives of the smooth function using finite differences
derv <- gratia::derivatives(final_bam_vlpfc_cen, term = sprintf('s(%s)',smooth_var), data = pred, interval = "simultaneous", unconditional = F) #derivative at 200 indices of smooth_var with a simultaneous CI
  #Identify derivative significance window(s)
  derv <- derv %>% #add "sig" column (TRUE/FALSE) to derv
    mutate(sig = !(0 > .lower_ci & 0 < .upper_ci)) #derivative is sig if the lower CI is not < 0 while the upper CI is > 0 (i.e., when the CI does not include 0)
  derv$sig_deriv = derv$.derivative*derv$sig #add "sig_deriv derivatives column where non-significant derivatives are set to 0
  mean.derivative <- mean(derv$.derivative)
  
  #Model summary outputs
  #Signed F value for the smooth term and bam-based significance of the smooth term
  bam.smooth.F <- bam.results$s.table[1,3] #first row is s(smooth_var), third entry is F
  bam.smooth.Rsq <- bam.results$r.sq
  if(mean.derivative < 0){ #if the average derivative is less than 0, make the effect size estimate negative
    bam.smooth.F <- bam.smooth.F*-1}
  
  bam.smooth.pvalue <- bam.results$s.table[1,4] #first row is s(smooth_var), fourth entry is p-value

 #Derivative-based temporal characteristics
  #Age of developmental change onset
  if(sum(derv$sig) > 0){ #if derivative is significant at at least 1 age
    change.onset <- min(derv$scan_age[derv$sig==T])} #find first age in the smooth where derivative is significant
  if(sum(derv$sig) == 0){ #if bam derivative is never significant
    change.onset <- NA} #assign NA
 
  #Age of maximal developmental change
  if(sum(derv$sig) > 0){ 
    derv$abs_sig_deriv = round(abs(derv$sig_deriv),5) #absolute value significant derivatives
    maxval <- max(derv$abs_sig_deriv) #find the largest derivative
    window.peak.change <- derv$scan_age[derv$abs_sig_deriv == maxval] #identify the age(s) at which the derivative is greatest in absolute magnitude
    peak.change <- mean(window.peak.change)} #identify the age of peak developmental change
  if(sum(derv$sig) == 0){ 
    peak.change <- NA}  
 
  #Age of decrease onset
  if(sum(derv$sig) > 0){ 
    decreasing.range <- derv$scan_age[derv$sig_deriv < 0] #identify all ages with a significant negative derivative (i.e., smooth_var indices where y is decreasing)
    if(length(decreasing.range) > 0)
      decrease.onset <- min(decreasing.range) #find youngest age with a significant negative derivative
    if(length(decreasing.range) == 0)
      decrease.onset <- NA}
  if(sum(derv$sig) == 0){
    decrease.onset <- NA}  

    #Age of decrease offset
  if(sum(derv$sig) > 0){ 
    decreasing.range <- derv$scan_age[derv$sig_deriv < 0] #identify all ages with a significant negative derivative (i.e., smooth_var indices where y is decreasing)
    if(length(decreasing.range) > 0){
      last.decrease <- max(decreasing.range) #find oldest age with a significant negative derivative
      if(last.decrease == derv$scan_age[length(derv$scan_age)]) #if the last age of significant decrease is the oldest in the dataset
        decrease.offset <- last.decrease
      if(last.decrease != derv$scan_age[length(derv$scan_age)]){ 
        decrease.offset.row <- which(derv$scan_age == last.decrease) + 1 #use above to find the first age when the derivative is not significant
        decrease.offset <- derv$scan_age[decrease.offset.row]}
    }
    if(length(decreasing.range) == 0)
      decrease.offset <- NA}
  if(sum(derv$sig) == 0){ 
    decrease.offset <- NA}  

  #Age of increase onset
  if(sum(derv$sig) > 0){ 
    increasing.range <- derv$scan_age[derv$sig_deriv > 0] #identify all ages with a significant positive derivative (i.e., smooth_var indices where y is increasing)
    if(length(increasing.range) > 0)
      increase.onset <- min(increasing.range) #find oldest age with a significant positive derivative
    if(length(increasing.range) == 0)
      increase.onset <- NA}
  if(sum(derv$sig) == 0){ 
    increase.onset <- NA}  
 
#Age of increase offset
  if(sum(derv$sig) > 0){ 
    increasing.range <- derv$scan_age[derv$sig_deriv > 0] #identify all ages with a significant positive derivative (i.e., smooth_var indices where y is increasing)
    if(length(increasing.range) > 0){
      last.increase <- max(increasing.range) #find oldest age with a significant positive derivative
      if(last.increase == derv$scan_age[length(derv$scan_age)]) #if the last age of significant increase is the oldest in the dataset
        increase.offset <- last.increase
      if(last.increase != derv$scan_age[length(derv$scan_age)]){ 
        increase.offset.row <- which(derv$scan_age == last.increase) + 1 #use above to find the first age when the derivative is not significant
        increase.offset <- derv$scan_age[increase.offset.row]}
    }
    if(length(increasing.range) == 0)
      increase.offset <- NA}
  if(sum(derv$sig) == 0){ 
    increase.offset <- NA}  
  
 #Age of last change
  if(sum(derv$sig) > 0){ 
    change.offset <- max(derv$scan_age[derv$sig==T])} #find last age in the smooth where derivative is significant
  if(sum(derv$sig) == 0){ 
    change.offset <- NA}  
  
# bam.statistics$Traj_Group[subst] <- traj_group[subst]
# bam.statistics$bam.smooth_Fvalue[subst] <- bam.smooth.F
# bam.statistics$bam.smooth_RSq[subst] <- bam.smooth.Rsq

# bam.statistics$bam.smooth.pvalue[subst] <- bam.smooth.pvalue

# bam.statistics$smooth.change.onset[subst] <- change.onset
# bam.statistics$smooth.peak.change[subst] <- peak.change
# bam.statistics$smooth.decrease.onset[subst] <- decrease.onset
# bam.statistics$smooth.decrease.offset[subst] <- decrease.offset
# bam.statistics$smooth.increase.onset[subst] <- increase.onset
# bam.statistics$smooth.increase.offset[subst] <- increase.offset
# bam.statistics$smooth.last.change[subst] <- change.offset

 #Generate predictions (fitted values) based on the bam model and predication data frame
bam.fittedvalues_temp <- gratia::fitted_values(object = final_bam_vlpfc_cen, data = pred)
bam.fittedvalues_temp$.fitted2 <- plogis(bam.fittedvalues_temp$.fitted) * 33 # changed from AP's '30' as my age range is a bit higher 

# bam.fittedvalues_temp <- plogis(fitted(final_bam_CEN))*30

temp_fit <- data.frame(
  scan_age = bam.fittedvalues_temp$scan_age, 
  fitted = bam.fittedvalues_temp$.fitted, 
  fitted2 = bam.fittedvalues_temp$.fitted2, 
  se = bam.fittedvalues_temp$.se, 
  lower_ci = bam.fittedvalues_temp$.lower_ci, 
  upper_ci = bam.fittedvalues_temp$.upper_ci)
bam.fittedvalues <- bind_rows(bam.fittedvalues, temp_fit)

bam.smoothestimates_temp <- gratia::smooth_estimates(object = final_bam_vlpfc_cen, data = pred, smooth = sprintf('s(%s)',smooth_var))

temp_smooth <- data.frame(
  scan_age = bam.smoothestimates_temp$scan_age, 
  estimate = bam.smoothestimates_temp$.estimate,  
  se = bam.smoothestimates_temp$.se)
bam.smoothestimates <- bind_rows(bam.smoothestimates, temp_smooth)

temp_deriv <- data.frame(
  scan_age = derv$scan_age, 
  derivative = derv$.derivative, 
  lower = derv$.lower_ci,
  upper = derv$.upper_ci, 
  significant = derv$sig, 
  significant_deriv = derv$sig_deriv)

bam.derivatives <- bind_rows(bam.derivatives, temp_deriv)

bam.pred_temp <- ggpredict(final_bam_vlpfc_cen, terms=c("scan_age"))

temp_pred <- data.frame(
  scan_age = bam.pred_temp$x,
  predicted = bam.pred_temp$predicted, 
  se = bam.pred_temp$std.error,
  lower = bam.pred_temp$conf.low, 
  upper = bam.pred_temp$conf.high)

bam.pred <- bind_rows(bam.pred, temp_pred)  


#Calculate the average first derivative in each region at each substance
deriv_rate <- bam.derivatives %>% do(deriv_rate = mean(.$derivative)) %>% unnest(cols = "deriv_rate")

bam.statistics <- merge(bam.statistics, deriv_rate)

#Main plot 
vlpfc_cen_main <- ggeffects::ggpredict(final_bam_vlpfc_cen, terms = c("scan_age")) %>% 
  ggplot(aes(x = x, 
             y = predicted,
             group = group,
             linetype = group)) +
  geom_point(data = filtered_df, 
             aes(x = scan_age, y = fc), 
             color = "#0C4740", 
             alpha = 0.75, 
             size = 0.25,
             inherit.aes = FALSE) +           
  geom_line(color = "#0C4740", size = 1.5) +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high), fill = "#0C4740", alpha = 0.2) +
  theme_modern(axis.title.space = .5, plot.title.space = .5) +
  xlab("Age (Years)") +
  ylab("Functional Connectivity") + 
  ggtitle("vlPFC - CEN") +
  theme(
    plot.title = element_text(hjust = 0.6),
    legend.position = "none") +
  coord_cartesian(ylim = c(-.5, .5)) +
  scale_x_continuous(limits = c(10, 33), breaks = seq(10, 35, by = 5), expand = c(0, 0)) #make this same as below 
 
# Deriv plot 
#max_val = .38
derv <- bam.derivatives 
d1 <- ggplot(data=derv) + geom_tile(aes(x = scan_age, y = .5, fill = significant_deriv))+
      scale_fill_gradient2(low = "#0C4740", midpoint = 0, mid = "white",
                           high = "#0C4740")+ #, limits = c(0, max_val))+ 
    theme(aspect.ratio = .05, panel.grid.major = element_blank(),
          panel.grid.minor=element_blank(),
          panel.background=element_blank(), 
          axis.text = element_blank(),
          axis.title.x = element_blank(),
          axis.title.y = element_blank(),
          axis.line = element_blank(), 
          axis.ticks = element_blank(),
          legend.key.width = unit(1,"cm"),
          legend.key.height = unit(.5,"cm"),
          legend.position = "none",
          plot.margin = unit(c(0, 0, 0, 0), "cm"))+
    guides(fill = guide_colorbar(reverse = F,direction = "horizontal",title.position = "top")) + 
  scale_x_continuous(limits = c(10, 33), breaks = seq(10, 35, by = 5), expand = c(0, 0)) + #make this same as above 
         labs(y="All", x="Age")


# max_val & including as limits if you want your derivs to be consistent across multiple plots (range)
# Adjust the value to the max of your derivs

vlpfc_cen <- plot_grid(vlpfc_cen_main, d1, 
          ncol = 1, 
          align = "v", 
          axis = "lr",
          rel_heights = c(4, 0.5))

print(vlpfc_cen)

bam.statistics <- data.frame(
  BAM.smooth_Fvalue = numeric(),
  BAM.smooth.pvalue = numeric(),
  smooth.change.onset = numeric(),
  smooth.peak.change = numeric(),
  smooth.decrease.onset = numeric(),
  smooth.decrease.offset = numeric(),
  smooth.increase.onset = numeric(),
  smooth.increase.offset = numeric(),
  smooth.last.change = numeric()
  )

bam.fittedvalues <- data.frame(scan_age = numeric(), fitted = numeric(), fitted2 = numeric(), se = numeric(), lower_ci = numeric(), upper_ci=numeric())

bam.smoothestimates <- data.frame(scan_age = numeric(), estimate = numeric(), se = numeric())

bam.derivatives <- data.frame(scan_age = numeric(), derivative = numeric(), lower = numeric(),
                              upper = numeric(), significant = numeric(), significant_deriv = numeric()) 

bam.pred <- data.frame(scan_age = numeric(), predicted = numeric(), se = numeric(),
                              lower = numeric(), upper = numeric()) 
  
## fitting my model
temp.df <- amygdala_nuclei_7T %>%
  dplyr::select(id, visit, roiA, roiB, roiA_side, roiB_side, laterality, context, scan_age, fc) %>% 
  filter(
    (roiA == "vlpfc" & roiB == "LN") |
    (roiB == "vlpfc" & roiA == "LN")
  ) %>%
  distinct() %>%
  mutate(
    laterality = as.factor(laterality),
    roiA_side = as.factor(roiA_side),
    roiB_side = as.factor(roiB_side),
    id = as.factor(id),
    context = as.factor(context),
    visit = as.factor(visit),
    roiA = as.factor(roiA),
    roiB = as.factor(roiB),
  )

# Remove incomplete cases
temp.df <- temp.df %>%
    filter(complete.cases(dplyr::select(., fc, scan_age, laterality, roiA_side)))

# Initial BAM model
initial_bam <- bam(
    fc ~ s(scan_age, k = 3, fx = T) + laterality + roiA_side + context,
    random = list(id = ~1 + visit),
    data = temp.df,
    REML = TRUE,
    discrete = TRUE
)

# Add residuals to dataframe
temp.df <- temp.df %>%
    mutate(bam.resid = residuals(initial_bam))

# Final BAM model after removing outliers
filtered_df <- temp.df %>%
    mutate(bam.z = abs(scale(bam.resid)[, 1])) %>%
    filter(bam.z < 2)

final_bam_vlpfc_ln <- bam(
    fc ~ s(scan_age, k = 3, fx = T) + laterality + roiA_side + context,
    random = list(id = ~1 + visit),
    data = filtered_df,
    REML = TRUE,
    discrete = TRUE
)


bam.results <- summary(final_bam_vlpfc_ln)

df <- as.data.frame(unclass(final_bam_vlpfc_ln$model),stringsAsFactors = TRUE)
np <- 200
thisPred <- data.frame(init = rep(0,np))
theseVars <- attr(final_bam_vlpfc_ln$terms, "term.labels")
varClasses <- attr(final_bam_vlpfc_ln$terms,"dataClasses")
thisResp <- as.character(final_bam_vlpfc_ln$terms[[2]])
smooth_var <- "scan_age"
for (v in c(1:length(theseVars))) {
  thisVar <- theseVars[[v]]
  thisClass <- varClasses[thisVar]
  if (thisVar == smooth_var) {
    thisPred[,smooth_var] = seq(min(df[,smooth_var],na.rm=T), max(df[,smooth_var], na.rm=T), length.out = np)
  } else {
      switch (thisClass,
              "numeric" = {thisPred[,thisVar] = median(df[,thisVar])}, #make predictions based on median value
              "character" = {thisPred[,thisVar] = levels(df[,thisVar])[[1]]}, #make predictions based on first level of char
              "factor" = {thisPred[,thisVar] = levels(df[,thisVar])[[1]]}, #make predictions based on first level of factor 
              "ordered" = {thisPred[,thisVar] = levels(df[,thisVar])[[1]]} #make predictions based on first level of ordinal variable
      )
    }
  }
  pred <- thisPred %>% dplyr::select(-init)
  
## MODEL STATSTICS ##  
#bam derivatives
#Get derivatives of the smooth function using finite differences
derv <- gratia::derivatives(final_bam_vlpfc_ln, term = sprintf('s(%s)',smooth_var), data = pred, interval = "simultaneous", unconditional = F) #derivative at 200 indices of smooth_var with a simultaneous CI
  #Identify derivative significance window(s)
  derv <- derv %>% #add "sig" column (TRUE/FALSE) to derv
    mutate(sig = !(0 > .lower_ci & 0 < .upper_ci)) #derivative is sig if the lower CI is not < 0 while the upper CI is > 0 (i.e., when the CI does not include 0)
  derv$sig_deriv = derv$.derivative*derv$sig #add "sig_deriv derivatives column where non-significant derivatives are set to 0
  mean.derivative <- mean(derv$.derivative)
  
  #Model summary outputs
  #Signed F value for the smooth term and bam-based significance of the smooth term
  bam.smooth.F <- bam.results$s.table[1,3] #first row is s(smooth_var), third entry is F
  bam.smooth.Rsq <- bam.results$r.sq
  if(mean.derivative < 0){ #if the average derivative is less than 0, make the effect size estimate negative
    bam.smooth.F <- bam.smooth.F*-1}
  
  bam.smooth.pvalue <- bam.results$s.table[1,4] #first row is s(smooth_var), fourth entry is p-value

 #Derivative-based temporal characteristics
  #Age of developmental change onset
  if(sum(derv$sig) > 0){ #if derivative is significant at at least 1 age
    change.onset <- min(derv$scan_age[derv$sig==T])} #find first age in the smooth where derivative is significant
  if(sum(derv$sig) == 0){ #if bam derivative is never significant
    change.onset <- NA} #assign NA
 
  #Age of maximal developmental change
  if(sum(derv$sig) > 0){ 
    derv$abs_sig_deriv = round(abs(derv$sig_deriv),5) #absolute value significant derivatives
    maxval <- max(derv$abs_sig_deriv) #find the largest derivative
    window.peak.change <- derv$scan_age[derv$abs_sig_deriv == maxval] #identify the age(s) at which the derivative is greatest in absolute magnitude
    peak.change <- mean(window.peak.change)} #identify the age of peak developmental change
  if(sum(derv$sig) == 0){ 
    peak.change <- NA}  
 
  #Age of decrease onset
  if(sum(derv$sig) > 0){ 
    decreasing.range <- derv$scan_age[derv$sig_deriv < 0] #identify all ages with a significant negative derivative (i.e., smooth_var indices where y is decreasing)
    if(length(decreasing.range) > 0)
      decrease.onset <- min(decreasing.range) #find youngest age with a significant negative derivative
    if(length(decreasing.range) == 0)
      decrease.onset <- NA}
  if(sum(derv$sig) == 0){
    decrease.onset <- NA}  

    #Age of decrease offset
  if(sum(derv$sig) > 0){ 
    decreasing.range <- derv$scan_age[derv$sig_deriv < 0] #identify all ages with a significant negative derivative (i.e., smooth_var indices where y is decreasing)
    if(length(decreasing.range) > 0){
      last.decrease <- max(decreasing.range) #find oldest age with a significant negative derivative
      if(last.decrease == derv$scan_age[length(derv$scan_age)]) #if the last age of significant decrease is the oldest in the dataset
        decrease.offset <- last.decrease
      if(last.decrease != derv$scan_age[length(derv$scan_age)]){ 
        decrease.offset.row <- which(derv$scan_age == last.decrease) + 1 #use above to find the first age when the derivative is not significant
        decrease.offset <- derv$scan_age[decrease.offset.row]}
    }
    if(length(decreasing.range) == 0)
      decrease.offset <- NA}
  if(sum(derv$sig) == 0){ 
    decrease.offset <- NA}  

  #Age of increase onset
  if(sum(derv$sig) > 0){ 
    increasing.range <- derv$scan_age[derv$sig_deriv > 0] #identify all ages with a significant positive derivative (i.e., smooth_var indices where y is increasing)
    if(length(increasing.range) > 0)
      increase.onset <- min(increasing.range) #find oldest age with a significant positive derivative
    if(length(increasing.range) == 0)
      increase.onset <- NA}
  if(sum(derv$sig) == 0){ 
    increase.onset <- NA}  
 
#Age of increase offset
  if(sum(derv$sig) > 0){ 
    increasing.range <- derv$scan_age[derv$sig_deriv > 0] #identify all ages with a significant positive derivative (i.e., smooth_var indices where y is increasing)
    if(length(increasing.range) > 0){
      last.increase <- max(increasing.range) #find oldest age with a significant positive derivative
      if(last.increase == derv$scan_age[length(derv$scan_age)]) #if the last age of significant increase is the oldest in the dataset
        increase.offset <- last.increase
      if(last.increase != derv$scan_age[length(derv$scan_age)]){ 
        increase.offset.row <- which(derv$scan_age == last.increase) + 1 #use above to find the first age when the derivative is not significant
        increase.offset <- derv$scan_age[increase.offset.row]}
    }
    if(length(increasing.range) == 0)
      increase.offset <- NA}
  if(sum(derv$sig) == 0){ 
    increase.offset <- NA}  
  
 #Age of last change
  if(sum(derv$sig) > 0){ 
    change.offset <- max(derv$scan_age[derv$sig==T])} #find last age in the smooth where derivative is significant
  if(sum(derv$sig) == 0){ 
    change.offset <- NA}  
  
# bam.statistics$Traj_Group[subst] <- traj_group[subst]
# bam.statistics$bam.smooth_Fvalue[subst] <- bam.smooth.F
# bam.statistics$bam.smooth_RSq[subst] <- bam.smooth.Rsq

# bam.statistics$bam.smooth.pvalue[subst] <- bam.smooth.pvalue

# bam.statistics$smooth.change.onset[subst] <- change.onset
# bam.statistics$smooth.peak.change[subst] <- peak.change
# bam.statistics$smooth.decrease.onset[subst] <- decrease.onset
# bam.statistics$smooth.decrease.offset[subst] <- decrease.offset
# bam.statistics$smooth.increase.onset[subst] <- increase.onset
# bam.statistics$smooth.increase.offset[subst] <- increase.offset
# bam.statistics$smooth.last.change[subst] <- change.offset

 #Generate predictions (fitted values) based on the bam model and predication data frame
bam.fittedvalues_temp <- gratia::fitted_values(object = final_bam_vlpfc_ln, data = pred)
bam.fittedvalues_temp$.fitted2 <- plogis(bam.fittedvalues_temp$.fitted) * 33 # changed from AP's '30' as my age range is a bit higher 

# bam.fittedvalues_temp <- plogis(fitted(final_bam_CEN))*30

temp_fit <- data.frame(
  scan_age = bam.fittedvalues_temp$scan_age, 
  fitted = bam.fittedvalues_temp$.fitted, 
  fitted2 = bam.fittedvalues_temp$.fitted2, 
  se = bam.fittedvalues_temp$.se, 
  lower_ci = bam.fittedvalues_temp$.lower_ci, 
  upper_ci = bam.fittedvalues_temp$.upper_ci)
bam.fittedvalues <- bind_rows(bam.fittedvalues, temp_fit)

bam.smoothestimates_temp <- gratia::smooth_estimates(object = final_bam_vlpfc_ln, data = pred, smooth = sprintf('s(%s)',smooth_var))

temp_smooth <- data.frame(
  scan_age = bam.smoothestimates_temp$scan_age, 
  estimate = bam.smoothestimates_temp$.estimate,  
  se = bam.smoothestimates_temp$.se)
bam.smoothestimates <- bind_rows(bam.smoothestimates, temp_smooth)

temp_deriv <- data.frame(
  scan_age = derv$scan_age, 
  derivative = derv$.derivative, 
  lower = derv$.lower_ci,
  upper = derv$.upper_ci, 
  significant = derv$sig, 
  significant_deriv = derv$sig_deriv)

bam.derivatives <- bind_rows(bam.derivatives, temp_deriv)

bam.pred_temp <- ggpredict(final_bam_vlpfc_ln, terms=c("scan_age"))

temp_pred <- data.frame(
  scan_age = bam.pred_temp$x,
  predicted = bam.pred_temp$predicted, 
  se = bam.pred_temp$std.error,
  lower = bam.pred_temp$conf.low, 
  upper = bam.pred_temp$conf.high)

bam.pred <- bind_rows(bam.pred, temp_pred)  


#Calculate the average first derivative in each region at each substance
deriv_rate <- bam.derivatives %>% do(deriv_rate = mean(.$derivative)) %>% unnest(cols = "deriv_rate")

bam.statistics <- merge(bam.statistics, deriv_rate)

#Main plot 
vlpfc_ln_main <- ggeffects::ggpredict(final_bam_vlpfc_ln, terms = c("scan_age")) %>% 
  ggplot(aes(x = x, 
             y = predicted,
             group = group,
             linetype = group)) +
  geom_point(data = filtered_df, 
             aes(x = scan_age, y = fc), 
             color = "#364D7E", 
             alpha = 0.75, 
             size = 0.25,
             inherit.aes = FALSE) +           
  geom_line(color = "#364D7E", size = 1.5) +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high), fill = "#364D7E", alpha = 0.2) +
  theme_modern(axis.title.space = .5, plot.title.space = .5) +
  xlab("Age (Years)") +
  ylab("Functional Connectivity") + 
  ggtitle("vlPFC - LN") +
  theme(
    plot.title = element_text(hjust = 0.6),
    legend.position = "none") +
  coord_cartesian(ylim = c(-.5, .5)) +
  scale_x_continuous(limits = c(10, 33), breaks = seq(10, 35, by = 5), expand = c(0, 0)) #make this same as below 
 
# Deriv plot 
#max_val = .38
derv <- bam.derivatives 
d1 <- ggplot(data=derv) + geom_tile(aes(x = scan_age, y = .5, fill = significant_deriv))+
      scale_fill_gradient2(low = "#364D7E", midpoint = 0, mid = "white",
                           high = "#364D7E")+ #, limits = c(0, max_val))+ 
    theme(aspect.ratio = .05, panel.grid.major = element_blank(),
          panel.grid.minor=element_blank(),
          panel.background=element_blank(), 
          axis.text = element_blank(),
          axis.title.x = element_blank(),
          axis.title.y = element_blank(),
          axis.line = element_blank(), 
          axis.ticks = element_blank(),
          legend.key.width = unit(1,"cm"),
          legend.key.height = unit(.5,"cm"),
          legend.position = "none",
          plot.margin = unit(c(0, 0, 0, 0), "cm"))+
    guides(fill = guide_colorbar(reverse = F,direction = "horizontal",title.position = "top")) + 
  scale_x_continuous(limits = c(10, 33), breaks = seq(10, 35, by = 5), expand = c(0, 0)) + #make this same as above 
         labs(y="All", x="Age")


# max_val & including as limits if you want your derivs to be consistent across multiple plots (range)
# Adjust the value to the max of your derivs

vlpfc_ln <- plot_grid(vlpfc_ln_main, d1, 
          ncol = 1, 
          align = "v", 
          axis = "lr",
          rel_heights = c(4, 0.5))

print(vlpfc_ln)

### rearranging by subregions

row1 <- ggarrange(
  NULL, antvmpfc_cen, vlpfc_cen, NULL,
  ncol = 4, nrow = 1,
  widths = c(0.5, 1, 1, 0.5),
  labels = c("", "A", "B", "")
)

row2 <- ggarrange(
  dlpfc_bn, dlpfc_ln, vlpfc_ln,
  ncol = 3, nrow = 1,
  labels = c("C", "D", "E")
)

row3 <- ggarrange(
  sgacc_cat, vacc_cat, racc_cat,
  ncol = 3, nrow = 1,
  labels = c("F", "G", "H")
)

row1_with_title <- annotate_figure(row1, 
                                   top = text_grob("Centromedial Amygdala", 
                                                   size = 14, face = "bold"))

row2_with_title <- annotate_figure(row2, 
                                   top = text_grob("Basolateral Amygdala", 
                                                   size = 14, face = "bold"))

row3_with_title <- annotate_figure(row3, 
                                   top = text_grob("Superficial Amygdala", 
                                                   size = 14, face = "bold"))

# Combine all rows vertically
final_figure <- ggarrange(
  row1_with_title,
  row2_with_title,
  row3_with_title,
  ncol = 1, 
  nrow = 3,
  heights = c(1, 1, 1),  # Equal heights for all rows
  align = "v"            # Vertical alignment
)

# Display the figure
print(final_figure)

```

# supp. figure: all (sig/non-sig) functional connections by age
```{r}
library(dplyr)
library(mgcv)
library(ggplot2)
library(ggpubr)
library(ggeffects)
library(ggthemes)

custom_colors <- c("ABN" = "#E99235", "BN" = "#CF3F4E", "CAT" = "#173C78",
                   "CEN" = "#C63CF6", "LN" = "#4884B6")

amyg_regions <- c("ABN", "BN", "CAT", "CEN", "LN")
pfc_regions <- c("antvmpfc", "dlpfc", "racc", "sgacc", "vacc", "vlpfc")

run_pfc_analysis_and_plot <- function(pfc_roi, main_df) {

  temp_df <- main_df %>%
    filter(
      (roiA == pfc_roi & roiB %in% amyg_regions) |
      (roiB == pfc_roi & roiA %in% amyg_regions)
    ) %>%
    distinct() %>% 
    mutate(
      amyg_roi = if_else(roiA %in% amyg_regions, as.character(roiA), as.character(roiB)),
      pfc_side = if_else(roiA == pfc_roi, as.character(roiA_side), as.character(roiB_side)),
      across(c(laterality, roiA_side, roiB_side, id, context, visit, 
               roiA, roiB, amyg_roi, pfc_side), as.factor)
    ) %>%
    filter(complete.cases(fc, scan_age, laterality, pfc_side))

  bam_formula <- fc ~ s(scan_age, k = 3, fx = TRUE, by = amyg_roi) + 
                      s(scan_age, k = 3, fx = TRUE) + 
                      amyg_roi + laterality + pfc_side + context

  random_effect <- list(id = ~1 + visit)

  initial_bam <- bam(bam_formula, random = random_effect, data = temp_df, REML = TRUE, discrete = TRUE)

  filtered_df <- temp_df %>%
    mutate(
      bam.resid = residuals(initial_bam),
      bam.z = abs(scale(bam.resid)[, 1])
    ) %>%
    filter(bam.z < 2)

  final_bam <- bam(bam_formula, random = random_effect, data = filtered_df, REML = TRUE, discrete = TRUE)

  pred_data <- ggeffects::ggpredict(final_bam, terms = c("scan_age", "amyg_roi"))
  
  plot_title <- case_when(
      pfc_roi == "antvmpfc" ~ "ant. vmPFC",
      pfc_roi == "dlpfc"    ~ "dlPFC",
      pfc_roi == "racc"     ~ "rACC",
      pfc_roi == "sgacc"    ~ "sgACC",
      pfc_roi == "vacc"     ~ "vACC",
      pfc_roi == "vlpfc"    ~ "vlPFC",
      TRUE                  ~ pfc_roi
  )

  p <- ggplot(pred_data, aes(x = x, y = predicted, group = group, color = group)) +
    geom_line(linewidth = 1) +
    geom_ribbon(aes(ymin = conf.low, ymax = conf.high, fill = group), alpha = 0.2, color = NA) +
    theme_modern(axis.title.space = 0.5, plot.title.space = 0.5) +
    scale_color_manual(values = custom_colors, name = "Amygdala Nuclei") +
    scale_fill_manual(values = custom_colors, name = "Amygdala Nuclei") +
    labs(
      x = "Age (Years)",
      y = "Functional Connectivity",
      title = plot_title
    ) +
    theme(
      plot.title = element_text(hjust = 0.5), 
      legend.title = element_text(size = 10),
      legend.text = element_text(size = 8)
    ) +
    coord_cartesian(ylim = c(-0.2, 0.2))

  return(p)
}

plot_list <- lapply(pfc_regions, run_pfc_analysis_and_plot, main_df = amygdala_nuclei_7T)

ggarrange(
  plotlist = plot_list,
  nrow = 2,
  ncol = 3,
  common.legend = TRUE,
  legend = "right",
  labels = c("A", "B", "C", "D", "E", "F"),
  align = "hv"
)

```

# supp. figure: age-related connections by sex
```{r}
# Data preparation
temp.df <- amygdala_nuclei_7T %>%
  dplyr::select(id, visit, roiA, roiB, roiA_side, roiB_side, laterality, context, scan_age, fc, sex) %>% 
  filter(roiA %in% c("antvmpfc", "CEN"), roiB %in% c("antvmpfc", "CEN"), roiA != roiB) %>%
  distinct() %>%
  mutate(
    laterality = as.factor(laterality),
    roiA_side = as.factor(roiA_side),
    roiB_side = as.factor(roiB_side),
    id = as.factor(id),
    context = as.factor(context),
    visit = as.factor(visit),
    roiA = as.factor(roiA),
    roiB = as.factor(roiB),
    sex = as.factor(sex)
  )

# Remove incomplete cases
temp.df <- temp.df %>%
    filter(complete.cases(dplyr::select(., fc, scan_age, laterality, roiA_side, sex)))

# Create ordered factor for sex 
temp.df$osex <- ordered(temp.df$sex, levels = c("M","F"))

# Initial BAM model
initial_bam <- bam(
    fc ~ s(scan_age, k = 3, fx = T, by = osex) + s(scan_age, k = 3, fx = T) + laterality + roiA_side + context + osex,
    random = list(id = ~1 + visit),
    data = temp.df,
    REML = TRUE,
    discrete = TRUE
)

# Add residuals to dataframe
temp.df <- temp.df %>%
    mutate(bam.resid = residuals(initial_bam))

# Final BAM model after removing outliers
filtered_df <- temp.df %>%
    mutate(bam.z = abs(scale(bam.resid)[, 1])) %>%
    filter(bam.z < 2)

final_bam_antvmpfc_CEN_sex <- bam(
    fc ~ s(scan_age, k = 3, fx = T, by = osex) + s(scan_age, k = 3, fx = T) + laterality + roiA_side + context + osex,
    random = list(id = ~1 + visit),
    data = filtered_df,
    REML = TRUE,
    discrete = TRUE
)

# Summary
model_parameters(final_bam_antvmpfc_CEN_sex, standardize = "refit")

# Viz
antvmpfc_CEN_sex_plot <- ggeffects::ggpredict(final_bam_antvmpfc_CEN_sex, terms = c("scan_age", "osex")) %>%
    ggplot(aes(
        x = x,
        y = predicted,
        group = group
    )) +
    geom_line(aes(color = group), size = 1.25) +
    geom_ribbon(aes(ymin = conf.low, ymax = conf.high, fill = group), alpha = 0.2) +
    theme_modern(axis.title.space = .5, plot.title.space = .5) +
    xlab("Age (Years)") +
    ylab("Functional Connectivity") +
    ggtitle("ant. vmPFC - CEN") +
    scale_color_manual(name = "Sex", values = c("M" = scales::hue_pal()(2)[2], "F" = scales::hue_pal()(2)[1])) +
    scale_fill_manual(name = "Sex", values = c("M" = scales::hue_pal()(2)[2], "F" = scales::hue_pal()(2)[1])) +
    theme(
        plot.title = element_text(hjust = 0.6),
        legend.position = "none"
    ) +
    coord_cartesian(ylim = c(-.2, .2))
# Data preparation
temp.df <- amygdala_nuclei_7T %>%
  dplyr::select(id, visit, roiA, roiB, roiA_side, roiB_side, laterality, context, scan_age, fc, sex) %>% 
  filter(roiA %in% c("dlpfc", "BN"), roiB %in% c("dlpfc", "BN"), roiA != roiB) %>%
  distinct() %>%
  mutate(
    laterality = as.factor(laterality),
    roiA_side = as.factor(roiA_side),
    roiB_side = as.factor(roiB_side),
    id = as.factor(id),
    context = as.factor(context),
    visit = as.factor(visit),
    roiA = as.factor(roiA),
    roiB = as.factor(roiB),
    sex = as.factor(sex)
  )

# Remove incomplete cases
temp.df <- temp.df %>%
    filter(complete.cases(dplyr::select(., fc, scan_age, laterality, roiA_side, sex)))

# Create ordered factor for sex 
temp.df$osex <- ordered(temp.df$sex, levels = c("M","F"))

# Initial BAM model
initial_bam <- bam(
    fc ~ s(scan_age, k = 3, fx = T, by = osex) + s(scan_age, k = 3, fx = T) + laterality + roiA_side + context + osex,
    random = list(id = ~1 + visit),
    data = temp.df,
    REML = TRUE,
    discrete = TRUE
)

# Add residuals to dataframe
temp.df <- temp.df %>%
    mutate(bam.resid = residuals(initial_bam))

# Final BAM model after removing outliers
filtered_df <- temp.df %>%
    mutate(bam.z = abs(scale(bam.resid)[, 1])) %>%
    filter(bam.z < 2)

final_bam_dlpfc_BN_sex <- bam(
    fc ~ s(scan_age, k = 3, fx = T, by = osex) + s(scan_age, k = 3, fx = T) + laterality + roiA_side + context + osex,
    random = list(id = ~1 + visit),
    data = filtered_df,
    REML = TRUE,
    discrete = TRUE
)

# Summary
model_parameters(final_bam_dlpfc_BN_sex, standardize = "refit")

# Viz
dlpfc_BN_sex_plot <- ggeffects::ggpredict(final_bam_dlpfc_BN_sex, terms = c("scan_age", "osex")) %>%
    ggplot(aes(
        x = x,
        y = predicted,
        group = group
    )) +
    geom_line(aes(color = group), size = 1.25) +
    geom_ribbon(aes(ymin = conf.low, ymax = conf.high, fill = group), alpha = 0.2) +
    theme_modern(axis.title.space = .5, plot.title.space = .5) +
    xlab("Age (Years)") +
    ylab("Functional Connectivity") +
    ggtitle("dlPFC - BN") +
    scale_color_manual(name = "Sex", values = c("M" = scales::hue_pal()(2)[2], "F" = scales::hue_pal()(2)[1])) +
    scale_fill_manual(name = "Sex", values = c("M" = scales::hue_pal()(2)[2], "F" = scales::hue_pal()(2)[1])) +
    theme(
        plot.title = element_text(hjust = 0.6),
        legend.position = "none"
    ) +
    coord_cartesian(ylim = c(-.2, .2))

# Data preparation
temp.df <- amygdala_nuclei_7T %>%
  dplyr::select(id, visit, roiA, roiB, roiA_side, roiB_side, laterality, context, scan_age, fc, sex) %>% 
  filter(roiA %in% c("dlpfc", "LN"), roiB %in% c("dlpfc", "LN"), roiA != roiB) %>%
  distinct() %>%
  mutate(
    laterality = as.factor(laterality),
    roiA_side = as.factor(roiA_side),
    roiB_side = as.factor(roiB_side),
    id = as.factor(id),
    context = as.factor(context),
    visit = as.factor(visit),
    roiA = as.factor(roiA),
    roiB = as.factor(roiB),
    sex = as.factor(sex)
  )

# Remove incomplete cases
temp.df <- temp.df %>%
    filter(complete.cases(dplyr::select(., fc, scan_age, laterality, roiA_side, sex)))

# Create ordered factor for sex 
temp.df$osex <- ordered(temp.df$sex, levels = c("M","F"))

# Initial BAM model
initial_bam <- bam(
    fc ~ s(scan_age, k = 3, fx = T, by = osex) + s(scan_age, k = 3, fx = T) + laterality + roiA_side + context + osex,
    random = list(id = ~1 + visit),
    data = temp.df,
    REML = TRUE,
    discrete = TRUE
)

# Add residuals to dataframe
temp.df <- temp.df %>%
    mutate(bam.resid = residuals(initial_bam))

# Final BAM model after removing outliers
filtered_df <- temp.df %>%
    mutate(bam.z = abs(scale(bam.resid)[, 1])) %>%
    filter(bam.z < 2)

final_bam_dlpfc_LN_sex <- bam(
    fc ~ s(scan_age, k = 3, fx = T, by = osex) + s(scan_age, k = 3, fx = T) + laterality + roiA_side + context + osex,
    random = list(id = ~1 + visit),
    data = filtered_df,
    REML = TRUE,
    discrete = TRUE
)

# Summary
model_parameters(final_bam_dlpfc_LN_sex, standardize = "refit")

# Viz
dlpfc_LN_sex_plot <- ggeffects::ggpredict(final_bam_dlpfc_LN_sex, terms = c("scan_age", "osex")) %>%
    ggplot(aes(
        x = x,
        y = predicted,
        group = group
    )) +
    geom_line(aes(color = group), size = 1.25) +
    geom_ribbon(aes(ymin = conf.low, ymax = conf.high, fill = group), alpha = 0.2) +
    theme_modern(axis.title.space = .5, plot.title.space = .5) +
    xlab("Age (Years)") +
    ylab("Functional Connectivity") +
    ggtitle("dlPFC - LN") +
    scale_color_manual(name = "Sex", values = c("M" = scales::hue_pal()(2)[2], "F" = scales::hue_pal()(2)[1])) +
    scale_fill_manual(name = "Sex", values = c("M" = scales::hue_pal()(2)[2], "F" = scales::hue_pal()(2)[1])) +
    theme(
        plot.title = element_text(hjust = 0.6),
        legend.position = "none"
    ) +
    coord_cartesian(ylim = c(-.2, .2))

# Data preparation
temp.df <- amygdala_nuclei_7T %>%
  dplyr::select(id, visit, roiA, roiB, roiA_side, roiB_side, laterality, context, scan_age, fc, sex) %>% 
  filter(roiA %in% c("racc", "CAT"), roiB %in% c("racc", "CAT"), roiA != roiB) %>%
  distinct() %>%
  mutate(
    laterality = as.factor(laterality),
    roiA_side = as.factor(roiA_side),
    roiB_side = as.factor(roiB_side),
    id = as.factor(id),
    context = as.factor(context),
    visit = as.factor(visit),
    roiA = as.factor(roiA),
    roiB = as.factor(roiB),
    sex = as.factor(sex)
  )

# Remove incomplete cases
temp.df <- temp.df %>%
    filter(complete.cases(dplyr::select(., fc, scan_age, laterality, roiA_side, sex)))

# Create ordered factor for sex 
temp.df$osex <- ordered(temp.df$sex, levels = c("M","F"))

# Initial BAM model
initial_bam <- bam(
    fc ~ s(scan_age, k = 3, fx = T, by = osex) + s(scan_age, k = 3, fx = T) + laterality + roiA_side + context + osex,
    random = list(id = ~1 + visit),
    data = temp.df,
    REML = TRUE,
    discrete = TRUE
)

# Add residuals to dataframe
temp.df <- temp.df %>%
    mutate(bam.resid = residuals(initial_bam))

# Final BAM model after removing outliers
filtered_df <- temp.df %>%
    mutate(bam.z = abs(scale(bam.resid)[, 1])) %>%
    filter(bam.z < 2)

final_bam_racc_CAT_sex <- bam(
    fc ~ s(scan_age, k = 3, fx = T, by = osex) + s(scan_age, k = 3, fx = T) + laterality + roiA_side + context + osex,
    random = list(id = ~1 + visit),
    data = filtered_df,
    REML = TRUE,
    discrete = TRUE
)

# Summary
model_parameters(final_bam_racc_CAT_sex, standardize = "refit")

# Viz
racc_CAT_sex_plot <- ggeffects::ggpredict(final_bam_racc_CAT_sex, terms = c("scan_age", "osex")) %>%
    ggplot(aes(
        x = x,
        y = predicted,
        group = group
    )) +
    geom_line(aes(color = group), size = 1.25) +
    geom_ribbon(aes(ymin = conf.low, ymax = conf.high, fill = group), alpha = 0.2) +
    theme_modern(axis.title.space = .5, plot.title.space = .5) +
    xlab("Age (Years)") +
    ylab("Functional Connectivity") +
    ggtitle("rACC - CAT") +
    scale_color_manual(name = "Sex", values = c("M" = scales::hue_pal()(2)[2], "F" = scales::hue_pal()(2)[1])) +
    scale_fill_manual(name = "Sex", values = c("M" = scales::hue_pal()(2)[2], "F" = scales::hue_pal()(2)[1])) +
    theme(
        plot.title = element_text(hjust = 0.6),
        legend.position = "none"
    ) +
    coord_cartesian(ylim = c(-.2, .2))

# Data preparation
temp.df <- amygdala_nuclei_7T %>%
  dplyr::select(id, visit, roiA, roiB, roiA_side, roiB_side, laterality, context, scan_age, fc, sex) %>% 
  filter(roiA %in% c("vacc", "CAT"), roiB %in% c("vacc", "CAT"), roiA != roiB) %>%
  distinct() %>%
  mutate(
    laterality = as.factor(laterality),
    roiA_side = as.factor(roiA_side),
    roiB_side = as.factor(roiB_side),
    id = as.factor(id),
    context = as.factor(context),
    visit = as.factor(visit),
    roiA = as.factor(roiA),
    roiB = as.factor(roiB),
    sex = as.factor(sex)
  )

# Remove incomplete cases
temp.df <- temp.df %>%
    filter(complete.cases(dplyr::select(., fc, scan_age, laterality, roiA_side, sex)))

# Create ordered factor for sex 
temp.df$osex <- ordered(temp.df$sex, levels = c("M","F"))

# Initial BAM model
initial_bam <- bam(
    fc ~ s(scan_age, k = 3, fx = T, by = osex) + s(scan_age, k = 3, fx = T) + laterality + roiA_side + context + osex,
    random = list(id = ~1 + visit),
    data = temp.df,
    REML = TRUE,
    discrete = TRUE
)

# Add residuals to dataframe
temp.df <- temp.df %>%
    mutate(bam.resid = residuals(initial_bam))

# Final BAM model after removing outliers
filtered_df <- temp.df %>%
    mutate(bam.z = abs(scale(bam.resid)[, 1])) %>%
    filter(bam.z < 2)

final_bam_vacc_CAT_sex <- bam(
    fc ~ s(scan_age, k = 3, fx = T, by = osex) + s(scan_age, k = 3, fx = T) + laterality + roiA_side + context + osex,
    random = list(id = ~1 + visit),
    data = filtered_df,
    REML = TRUE,
    discrete = TRUE
)

# Summary
model_parameters(final_bam_vacc_CAT_sex, standardize = "refit")

# Viz
vacc_CAT_sex_plot <- ggeffects::ggpredict(final_bam_vacc_CAT_sex, terms = c("scan_age", "osex")) %>%
    ggplot(aes(
        x = x,
        y = predicted,
        group = group
    )) +
    geom_line(aes(color = group), size = 1.25) +
    geom_ribbon(aes(ymin = conf.low, ymax = conf.high, fill = group), alpha = 0.2) +
    theme_modern(axis.title.space = .5, plot.title.space = .5) +
    xlab("Age (Years)") +
    ylab("Functional Connectivity") +
    ggtitle("vACC - CAT") +
    scale_color_manual(name = "Sex", values = c("M" = scales::hue_pal()(2)[2], "F" = scales::hue_pal()(2)[1])) +
    scale_fill_manual(name = "Sex", values = c("M" = scales::hue_pal()(2)[2], "F" = scales::hue_pal()(2)[1])) +
    theme(
        plot.title = element_text(hjust = 0.6),
        legend.position = "none"
    ) +
    coord_cartesian(ylim = c(-.2, .2))

# Data preparation
temp.df <- amygdala_nuclei_7T %>%
  dplyr::select(id, visit, roiA, roiB, roiA_side, roiB_side, laterality, context, scan_age, fc, sex) %>% 
  filter(roiA %in% c("sgacc", "CAT"), roiB %in% c("sgacc", "CAT"), roiA != roiB) %>%
  distinct() %>%
  mutate(
    laterality = as.factor(laterality),
    roiA_side = as.factor(roiA_side),
    roiB_side = as.factor(roiB_side),
    id = as.factor(id),
    context = as.factor(context),
    visit = as.factor(visit),
    roiA = as.factor(roiA),
    roiB = as.factor(roiB),
    sex = as.factor(sex)
  )

# Remove incomplete cases
temp.df <- temp.df %>%
    filter(complete.cases(dplyr::select(., fc, scan_age, laterality, roiA_side, sex)))

# Create ordered factor for sex 
temp.df$osex <- ordered(temp.df$sex, levels = c("M","F"))

# Initial BAM model
initial_bam <- bam(
    fc ~ s(scan_age, k = 3, fx = T, by = osex) + s(scan_age, k = 3, fx = T) + laterality + roiA_side + context + osex,
    random = list(id = ~1 + visit),
    data = temp.df,
    REML = TRUE,
    discrete = TRUE
)

# Add residuals to dataframe
temp.df <- temp.df %>%
    mutate(bam.resid = residuals(initial_bam))

# Final BAM model after removing outliers
filtered_df <- temp.df %>%
    mutate(bam.z = abs(scale(bam.resid)[, 1])) %>%
    filter(bam.z < 2)

final_bam_sgacc_CAT_sex <- bam(
    fc ~ s(scan_age, k = 3, fx = T, by = osex) + s(scan_age, k = 3, fx = T) + laterality + roiA_side + context + osex,
    random = list(id = ~1 + visit),
    data = filtered_df,
    REML = TRUE,
    discrete = TRUE
)

# Summary
model_parameters(final_bam_sgacc_CAT_sex, standardize = "refit")

# Viz
sgacc_CAT_sex_plot <- ggeffects::ggpredict(final_bam_sgacc_CAT_sex, terms = c("scan_age", "osex")) %>%
    ggplot(aes(
        x = x,
        y = predicted,
        group = group
    )) +
    geom_line(aes(color = group), size = 1.25) +
    geom_ribbon(aes(ymin = conf.low, ymax = conf.high, fill = group), alpha = 0.2) +
    theme_modern(axis.title.space = .5, plot.title.space = .5) +
    xlab("Age (Years)") +
    ylab("Functional Connectivity") +
    ggtitle("sgACC - CAT") +
    scale_color_manual(name = "Sex", values = c("M" = scales::hue_pal()(2)[2], "F" = scales::hue_pal()(2)[1])) +
    scale_fill_manual(name = "Sex", values = c("M" = scales::hue_pal()(2)[2], "F" = scales::hue_pal()(2)[1])) +
    theme(
        plot.title = element_text(hjust = 0.6),
        legend.position = "none"
    ) +
    coord_cartesian(ylim = c(-.2, .2))

# Data preparation
temp.df <- amygdala_nuclei_7T %>%
  dplyr::select(id, visit, roiA, roiB, roiA_side, roiB_side, laterality, context, scan_age, fc, sex) %>% 
  filter(roiA %in% c("vlpfc", "CEN"), roiB %in% c("vlpfc", "CEN"), roiA != roiB) %>%
  distinct() %>%
  mutate(
    laterality = as.factor(laterality),
    roiA_side = as.factor(roiA_side),
    roiB_side = as.factor(roiB_side),
    id = as.factor(id),
    context = as.factor(context),
    visit = as.factor(visit),
    roiA = as.factor(roiA),
    roiB = as.factor(roiB),
    sex = as.factor(sex)
  )

# Remove incomplete cases
temp.df <- temp.df %>%
    filter(complete.cases(dplyr::select(., fc, scan_age, laterality, roiA_side, sex)))

# Create ordered factor for sex 
temp.df$osex <- ordered(temp.df$sex, levels = c("M","F"))

# Initial BAM model
initial_bam <- bam(
    fc ~ s(scan_age, k = 3, fx = T, by = osex) + s(scan_age, k = 3, fx = T) + laterality + roiA_side + context + osex,
    random = list(id = ~1 + visit),
    data = temp.df,
    REML = TRUE,
    discrete = TRUE
)

# Add residuals to dataframe
temp.df <- temp.df %>%
    mutate(bam.resid = residuals(initial_bam))

# Final BAM model after removing outliers
filtered_df <- temp.df %>%
    mutate(bam.z = abs(scale(bam.resid)[, 1])) %>%
    filter(bam.z < 2)

final_bam_vlpfc_CEN_sex <- bam(
    fc ~ s(scan_age, k = 3, fx = T, by = osex) + s(scan_age, k = 3, fx = T) + laterality + roiA_side + context + osex,
    random = list(id = ~1 + visit),
    data = filtered_df,
    REML = TRUE,
    discrete = TRUE
)

# Summary
model_parameters(final_bam_vlpfc_CEN_sex, standardize = "refit")

# Viz
vlpfc_CEN_sex_plot <- ggeffects::ggpredict(final_bam_vlpfc_CEN_sex, terms = c("scan_age", "osex")) %>%
    ggplot(aes(
        x = x,
        y = predicted,
        group = group
    )) +
    geom_line(aes(color = group), size = 1.25) +
    geom_ribbon(aes(ymin = conf.low, ymax = conf.high, fill = group), alpha = 0.2) +
    theme_modern(axis.title.space = .5, plot.title.space = .5) +
    xlab("Age (Years)") +
    ylab("Functional Connectivity") +
    ggtitle("vlPFC - CEN") +
    scale_color_manual(name = "Sex", values = c("M" = scales::hue_pal()(2)[2], "F" = scales::hue_pal()(2)[1])) +
    scale_fill_manual(name = "Sex", values = c("M" = scales::hue_pal()(2)[2], "F" = scales::hue_pal()(2)[1])) +
    theme(
        plot.title = element_text(hjust = 0.6),
        legend.position = "none"
    ) +
    coord_cartesian(ylim = c(-.2, .2))

# Data preparation
temp.df <- amygdala_nuclei_7T %>%
  dplyr::select(id, visit, roiA, roiB, roiA_side, roiB_side, laterality, context, scan_age, fc, sex) %>% 
  filter(roiA %in% c("vlpfc", "LN"), roiB %in% c("vlpfc", "LN"), roiA != roiB) %>%
  distinct() %>%
  mutate(
    laterality = as.factor(laterality),
    roiA_side = as.factor(roiA_side),
    roiB_side = as.factor(roiB_side),
    id = as.factor(id),
    context = as.factor(context),
    visit = as.factor(visit),
    roiA = as.factor(roiA),
    roiB = as.factor(roiB),
    sex = as.factor(sex)
  )

# Remove incomplete cases
temp.df <- temp.df %>%
    filter(complete.cases(dplyr::select(., fc, scan_age, laterality, roiA_side, sex)))

# Create ordered factor for sex 
temp.df$osex <- ordered(temp.df$sex, levels = c("M","F"))

# Initial BAM model
initial_bam <- bam(
    fc ~ s(scan_age, k = 3, fx = T, by = osex) + s(scan_age, k = 3, fx = T) + laterality + roiA_side + context + osex,
    random = list(id = ~1 + visit),
    data = temp.df,
    REML = TRUE,
    discrete = TRUE
)

# Add residuals to dataframe
temp.df <- temp.df %>%
    mutate(bam.resid = residuals(initial_bam))

# Final BAM model after removing outliers
filtered_df <- temp.df %>%
    mutate(bam.z = abs(scale(bam.resid)[, 1])) %>%
    filter(bam.z < 2)

final_bam_vlpfc_LN_sex <- bam(
    fc ~ s(scan_age, k = 3, fx = T, by = osex) + s(scan_age, k = 3, fx = T) + laterality + roiA_side + context + osex,
    random = list(id = ~1 + visit),
    data = filtered_df,
    REML = TRUE,
    discrete = TRUE
)

# Summary
model_parameters(final_bam_vlpfc_LN_sex, standardize = "refit")

# Viz
vlpfc_LN_sex_plot <- ggeffects::ggpredict(final_bam_vlpfc_LN_sex, terms = c("scan_age", "osex")) %>%
    ggplot(aes(
        x = x,
        y = predicted,
        group = group
    )) +
    geom_line(aes(color = group), size = 1.25) +
    geom_ribbon(aes(ymin = conf.low, ymax = conf.high, fill = group), alpha = 0.2) +
    theme_modern(axis.title.space = .5, plot.title.space = .5) +
    xlab("Age (Years)") +
    ylab("Functional Connectivity") +
    ggtitle("vlPFC - LN") +
    scale_color_manual(name = "Sex", values = c("M" = scales::hue_pal()(2)[2], "F" = scales::hue_pal()(2)[1])) +
    scale_fill_manual(name = "Sex", values = c("M" = scales::hue_pal()(2)[2], "F" = scales::hue_pal()(2)[1])) +
    theme(
        plot.title = element_text(hjust = 0.6),
        legend.position = "none"
    ) +
    coord_cartesian(ylim = c(-.2, .2))

ggarrange(antvmpfc_CEN_sex_plot, dlpfc_BN_sex_plot, dlpfc_LN_sex_plot, racc_CAT_sex_plot, vacc_CAT_sex_plot, sgacc_CAT_sex_plot, vlpfc_CEN_sex_plot, vlpfc_LN_sex_plot,
          nrow = 2, ncol = 4,
          common.legend = TRUE,
          legend = "right",
          labels = c("A", "B", "C", "D", "E", "F", "G","H"),
          align = "hv")

```

# supp. figure: violin plots for ROI tSNRs
```{r}

roi_tsnr <- vroom("~/Desktop/science/r/data/amygdala_nuclei/combined_tsnr_new_labels.csv")

# left hemisphere ROIs
left_roi_tsnr <- roi_tsnr %>% 
  mutate(AAA = AAA_L,
         ABN = ABN_L,
         BN = BN_L,
         CAT = CAT_L,
         CEN = CEN_L,
         CON = CON_L,
         LN = LN_L,
         MN = MN_L,
         PL = PL_L,
         antvmPFC = antvmpfc_L,
         antmOFC = antmofc_L,
         dlPFC = dlpfc_L,
         posmOFC = posmofc_L,
         rACC = racc_L,
         sgACC = sgacc_L,
         vACC = vacc_L,
         vlPFC = vlpfc_L) %>% 
  dplyr::select(scan_id, AAA:vlPFC) %>% 
  distinct()

# right hemisphere ROIs
right_roi_tsnr <- roi_tsnr %>% 
  mutate(AAA = AAA_R,
         ABN = ABN_R,
         BN = BN_R,
         CAT = CAT_R,
         CEN = CEN_R,
         CON = CON_R,
         LN = LN_R,
         MN = MN_R,
         PL = PL_R,
         antvmPFC = antvmpfc_R,
         antmOFC = antmofc_R,
         dlPFC = dlpfc_R,
         posmOFC = posmofc_R,
         rACC = racc_R,
         sgACC = sgacc_R,
         vACC = vacc_R,
         vlPFC = vlpfc_R) %>% 
  dplyr::select(scan_id, AAA:vlPFC) %>% 
  distinct()


### 

left_amyg_roi_tsnr_long <- left_roi_tsnr %>%
  dplyr::select(scan_id, AAA:PL) %>% 
  pivot_longer(cols = c("AAA", "ABN", "BN", "CAT", "CEN", "CON", "LN", "MN", "PL"), 
               names_to = "amygdala_nucleus", 
               values_to = "roi_tsnr") %>% 
  distinct()

right_amyg_roi_tsnr_long <- right_roi_tsnr %>%
  dplyr::select(scan_id, AAA:PL) %>% 
  pivot_longer(cols = c("AAA", "ABN", "BN", "CAT", "CEN", "CON", "LN", "MN", "PL"), 
               names_to = "amygdala_nucleus", 
               values_to = "roi_tsnr") %>% 
  distinct()

left_pfc_roi_tsnr_long <- left_roi_tsnr %>%
  dplyr::select(scan_id, antvmPFC:vlPFC) %>% 
  pivot_longer(cols = c("antvmPFC", "antmOFC", "dlPFC", "posmOFC", "rACC", "sgACC", "vACC", "vlPFC"), 
               names_to = "pfc_subregion", 
               values_to = "roi_tsnr") %>% 
  distinct()

right_pfc_roi_tsnr_long <- right_roi_tsnr %>%
  dplyr::select(scan_id, antvmPFC:vlPFC) %>% 
  pivot_longer(cols = c("antvmPFC", "antmOFC", "dlPFC", "posmOFC", "rACC", "sgACC", "vACC", "vlPFC"), 
               names_to = "pfc_subregion", 
               values_to = "roi_tsnr") %>% 
  distinct()

left_amyg_roi_tsnr_plot <- ggplot(left_amyg_roi_tsnr_long, aes(x = amygdala_nucleus, y = roi_tsnr, fill = amygdala_nucleus)) +
  geom_hline(yintercept = seq(0, max(750, na.rm = TRUE), by = 50),
             color = "lightgray", size = 0.3, alpha = 0.5) +
  geom_violin(trim = FALSE) +
  geom_boxplot(width = 0.05, fill = "white", outlier.size = .5) + 
  theme_modern(axis.title.space = 0.75, plot.title.space = 0.5) +
  labs(
    title = "Left Amygdala Nuclei Signal Quality",
    x = "ROI",
    y = "tSNR"
  ) +
  theme(
    plot.title = element_text(hjust = 0.5),
    legend.position = "none"  
  ) +
  scale_fill_manual(
    values = c(
      "AAA" = "#0F0505",
      "ABN" = "#4B0000",
      "BN" = "#800000",
      "CAT" = "#B22222",
      "CEN" = "#DC143C",
      "CON" = "#E34234",
      "LN" = "#FF4D6D",
      "MN" = "#FF69B4",
      "PL" = "#FFC0CB"
    )
  )

right_amyg_roi_tsnr_plot <- ggplot(right_amyg_roi_tsnr_long, aes(x = amygdala_nucleus, y = roi_tsnr, fill = amygdala_nucleus)) +
  geom_hline(yintercept = seq(0, max(750, na.rm = TRUE), by = 50),
             color = "lightgray", size = 0.3, alpha = 0.5) +
  geom_violin(trim = FALSE) +
  geom_boxplot(width = 0.05, fill = "white", outlier.size = .5) + 
  theme_modern(axis.title.space = 0.75, plot.title.space = 0.5) +
  labs(
    title = "Right Amygdala Nuclei Signal Quality",
    x = "ROI",
    y = "tSNR"
  ) +
  theme(
    plot.title = element_text(hjust = 0.5),
    legend.position = "none"  
  ) +
  scale_fill_manual(
    values = c(
      "AAA" = "#0F0505",
      "ABN" = "#4B0000",
      "BN" = "#800000",
      "CAT" = "#B22222",
      "CEN" = "#DC143C",
      "CON" = "#E34234",
      "LN" = "#FF4D6D",
      "MN" = "#FF69B4",
      "PL" = "#FFC0CB"
    )
  )

left_pfc_roi_tsnr_plot <- left_pfc_roi_tsnr_long %>% 
  #filter(id != "10202_20200103") %>% 
  ggplot(aes(x = pfc_subregion, y = roi_tsnr, fill = pfc_subregion)) +
  geom_hline(yintercept = seq(0, max(750, na.rm = TRUE), by = 50),
             color = "lightgray", size = 0.3, alpha = 0.5) +
  geom_violin(trim = FALSE) +
  geom_boxplot(width = 0.05, fill = "white", outlier.size = .5) + 
  theme_modern(axis.title.space = 0.75, plot.title.space = 0.5) +
  labs(
    title = "Left Prefrontal Cortex Subregion Signal Quality",
    x = "ROI",
    y = "tSNR"
  ) +
  theme(
    plot.title = element_text(hjust = 0.5),
    legend.position = "none"  
  ) +
  scale_fill_manual(
    values = c(
      "antvmPFC" = "#1A2213",
      "antmOFC" = "gray",
      "dlPFC" = "#3D5627",
      "posmOFC" = "gray",
      "rACC" = "#6A8F4A",
      "sgACC" = "#8EBF57",
      "vACC" = "#ACDD6B",
      "vlPFC" = "#C8F985"
    )
  ) +
  scale_x_discrete(
    labels = c("antvmPFC" = "ant. vmPFC",
               "antmOFC" = "ant. mOFC",
               "posmOFC" = "pos. mOFC")
  )

right_pfc_roi_tsnr_plot <- right_pfc_roi_tsnr_long %>% 
  #filter(id != "10202_20200103") %>% 
  ggplot(aes(x = pfc_subregion, y = roi_tsnr, fill = pfc_subregion)) +
  geom_hline(yintercept = seq(0, max(750, na.rm = TRUE), by = 50),
             color = "lightgray", size = 0.3, alpha = 0.5) +
  geom_violin(trim = FALSE) +
  geom_boxplot(width = 0.05, fill = "white", outlier.size = .5) + 
  theme_modern(axis.title.space = 0.75, plot.title.space = 0.5) +
  labs(
    title = "Right Prefrontal Cortex Subregion Signal Quality",
    x = "ROI",
    y = "tSNR"
  ) +
  theme(
    plot.title = element_text(hjust = 0.5),
    legend.position = "none"  
  ) +
  scale_fill_manual(
    values = c(
      "antvmPFC" = "#1A2213",
      "antmOFC" = "gray",
      "dlPFC" = "#3D5627",
      "posmOFC" = "gray",
      "rACC" = "#6A8F4A",
      "sgACC" = "#8EBF57",
      "vACC" = "#ACDD6B",
      "vlPFC" = "#C8F985"
    )
  ) +
  scale_x_discrete(
    labels = c("antvmPFC" = "ant. vmPFC",
               "antmOFC" = "ant. mOFC",
               "posmOFC" = "pos. mOFC")
  )

### combining into single figure
combined_fig <- ggarrange(
  left_amyg_roi_tsnr_plot, right_amyg_roi_tsnr_plot, left_pfc_roi_tsnr_plot, right_pfc_roi_tsnr_plot,
  labels = c("A", "B", "C", "D"),
  ncol = 2,
  nrow = 2,
  align = "hv")

# Print the combined figure
print(combined_fig)

```

# supp. figure: violin plots for ROI sizes
```{r}
setwd("/Users/amarojha/Desktop/science/r/data/amygdala_nuclei")
roi_voxels <- vroom("roi_sizes_pfc_amyg.csv")

left_roi_voxels <- roi_voxels %>% 
  mutate(AAA = AAA_L,
         ABN = ABN_L,
         BN = BN_L,
         CAT = CAT_L,
         CEN = CEN_L,
         CON = CON_L,
         LN = LN_L,
         MN = MN_L,
         PL = PL_L,
         antvmPFC = antvmpfc_L,
         dlPFC = dlpfc_L,
         rACC = racc_L,
         sgACC = sgacc_L,
         vACC = vacc_L,
         vlPFC = vlpfc_L) %>% 
  dplyr::select(id, AAA:vlPFC) %>% 
  distinct()

right_roi_voxels <- roi_voxels %>% 
  mutate(AAA = AAA_R,
         ABN = ABN_R,
         BN = BN_R,
         CAT = CAT_R,
         CEN = CEN_R,
         CON = CON_R,
         LN = LN_R,
         MN = MN_R,
         PL = PL_R,
         antvmPFC = antvmpfc_R,
         dlPFC = dlpfc_R,
         rACC = racc_R,
         sgACC = sgacc_R,
         vACC = vacc_R,
         vlPFC = vlpfc_R) %>% 
  dplyr::select(id, AAA:vlPFC) %>% 
  distinct()

left_amyg_roi_voxels_long <- left_roi_voxels %>%
  dplyr::select(id, AAA:PL) %>% 
  pivot_longer(cols = c("AAA", "ABN", "BN", "CAT", "CEN", "CON", "LN", "MN", "PL"), 
               names_to = "amygdala_nucleus", 
               values_to = "roi_size") %>% 
  distinct()

right_amyg_roi_voxels_long <- right_roi_voxels %>%
  dplyr::select(id, AAA:PL) %>% 
  pivot_longer(cols = c("AAA", "ABN", "BN", "CAT", "CEN", "CON", "LN", "MN", "PL"), 
               names_to = "amygdala_nucleus", 
               values_to = "roi_size") %>% 
  distinct()

left_pfc_roi_voxels_long <- left_roi_voxels %>%
  dplyr::select(id, antvmPFC:vlPFC) %>% 
  pivot_longer(cols = c("antvmPFC", "dlPFC", "rACC", "sgACC", "vACC", "vlPFC"), 
               names_to = "pfc_subregion", 
               values_to = "roi_size") %>% 
  distinct()

right_pfc_roi_voxels_long <- right_roi_voxels %>%
  dplyr::select(id, antvmPFC:vlPFC) %>% 
  pivot_longer(cols = c("antvmPFC", "dlPFC", "rACC", "sgACC", "vACC", "vlPFC"), 
               names_to = "pfc_subregion", 
               values_to = "roi_size") %>% 
  distinct()


left_amyg_roi_size_plot <- ggplot(left_amyg_roi_voxels_long, aes(x = amygdala_nucleus, y = roi_size, fill = amygdala_nucleus)) +
  geom_hline(yintercept = seq(0, max(100, na.rm = TRUE), by = 10), 
             color = "lightgray", size = 0.3, alpha = 0.5) +
  geom_violin(trim = FALSE) +
  geom_boxplot(width = 0.05, fill = "white", outlier.size = .5) + 
  theme_modern(axis.title.space = 0.75, plot.title.space = 0.5) +
  labs(
    title = "Left Amygdala Nuclei Size",
    x = "ROI",
    y = "Number of Voxels"
  ) +
  theme(
    plot.title = element_text(hjust = 0.5),
    legend.position = "none"  
  ) +
  scale_fill_manual(
    values = c(
      "AAA" = "#0F0505",
      "ABN" = "#4B0000",
      "BN" = "#800000",
      "CAT" = "#B22222",
      "CEN" = "#DC143C",
      "CON" = "#E34234",
      "LN" = "#FF4D6D",
      "MN" = "#FF69B4",
      "PL" = "#FFC0CB"
    )
  )

right_amyg_roi_size_plot <- ggplot(right_amyg_roi_voxels_long, aes(x = amygdala_nucleus, y = roi_size, fill = amygdala_nucleus)) +
  geom_hline(yintercept = seq(0, max(100, na.rm = TRUE), by = 10), 
             color = "lightgray", size = 0.3, alpha = 0.5) +
  geom_violin(trim = FALSE) +
  geom_boxplot(width = 0.05, fill = "white", outlier.size = .5) + 
  theme_modern(axis.title.space = 0.75, plot.title.space = 0.5) +
  labs(
    title = "Right Amygdala Nuclei Size",
    x = "ROI",
    y = "Number of Voxels"
  ) +
  theme(
    plot.title = element_text(hjust = 0.5),
    legend.position = "none"  
  ) +
  scale_fill_manual(
    values = c(
      "AAA" = "#0F0505",
      "ABN" = "#4B0000",
      "BN" = "#800000",
      "CAT" = "#B22222",
      "CEN" = "#DC143C",
      "CON" = "#E34234",
      "LN" = "#FF4D6D",
      "MN" = "#FF69B4",
      "PL" = "#FFC0CB"
    )
  )

left_pfc_roi_size_plot <- left_pfc_roi_voxels_long %>% 
  filter(id != "10202_20200103") %>% 
  ggplot(aes(x = pfc_subregion, y = roi_size, fill = pfc_subregion)) +
  geom_hline(yintercept = seq(0, max(5000, na.rm = TRUE), by = 500), 
             color = "lightgray", size = 0.3, alpha = 0.5) +
  geom_violin(trim = FALSE) +
  geom_boxplot(width = 0.05, fill = "white", outlier.size = .5) + 
  theme_modern(axis.title.space = 0.75, plot.title.space = 0.5) +
  labs(
    title = "Left Prefrontal Cortex Subregion Size",
    x = "ROI",
    y = "Number of Voxels"
  ) +
  theme(
    plot.title = element_text(hjust = 0.5),
    legend.position = "none"  
  ) +
  scale_fill_manual(
    values = c(
      "antvmPFC" = "#1A2213",
      "dlPFC" = "#3D5627",
      "rACC" = "#6A8F4A",
      "sgACC" = "#8EBF57",
      "vACC" = "#ACDD6B",
      "vlPFC" = "#C8F985"
    )
  ) +
  scale_x_discrete(
    labels = c("antvmPFC" = "ant. vmPFC")
  )

right_pfc_roi_size_plot <- right_pfc_roi_voxels_long %>% 
  filter(id != "10202_20200103") %>% 
  ggplot(aes(x = pfc_subregion, y = roi_size, fill = pfc_subregion)) +
  geom_hline(yintercept = seq(0, max(5000, na.rm = TRUE), by = 500), 
             color = "lightgray", size = 0.3, alpha = 0.5) +
  geom_violin(trim = FALSE) +
  geom_boxplot(width = 0.05, fill = "white", outlier.size = .5) + 
  theme_modern(axis.title.space = 0.75, plot.title.space = 0.5) +
  labs(
    title = "Right Prefrontal Cortex Subregion Size",
    x = "ROI",
    y = "Number of Voxels"
  ) +
  theme(
    plot.title = element_text(hjust = 0.5),
    legend.position = "none"  
  ) +
  scale_fill_manual(
    values = c(
      "antvmPFC" = "#1A2213",
      "dlPFC" = "#3D5627",
      "rACC" = "#6A8F4A",
      "sgACC" = "#8EBF57",
      "vACC" = "#ACDD6B",
      "vlPFC" = "#C8F985"
    )
  ) +
  scale_x_discrete(
    labels = c("antvmPFC" = "ant. vmPFC")
  )

### combining into single figure
combined_fig <- ggarrange(
  left_amyg_roi_size_plot, right_amyg_roi_size_plot, left_pfc_roi_size_plot, right_pfc_roi_size_plot,
  labels = c("A", "B", "C", "D"),
  ncol = 2,
  nrow = 2,
  align = "hv")

# Print the combined figure
print(combined_fig)

#### zoomed in version of some of the smaller ROIs #### 
left_small_roi_voxels <- roi_voxels %>% 
  mutate(AAA = AAA_L,
         CEN = CEN_L,
         CON = CON_L,
         MN = MN_L,
         PL = PL_L,
         rACC = racc_L,
         sgACC = sgacc_L,
         vACC = vacc_L) %>% 
  dplyr::select(id, AAA:vACC) %>% 
  distinct()

right_small_roi_voxels <- roi_voxels %>% 
  mutate(AAA = AAA_R,
         CEN = CEN_R,
         CON = CON_R,
         MN = MN_R,
         PL = PL_R,
         rACC = racc_R,
         sgACC = sgacc_R,
         vACC = vacc_R) %>% 
  dplyr::select(id, AAA:vACC) %>% 
  distinct()

left_amyg_small_roi_voxels_long <- left_small_roi_voxels %>%
  dplyr::select(id, AAA, CEN, CON, MN, PL) %>% 
  pivot_longer(cols = c("AAA", "CEN", "CON", "MN", "PL"), 
               names_to = "amygdala_nucleus", 
               values_to = "roi_size") %>% 
  distinct()

right_amyg_small_roi_voxels_long <- right_small_roi_voxels %>%
  dplyr::select(id, AAA, CEN, CON, MN, PL) %>% 
  pivot_longer(cols = c("AAA", "CEN", "CON", "MN", "PL"), 
               names_to = "amygdala_nucleus", 
               values_to = "roi_size") %>% 
  distinct()

left_pfc_small_roi_voxels_long <- left_small_roi_voxels %>%
  dplyr::select(id, rACC:vACC) %>% 
  pivot_longer(cols = c("rACC", "sgACC", "vACC"), 
               names_to = "pfc_subregion", 
               values_to = "roi_size") %>% 
  distinct()

right_pfc_small_roi_voxels_long <- right_small_roi_voxels %>%
  dplyr::select(id, rACC:vACC) %>% 
  pivot_longer(cols = c("rACC", "sgACC", "vACC"), 
               names_to = "pfc_subregion", 
               values_to = "roi_size") %>% 
  distinct()


left_amyg_small_roi_size_plot <- ggplot(left_amyg_small_roi_voxels_long, aes(x = amygdala_nucleus, y = roi_size, fill = amygdala_nucleus)) +
  geom_hline(yintercept = seq(0, max(20, na.rm = TRUE), by = 5), 
             color = "lightgray", size = 0.3, alpha = 0.5) +
  geom_violin(trim = FALSE) +
  geom_boxplot(width = 0.05, fill = "white", outlier.size = .5) + 
  theme_modern(axis.title.space = 0.75, plot.title.space = 0.5) +
  labs(
    title = "Left Amygdala Nuclei Size",
    x = "ROI",
    y = "Number of Voxels"
  ) +
  theme(
    plot.title = element_text(hjust = 0.5),
    legend.position = "none"  
  ) +
  scale_fill_manual(
    values = c(
      "AAA" = "#0F0505",
      "CEN" = "#DC143C",
      "CON" = "#E34234",
      "MN" = "#FF69B4",
      "PL" = "#FFC0CB"
    )
  )

right_amyg_small_roi_size_plot <- ggplot(right_amyg_small_roi_voxels_long, aes(x = amygdala_nucleus, y = roi_size, fill = amygdala_nucleus)) +
  geom_hline(yintercept = seq(0, max(20, na.rm = TRUE), by = 5), 
             color = "lightgray", size = 0.3, alpha = 0.5) +
  geom_violin(trim = FALSE) +
  geom_boxplot(width = 0.05, fill = "white", outlier.size = .5) + 
  theme_modern(axis.title.space = 0.75, plot.title.space = 0.5) +
  labs(
    title = "Right Amygdala Nuclei Size",
    x = "ROI",
    y = "Number of Voxels"
  ) +
  theme(
    plot.title = element_text(hjust = 0.5),
    legend.position = "none"  
  ) +
  scale_fill_manual(
    values = c(
      "AAA" = "#0F0505",
      "CEN" = "#DC143C",
      "CON" = "#E34234",
      "MN" = "#FF69B4",
      "PL" = "#FFC0CB"
    )
  )

left_pfc_small_roi_size_plot <- left_pfc_small_roi_voxels_long %>% 
  filter(id != "10202_20200103") %>% 
  ggplot(aes(x = pfc_subregion, y = roi_size, fill = pfc_subregion)) +
  geom_hline(yintercept = seq(0, max(400, na.rm = TRUE), by = 50), 
             color = "lightgray", size = 0.3, alpha = 0.5) +
  geom_violin(trim = FALSE) +
  geom_boxplot(width = 0.05, fill = "white", outlier.size = .5) + 
  theme_modern(axis.title.space = 0.75, plot.title.space = 0.5) +
  labs(
    title = "Left Prefrontal Cortex Subregion Size",
    x = "ROI",
    y = "Number of Voxels"
  ) +
  theme(
    plot.title = element_text(hjust = 0.5),
    legend.position = "none"  
  ) +
  scale_fill_manual(
    values = c(
      "rACC" = "#6A8F4A",
      "sgACC" = "#8EBF57",
      "vACC" = "#ACDD6B"
    )
  ) +
  scale_x_discrete(
    labels = c("antvmPFC" = "ant. vmPFC")
  )

right_pfc_small_roi_size_plot <- right_pfc_small_roi_voxels_long %>% 
  filter(id != "10202_20200103") %>% 
  ggplot(aes(x = pfc_subregion, y = roi_size, fill = pfc_subregion)) +
  geom_hline(yintercept = seq(0, max(400, na.rm = TRUE), by = 50), 
             color = "lightgray", size = 0.3, alpha = 0.5) +
  geom_violin(trim = FALSE) +
  geom_boxplot(width = 0.05, fill = "white", outlier.size = .5) + 
  theme_modern(axis.title.space = 0.75, plot.title.space = 0.5) +
  labs(
    title = "Right Prefrontal Cortex Subregion Size",
    x = "ROI",
    y = "Number of Voxels"
  ) +
  theme(
    plot.title = element_text(hjust = 0.5),
    legend.position = "none"  
  ) +
  scale_fill_manual(
    values = c(
      "rACC" = "#6A8F4A",
      "sgACC" = "#8EBF57",
      "vACC" = "#ACDD6B"
    )
  ) +
  scale_x_discrete(
    labels = c("antvmPFC" = "ant. vmPFC")
  )

### combining into single figure
combined_fig <- ggarrange(
  left_amyg_small_roi_size_plot, right_amyg_small_roi_size_plot, left_pfc_small_roi_size_plot, right_pfc_small_roi_size_plot,
  labels = c("A", "B", "C", "D"),
  ncol = 2,
  nrow = 2,
  align = "hv")

# Print the combined figure
print(combined_fig)

```

# supp. figure: whole-brain RSFC via ggseg for psych decoding domain stuff -- now supp. fig.
```{r}
# Load libraries
library(ggseg)
library(ggsegGlasser)
library(tidyverse)

#### adult (ages 18-32) data only (3dmean method) ####

abn_rsfc_adults <- abn_amyg_parcel_terms_sorted %>%
  dplyr::select(connectivity_abn, regionName) %>% 
  distinct() %>% 
  separate(connectivity_abn, into = c("connectivity", "seed"), sep = "_") %>%
  mutate(seed = "abn")

bn_rsfc_adults <- bn_amyg_parcel_terms_sorted %>%
  dplyr::select(connectivity_bn, regionName) %>% 
  distinct() %>% 
  separate(connectivity_bn, into = c("connectivity", "seed"), sep = "_") %>%
  mutate(seed = "bn")

cat_rsfc_adults <- cat_amyg_parcel_terms_sorted %>%
  dplyr::select(connectivity_cat, regionName) %>% 
  distinct() %>% 
  separate(connectivity_cat, into = c("connectivity", "seed"), sep = "_") %>%
  mutate(seed = "cat")

cen_rsfc_adults <- cen_amyg_parcel_terms_sorted %>%
  dplyr::select(connectivity_cen, regionName) %>% 
  distinct() %>% 
  separate(connectivity_cen, into = c("connectivity", "seed"), sep = "_") %>%
  mutate(seed = "cen")

ln_rsfc_adults <- ln_amyg_parcel_terms_sorted %>%
  dplyr::select(connectivity_ln, regionName) %>% 
  distinct() %>% 
  separate(connectivity_ln, into = c("connectivity", "seed"), sep = "_") %>%
  mutate(seed = "ln")

rsfc_adults_combined_seeds <- abn_rsfc_adults %>% 
  full_join(., bn_rsfc_adults) %>% 
  full_join(., cat_rsfc_adults) %>% 
  full_join(., cen_rsfc_adults) %>% 
  full_join(., ln_rsfc_adults) 

# Convert to percentile ranks
rsfc_adults_combined_seeds_glasser$connectivity_percentile <- 
  percent_rank(rsfc_adults_combined_seeds_glasser$connectivity) * 100

winter_pal = pnw_palette("Winter", 100)

adult_wholebrain_rsfc_glasser <- rsfc_adults_combined_seeds_glasser %>%
  mutate(seed = toupper(seed)) %>% 
  group_by(seed) %>%
  ggplot() +
  geom_brain(atlas = glasser, 
             mapping = aes(fill = connectivity_percentile),
             position = position_brain(side ~ hemi)) +
  facet_wrap(~ seed, ncol = 1) +
  scale_fill_gradientn(
    colours = rev(winter_pal),
    name = "Connectivity\n(Percentile)",
    limits = c(0, 100),
    breaks = c(0, 25, 50, 75, 100)
  ) +
  theme_void() +
  theme(
    legend.position = "right",
    strip.text = element_text(size = 12, face = "bold")
  )

print(adult_wholebrain_rsfc_glasser)

## listing out Glasser regions by connectivity strength for each amygdala seeed

rsfc_adults_combined_seeds_glasser %>% 
  dplyr::select(seed, regionName, connectivity) %>% 
  filter(seed == "abn") %>% 
  distinct() %>% 
  arrange(-connectivity) %>% 
  slice_head(n = 10)

#### everyone (ages 10-32) data (3dlmer method) ####

# Define parameters
base_path <- '/Users/amarojha/Desktop/science/papers/revise/frontoamygdala/amyg7T/cognitive_mapping'
output_path <- file.path(base_path, 'age_bins/3dlmer_amyg_maps/not_thresholded')
atlas_path <- file.path(base_path, 'glasser_space-fsLR_den-32k_desc-atlas.dlabel.nii')

# Define ROIs and age bins
rois <- c('abn', 'bn', 'cat', 'cen', 'ln')
age_bins <- c(10, 20, 30)  # Only process these three age bins

# Container for all connectivity data
all_connectivity_data <- list()

# Process each ROI and age bin
for (roi in rois) {
  for (bin_num in age_bins) {
    tryCatch({
      cat(sprintf("Processing %s%d...\n", roi, bin_num))

      # File paths
      left_metric <- file.path(output_path, sprintf("source-Liu2019_desc-%s%d_map_space-fslr_den-32k_hemi-L.func.gii", roi, bin_num))
      right_metric <- file.path(output_path, sprintf("source-Liu2019_desc-%s%d_map_space-fslr_den-32k_hemi-R.func.gii", roi, bin_num))
      dscalar_output <- file.path(output_path, sprintf("%s%d_amyg.dscalar.nii", roi, bin_num))
      pscalar_output <- file.path(output_path, sprintf("glasser_%s%d_amyg.pscalar.nii", roi, bin_num))

      # Check if input files exist
      if (!file.exists(left_metric) || !file.exists(right_metric)) {
        cat(sprintf("Missing input files for %s%d, skipping.\n", roi, bin_num))
        next
      }

      # 1. Create dense scalar from left and right hemisphere GIfTI files
      wb_cmd <- sprintf("-cifti-create-dense-scalar -left-metric %s -right-metric %s %s", 
                        left_metric, right_metric, dscalar_output)
      ciftiTools::run_wb_cmd(wb_cmd)
      cat(sprintf("Created dense scalar for %s%d\n", roi, bin_num))

      # 2. Parcellate the dense scalar using Glasser atlas
      wb_cmd <- sprintf("-cifti-parcellate %s %s COLUMN %s", 
                        dscalar_output, atlas_path, pscalar_output)
      ciftiTools::run_wb_cmd(wb_cmd)
      cat(sprintf("Parcellated %s%d\n", roi, bin_num))

      # 3-4. Read the parcellated scalar
      pscalar_data <- cifti::read_cifti(pscalar_output)

      # Create dataframe with connectivity values
      parcel_df <- data.frame(
        connectivity = as.numeric(pscalar_data$data),
        seed = roi,  # Add seed (ROI) information
        age_bin = bin_num,  # Keep age bin info
        orig_parcelname = names(pscalar_data$Parcel)
      )

      # 5. Transform parcel names to get regionName
      parcel_df$new_parcelname_temp <- str_replace(parcel_df$orig_parcelname, "_ROI", "")
      parcel_df$regionName <- str_replace(parcel_df$new_parcelname_temp, "^(.+)_(.+)$", "\\2_\\1")

      # Create label to match glasser atlas format
      parcel_df <- parcel_df %>%
        mutate(
          region = str_extract(regionName, "^[^_]+"),  # Everything before underscore
          hemi = str_extract(regionName, "[LR]$"),     # Last character (L or R)
          # Create label in glasser format: "lh_L_region" or "rh_R_region"
          label = case_when(
            hemi == "L" ~ paste0("lh_L_", region),
            hemi == "R" ~ paste0("rh_R_", region),
            TRUE ~ NA_character_
          )
        )

      # Clean up temporary columns
      parcel_df <- parcel_df %>% 
        dplyr::select(connectivity, seed, regionName, label, age_bin)

      # Add to overall results
      all_connectivity_data[[sprintf("%s%d", roi, bin_num)]] <- parcel_df

      cat(sprintf("Completed processing for %s%d\n", roi, bin_num))
    }, error = function(e) {
      cat(sprintf("Error processing %s%d: %s\n", roi, bin_num, e$message))
    })
  }
}

# Combine all connectivity data
combined_connectivity_df <- do.call(rbind, all_connectivity_data)

# Calculate connectivity percentile across all data
combined_connectivity_df$connectivity_percentile <- 
  percent_rank(combined_connectivity_df$connectivity) * 100

# Create factor for age_bin with labels
combined_connectivity_df$age_bin_label <- factor(
  combined_connectivity_df$age_bin, 
  levels = c(10, 20, 30),
  labels = c("Age 10", "Age 20", "Age 30")
)

# Create the winter palette
shuksan_pal = pnw_palette("Shuksan", 100)

# plots
age10_wholebrain_rsfc_glasser <- combined_connectivity_df %>%
  filter(age_bin == 10) %>% 
  mutate(seed = toupper(seed)) %>% 
  group_by(seed) %>%
  ggplot() +
  geom_brain(atlas = glasser, 
             mapping = aes(fill = connectivity_percentile),
             position = position_brain(side ~ hemi)) +
  facet_wrap(~ seed, ncol = 1) + 
  scale_fill_gradientn(
    colours = rev(shuksan_pal),  
    name = "Connectivity\n(Percentile)",
    limits = c(0, 100),
    breaks = c(0, 25, 50, 75, 100)
  ) +
  theme_void() +
  ggtitle("Age 10") +
  theme(
    legend.position = "bottom",
    strip.text = element_text(size = 12, face = "bold"),
    plot.title = element_text(hjust = 0.5)
  ) 

age20_wholebrain_rsfc_glasser <- combined_connectivity_df %>%
  filter(age_bin == 20) %>% 
  mutate(seed = toupper(seed)) %>% 
  group_by(seed) %>%
  ggplot() +
  geom_brain(atlas = glasser, 
             mapping = aes(fill = connectivity_percentile),
             position = position_brain(side ~ hemi)) +
  facet_wrap(~ seed, ncol = 1) + 
  scale_fill_gradientn(
    colours = rev(shuksan_pal),
    name = "Connectivity\n(Percentile)",
    limits = c(0, 100),
    breaks = c(0, 25, 50, 75, 100)
  ) +
  theme_void() +
  ggtitle("Age 20") +
  theme(
    legend.position = "bottom",
    strip.text = element_text(size = 12, face = "bold"),
    plot.title = element_text(hjust = 0.5)
  ) 

age30_wholebrain_rsfc_glasser <- combined_connectivity_df %>%
  filter(age_bin == 30) %>% 
  mutate(seed = toupper(seed)) %>% 
  group_by(seed) %>%
  ggplot() +
  geom_brain(atlas = glasser, 
             mapping = aes(fill = connectivity_percentile),
             position = position_brain(side ~ hemi)) +
  facet_wrap(~ seed, ncol = 1) + 
  scale_fill_gradientn(
    colours = rev(shuksan_pal),  
    name = "Connectivity\n(Percentile)",
    limits = c(0, 100),
    breaks = c(0, 25, 50, 75, 100)
  ) +
  theme_void() +
  ggtitle("Age 30") +
  theme(
    legend.position = "bottom",
    strip.text = element_text(size = 12, face = "bold"),
    plot.title = element_text(hjust = 0.5)
  ) 

age_bins_wholebrain_rsfc_glasser <- ggarrange(age10_wholebrain_rsfc_glasser, age20_wholebrain_rsfc_glasser, age30_wholebrain_rsfc_glasser,
          ncol = 3,
          common.legend = TRUE,
          legend = "right",
          widths = .5)

# combined figure 
ggarrange(adult_wholebrain_rsfc_glasser, age_bins_wholebrain_rsfc_glasser,
          labels = c("A", "B"))

```

# supp. figure: behavioral variables across development
```{r}

int_age <- amygdala_nuclei_7T %>% 
  dplyr::select(id, visit, scan_id, scan_age, internalizing_probs_T) %>%
  drop_na(.) %>% 
  distinct() %>% 
  ggplot(aes(scan_age, internalizing_probs_T)) +
  geom_smooth(method = "gam", formula = y ~ s(x, k = 3), size = 1, se = T, color = "black") +
  geom_point(size = .2) +
  xlab("Age (Years)") +
  ylab("Internalizing Behaviors\n (YSR/ASR T-score)") +
  theme_modern() +
  theme(plot.title = element_text(hjust = 0.5),
    axis.line = element_line(color = "black"), 
    axis.line.x = element_line(color = "black"),
    axis.line.y = element_line(color = "black"),
    axis.title.x = element_text(margin = margin(t = 10)),
    axis.title.y = element_text(margin = margin(r = 10), size = 12)
  )

ext_age <- amygdala_nuclei_7T %>% 
  dplyr::select(id, visit, scan_id, scan_age, externalizing_probs_T) %>%
  drop_na(.) %>% 
  distinct() %>% 
  ggplot(aes(scan_age, externalizing_probs_T)) +
  geom_smooth(method = "gam", formula = y ~ s(x, k = 3), size = 1, se = T, color = "black") +
  geom_point(size = .2) +
  xlab("Age (Years)") +
  ylab("Externalizing Behaviors\n (YSR/ASR T-score)") +
  theme_modern() +
  theme(plot.title = element_text(hjust = 0.5),
    axis.line = element_line(color = "black"), 
    axis.line.x = element_line(color = "black"),
    axis.line.y = element_line(color = "black"),
    axis.title.x = element_text(margin = margin(t = 10)),
    axis.title.y = element_text(margin = margin(r = 10), size = 12)
  )
  
ders_age <- amygdala_nuclei_7T %>% 
  dplyr::select(id, visit, scan_id, scan_age, ders_total) %>%
  drop_na(.) %>% 
  distinct() %>% 
  ggplot(aes(scan_age, ders_total)) +
  geom_smooth(method = "gam", formula = y ~ s(x, k = 3), size = 1, se = T, color = "black") +
  geom_point(size = .2) +
  xlab("Age (Years)") +
  ylab("Difficulties in Emotion Regulation\n (DERS Total Score)") +
  theme_modern() +
  theme(plot.title = element_text(hjust = 0.5),
    axis.line = element_line(color = "black"), 
    axis.line.x = element_line(color = "black"),
    axis.line.y = element_line(color = "black"),
    axis.title.x = element_text(margin = margin(t = 10)),
    axis.title.y = element_text(margin = margin(r = 10), size = 12)
  )

mgs_acc_age <- amygdala_nuclei_7T %>% 
  dplyr::select(id, visit, scan_id, scan_age, mgs_acc) %>%
  drop_na(.) %>% 
  distinct() %>% 
  ggplot(aes(scan_age, mgs_acc)) +
  geom_smooth(method = "gam", formula = y ~ s(x, k = 3), size = 1, se = T, color = "black") +
  geom_point(size = .2) +
  xlab("Age (Years)") +
  ylab("Memory-Guided Saccade\n Accuracy (Degrees from Target)") +
  theme_modern() +
  theme(plot.title = element_text(hjust = 0.5),
    axis.line = element_line(color = "black"), 
    axis.line.x = element_line(color = "black"),
    axis.line.y = element_line(color = "black"),
    axis.title.x = element_text(margin = margin(t = 10)),
    axis.title.y = element_text(margin = margin(r = 10), size = 12)
  )
  
mgs_acc_var_age <- amygdala_nuclei_7T %>% 
  dplyr::select(id, visit, scan_id, scan_age, mgs_acc_var) %>%
  drop_na(.) %>% 
  distinct() %>% 
  ggplot(aes(scan_age, mgs_acc_var)) +
  geom_smooth(method = "gam", formula = y ~ s(x, k = 3), size = 1, se = T, color = "black") +
  geom_point(size = .2) +
  xlab("Age (Years)") +
  ylab("Memory-Guided Saccade\n Accuracy Variability (SD)") +
  theme_modern() +
  theme(plot.title = element_text(hjust = 0.5),
    axis.line = element_line(color = "black"), 
    axis.line.x = element_line(color = "black"),
    axis.line.y = element_line(color = "black"),
    axis.title.x = element_text(margin = margin(t = 10)),
    axis.title.y = element_text(margin = margin(r = 10), size = 12)
  )

mgs_lat_age <- amygdala_nuclei_7T %>% 
  dplyr::select(id, visit, scan_id, scan_age, mgs_lat) %>%
  drop_na(.) %>% 
  distinct() %>% 
  ggplot(aes(scan_age, mgs_lat)) +
  geom_smooth(method = "gam", formula = y ~ s(x, k = 3), size = 1, se = T, color = "black") +
  geom_point(size = .2) +
  xlab("Age (Years)") +
  ylab("Memory-Guided Saccade\n Correct Trial Latency (Seconds)") +
  theme_modern() +
  theme(plot.title = element_text(hjust = 0.5),
    axis.line = element_line(color = "black"), 
    axis.line.x = element_line(color = "black"),
    axis.line.y = element_line(color = "black"),
    axis.title.x = element_text(margin = margin(t = 10)),
    axis.title.y = element_text(margin = margin(r = 10), size = 12)
  )
  
mgs_lat_var_age <- amygdala_nuclei_7T %>% 
  dplyr::select(id, visit, scan_id, scan_age, mgs_lat_var) %>%
  drop_na(.) %>% 
  distinct() %>% 
  ggplot(aes(scan_age, mgs_lat_var)) +
  geom_smooth(method = "gam", formula = y ~ s(x, k = 3), size = 1, se = T, color = "black") +
  geom_point(size = .2) +
  xlab("Age (Years)") +
  ylab("Memory-Guided Saccade\n Correct Trial Latency Variability (SD)") +
  theme_modern() +
  theme(plot.title = element_text(hjust = 0.5),
    axis.line = element_line(color = "black"), 
    axis.line.x = element_line(color = "black"),
    axis.line.y = element_line(color = "black"),
    axis.title.x = element_text(margin = margin(t = 10)),
    axis.title.y = element_text(margin = margin(r = 10), size = 12)
  )

ggarrange(int_age, ext_age, ders_age, mgs_acc_age, mgs_acc_var_age, mgs_lat_age, mgs_lat_var_age,
          labels = c("A", "B", "C", "D", "E", "F", "G"))

aff_age <- ggarrange(int_age, ext_age, ders_age,
          labels = c("A", "B", "C"),
          ncol = 3)

cog_age <- ggarrange(mgs_acc_age, mgs_acc_var_age, mgs_lat_age, mgs_lat_var_age,
          labels = c("D", "E", "F", "G"),
          ncol = 4)

ggarrange(aff_age, cog_age, nrow = 2)

### sig tests - change for each behaviorial variable of interest 

amygdala_nuclei_7T %>% 
  dplyr::select(id, visit, scan_id, scan_age, internalizing_probs_T) %>%
  drop_na(.) %>% 
  distinct() %>% 
  mgcv::gamm(internalizing_probs_T ~ s(scan_age, k = 3, fx = T), 
             random = list(id = ~1 + visit),
             data = .,
             REML = T) %>% 
  model_parameters()



```





